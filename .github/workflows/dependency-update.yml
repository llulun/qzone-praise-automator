# ä¾èµ–æ›´æ–°æ£€æŸ¥å·¥ä½œæµ
# å®šæœŸæ£€æŸ¥å’Œæ›´æ–°é¡¹ç›®ä¾èµ–

name: Dependency Update

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹è¿è¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  check-dependencies:
    name: æ£€æŸ¥ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æ£€æŸ¥ GitHub Actions ç‰ˆæœ¬
        run: |
          echo "æ£€æŸ¥ GitHub Actions ä¾èµ–ç‰ˆæœ¬..."
          
          # æ£€æŸ¥å¸¸ç”¨ Actions çš„æœ€æ–°ç‰ˆæœ¬
          ACTIONS_TO_CHECK=(
            "actions/checkout"
            "actions/setup-node"
            "actions/upload-artifact"
            "peter-evans/create-pull-request"
            "softprops/action-gh-release"
          )
          
          echo "## GitHub Actions ç‰ˆæœ¬æ£€æŸ¥" > dependency-report.md
          echo "" >> dependency-report.md
          
          for action in "${ACTIONS_TO_CHECK[@]}"; do
            echo "æ£€æŸ¥ $action..."
            
            # èŽ·å–æœ€æ–°ç‰ˆæœ¬ (ç®€åŒ–ç‰ˆæœ¬ï¼Œå®žé™…å¯èƒ½éœ€è¦ API è°ƒç”¨)
            echo "- $action: å»ºè®®æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          done

      - name: æ£€æŸ¥æµè§ˆå™¨æ‰©å±•å…¼å®¹æ€§
        run: |
          echo "" >> dependency-report.md
          echo "## æµè§ˆå™¨æ‰©å±•å…¼å®¹æ€§æ£€æŸ¥" >> dependency-report.md
          echo "" >> dependency-report.md
          
          # æ£€æŸ¥ä¸»æµæµè§ˆå™¨ç‰ˆæœ¬æ”¯æŒ
          echo "### æŽ¨èçš„æµè§ˆå™¨ç‰ˆæœ¬" >> dependency-report.md
          echo "- Chrome: æœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- Firefox: æœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- Edge: æœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- Safari: æœ€æ–°ç‰ˆæœ¬ (å¦‚æžœæ”¯æŒ Tampermonkey)" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "### ç”¨æˆ·è„šæœ¬ç®¡ç†å™¨" >> dependency-report.md
          echo "- Tampermonkey: æŽ¨èæœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- Violentmonkey: æŽ¨èæœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- Greasemonkey: æ£€æŸ¥å…¼å®¹æ€§" >> dependency-report.md

      - name: æ£€æŸ¥è„šæœ¬ API å…¼å®¹æ€§
        run: |
          echo "" >> dependency-report.md
          echo "## ç”¨æˆ·è„šæœ¬ API å…¼å®¹æ€§" >> dependency-report.md
          echo "" >> dependency-report.md
          
          # æ£€æŸ¥è„šæœ¬ä¸­ä½¿ç”¨çš„ API
          if [ -f "*.js" ]; then
            echo "### ä½¿ç”¨çš„ Tampermonkey API" >> dependency-report.md
            
            # æ£€æŸ¥å¸¸ç”¨ API
            APIS=("GM_getValue" "GM_setValue" "GM_addStyle" "GM_log" "GM_info" "GM_xmlhttpRequest")
            
            for api in "${APIS[@]}"; do
              if grep -q "$api" *.js 2>/dev/null; then
                echo "- âœ… $api: å·²ä½¿ç”¨" >> dependency-report.md
              else
                echo "- âšª $api: æœªä½¿ç”¨" >> dependency-report.md
              fi
            done
          fi

      - name: ç”Ÿæˆå®‰å…¨å»ºè®®
        run: |
          echo "" >> dependency-report.md
          echo "## å®‰å…¨å»ºè®®" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "### å®šæœŸæ£€æŸ¥é¡¹ç›®" >> dependency-report.md
          echo "- ðŸ” æ£€æŸ¥è„šæœ¬æ˜¯å¦ä½¿ç”¨äº†è¿‡æ—¶çš„ API" >> dependency-report.md
          echo "- ðŸ›¡ï¸ éªŒè¯è„šæœ¬æƒé™æ˜¯å¦æœ€å°åŒ–" >> dependency-report.md
          echo "- ðŸ“± æµ‹è¯•åœ¨ä¸åŒæµè§ˆå™¨ä¸­çš„å…¼å®¹æ€§" >> dependency-report.md
          echo "- ðŸ”„ å…³æ³¨ Tampermonkey æ›´æ–°æ—¥å¿—" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "### æŽ¨èçš„å®‰å…¨å®žè·µ" >> dependency-report.md
          echo "- é¿å…ä½¿ç”¨ \`eval()\` å’Œ \`Function()\`" >> dependency-report.md
          echo "- æœ€å°åŒ– \`@grant\` æƒé™" >> dependency-report.md
          echo "- ä½¿ç”¨ HTTPS è¿›è¡Œç½‘ç»œè¯·æ±‚" >> dependency-report.md
          echo "- å®šæœŸå®¡æŸ¥ä»£ç ä¸­çš„å¤–éƒ¨ä¾èµ–" >> dependency-report.md

      - name: æ£€æŸ¥æ–‡æ¡£æ›´æ–°éœ€æ±‚
        run: |
          echo "" >> dependency-report.md
          echo "## æ–‡æ¡£æ›´æ–°å»ºè®®" >> dependency-report.md
          echo "" >> dependency-report.md
          
          # æ£€æŸ¥æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°
          CURRENT_YEAR=$(date +%Y)
          
          if grep -q "Copyright.*$(($CURRENT_YEAR - 1))" *.md 2>/dev/null; then
            echo "- ðŸ“… æ›´æ–°ç‰ˆæƒå¹´ä»½åˆ° $CURRENT_YEAR" >> dependency-report.md
          fi
          
          if grep -q "Chrome.*[0-9][0-9]" README.md 2>/dev/null; then
            echo "- ðŸŒ æ£€æŸ¥æµè§ˆå™¨ç‰ˆæœ¬è¦æ±‚æ˜¯å¦éœ€è¦æ›´æ–°" >> dependency-report.md
          fi
          
          echo "- ðŸ“– æ£€æŸ¥å®‰è£…è¯´æ˜Žæ˜¯å¦éœ€è¦æ›´æ–°" >> dependency-report.md
          echo "- ðŸ”— éªŒè¯æ‰€æœ‰å¤–éƒ¨é“¾æŽ¥æ˜¯å¦æœ‰æ•ˆ" >> dependency-report.md

      - name: ç”Ÿæˆæ›´æ–°å»ºè®®
        run: |
          echo "" >> dependency-report.md
          echo "## æŽ¨èçš„æ›´æ–°æ“ä½œ" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "### ç«‹å³æ‰§è¡Œ" >> dependency-report.md
          echo "- [ ] æ›´æ–° GitHub Actions åˆ°æœ€æ–°ç‰ˆæœ¬" >> dependency-report.md
          echo "- [ ] æµ‹è¯•è„šæœ¬åœ¨æœ€æ–°æµè§ˆå™¨ç‰ˆæœ¬ä¸­çš„å…¼å®¹æ€§" >> dependency-report.md
          echo "- [ ] æ£€æŸ¥å¹¶æ›´æ–°æ–‡æ¡£ä¸­çš„è¿‡æ—¶ä¿¡æ¯" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "### å®šæœŸæ‰§è¡Œ" >> dependency-report.md
          echo "- [ ] æ¯æœˆæ£€æŸ¥ Tampermonkey æ›´æ–°" >> dependency-report.md
          echo "- [ ] æ¯å­£åº¦è¿›è¡Œå…¨é¢å…¼å®¹æ€§æµ‹è¯•" >> dependency-report.md
          echo "- [ ] æ¯åŠå¹´å®¡æŸ¥å®‰å…¨å®žè·µ" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "---" >> dependency-report.md
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> dependency-report.md

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»º Issue
        id: check-updates
        run: |
          # ç®€åŒ–æ£€æŸ¥ï¼šå¦‚æžœæŠ¥å‘Šæ–‡ä»¶å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºéœ€è¦æ›´æ–°
          if [ -f "dependency-report.md" ] && [ -s "dependency-report.md" ]; then
            echo "éœ€è¦åˆ›å»ºä¾èµ–æ›´æ–°æŠ¥å‘Š"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "æ— éœ€åˆ›å»ºæ›´æ–°æŠ¥å‘Š"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºä¾èµ–æ›´æ–° Issue
        if: steps.check-updates.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ“‹ ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
            
            - ç”Ÿæˆä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
            - åŒ…å«å®‰å…¨å»ºè®®å’Œæ›´æ–°å»ºè®®
            - è‡ªåŠ¨åŒ–ä¾èµ–æ£€æŸ¥ç»“æžœ
          title: 'ðŸ“‹ ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š'
          body: |
            ## ðŸ“‹ ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
            
            æ­¤ PR åŒ…å«è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Šã€‚
            
            ### ðŸ“„ æŠ¥å‘Šå†…å®¹
            - GitHub Actions ç‰ˆæœ¬æ£€æŸ¥
            - æµè§ˆå™¨æ‰©å±•å…¼å®¹æ€§æ£€æŸ¥
            - ç”¨æˆ·è„šæœ¬ API å…¼å®¹æ€§æ£€æŸ¥
            - å®‰å…¨å»ºè®®
            - æ–‡æ¡£æ›´æ–°å»ºè®®
            - æŽ¨èçš„æ›´æ–°æ“ä½œ
            
            ### ðŸ“‹ åŽç»­æ“ä½œ
            è¯·æŸ¥çœ‹ `dependency-report.md` æ–‡ä»¶ä¸­çš„è¯¦ç»†å»ºè®®ï¼Œå¹¶æ ¹æ®éœ€è¦æ‰§è¡Œç›¸åº”çš„æ›´æ–°æ“ä½œã€‚
            
            ### ðŸ” æ£€æŸ¥æ¸…å•
            - [ ] å®¡æŸ¥ä¾èµ–æ›´æ–°å»ºè®®
            - [ ] æ‰§è¡Œå¿…è¦çš„æ›´æ–°æ“ä½œ
            - [ ] æµ‹è¯•æ›´æ–°åŽçš„å…¼å®¹æ€§
            - [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
            
            ---
            
            ðŸ¤– *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          branch: dependency-update/report
          delete-branch: true
          labels: |
            ðŸ“‹ dependencies
            ðŸ” maintenance
            ðŸ¤– automated
          add-paths: |
            dependency-report.md

      - name: è¾“å‡ºç»“æžœ
        run: |
          if [ "${{ steps.check-updates.outputs.needs_update }}" == "true" ]; then
            echo "âœ… åˆ›å»ºäº†ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š"
          else
            echo "â„¹ï¸ å½“å‰ä¾èµ–çŠ¶æ€è‰¯å¥½ï¼Œæ— éœ€ç‰¹åˆ«å…³æ³¨"
          fi

  # æ£€æŸ¥å¤–éƒ¨é“¾æŽ¥æœ‰æ•ˆæ€§
  check-links:
    name: æ£€æŸ¥å¤–éƒ¨é“¾æŽ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ Markdown æ–‡ä»¶ä¸­çš„é“¾æŽ¥
        run: |
          echo "æ£€æŸ¥å¤–éƒ¨é“¾æŽ¥æœ‰æ•ˆæ€§..."
          
          # æå–æ‰€æœ‰ HTTP/HTTPS é“¾æŽ¥
          LINKS=$(grep -hoP 'https?://[^\s\)]+' *.md 2>/dev/null | sort -u)
          
          if [ -z "$LINKS" ]; then
            echo "æœªæ‰¾åˆ°å¤–éƒ¨é“¾æŽ¥"
            exit 0
          fi
          
          echo "æ‰¾åˆ°ä»¥ä¸‹å¤–éƒ¨é“¾æŽ¥ï¼š"
          echo "$LINKS"
          
          # æ£€æŸ¥é“¾æŽ¥æœ‰æ•ˆæ€§ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
          echo "" > link-check-report.md
          echo "# å¤–éƒ¨é“¾æŽ¥æ£€æŸ¥æŠ¥å‘Š" >> link-check-report.md
          echo "" >> link-check-report.md
          echo "æ£€æŸ¥æ—¶é—´: $(date)" >> link-check-report.md
          echo "" >> link-check-report.md
          
          while IFS= read -r link; do
            if [ -n "$link" ]; then
              echo "æ£€æŸ¥é“¾æŽ¥: $link"
              
              # ä½¿ç”¨ curl æ£€æŸ¥é“¾æŽ¥ï¼ˆè¶…æ—¶ 10 ç§’ï¼‰
              if curl -s --head --max-time 10 "$link" > /dev/null 2>&1; then
                echo "- âœ… $link" >> link-check-report.md
              else
                echo "- âŒ $link (å¯èƒ½æ— æ³•è®¿é—®)" >> link-check-report.md
              fi
            fi
          done <<< "$LINKS"

      - name: ä¸Šä¼ é“¾æŽ¥æ£€æŸ¥æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: link-check-report.md
          retention-days: 30