# QZone Praise Automator CI/CD Pipeline
# è‡ªåŠ¨åŒ–æµ‹è¯•ã€ä»£ç è´¨é‡æ£€æŸ¥å’Œå‘å¸ƒæµç¨‹

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

env:
  SCRIPT_NAME: "QZone Praise Automator"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            npm init -y
            npm install --save-dev eslint @eslint/js
          fi

      - name: ESLint ä»£ç æ£€æŸ¥
        run: |
          # åˆ›å»ºåŸºç¡€ ESLint é…ç½®
          cat > eslint.config.js << 'EOF'
          import js from '@eslint/js';
          
          export default [
            js.configs.recommended,
            {
              languageOptions: {
                ecmaVersion: 2022,
                sourceType: 'script',
                globals: {
                  // Tampermonkey/Greasemonkey globals
                  GM_getValue: 'readonly',
                  GM_setValue: 'readonly',
                  GM_deleteValue: 'readonly',
                  GM_listValues: 'readonly',
                  GM_addStyle: 'readonly',
                  GM_log: 'readonly',
                  GM_info: 'readonly',
                  GM_xmlhttpRequest: 'readonly',
                  unsafeWindow: 'readonly',
                  // Browser globals
                  window: 'readonly',
                  document: 'readonly',
                  console: 'readonly',
                  setTimeout: 'readonly',
                  setInterval: 'readonly',
                  clearTimeout: 'readonly',
                  clearInterval: 'readonly'
                }
              },
              rules: {
                'no-unused-vars': 'warn',
                'no-undef': 'error',
                'no-console': 'off',
                'prefer-const': 'warn'
              }
            }
          ];
          EOF
          
          # è¿è¡Œ ESLint
          npx eslint "*.js" --config eslint.config.js || echo "ESLint æ£€æŸ¥å®Œæˆï¼Œå‘ç°ä¸€äº›é—®é¢˜ä½†ä¸é˜»æ­¢æ„å»º"

      - name: æ£€æŸ¥è„šæœ¬è¯­æ³•
        run: |
          # ä½¿ç”¨ Node.js æ£€æŸ¥ JavaScript è¯­æ³•
          for file in *.js; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              node -c "$file" && echo "âœ… $file è¯­æ³•æ­£ç¡®" || echo "âŒ $file è¯­æ³•é”™è¯¯"
            fi
          done

      - name: æ£€æŸ¥æ–‡ä»¶ç¼–ç 
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸º UTF-8 ç¼–ç 
          for file in *.js *.md; do
            if [ -f "$file" ]; then
              if file "$file" | grep -q "UTF-8"; then
                echo "âœ… $file ç¼–ç æ­£ç¡® (UTF-8)"
              else
                echo "âš ï¸ $file å¯èƒ½ä¸æ˜¯ UTF-8 ç¼–ç "
              fi
            fi
          done

  # è„šæœ¬éªŒè¯
  script-validation:
    name: è„šæœ¬éªŒè¯
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ç”¨æˆ·è„šæœ¬å…ƒæ•°æ®
        run: |
          echo "éªŒè¯ç”¨æˆ·è„šæœ¬å…ƒæ•°æ®..."
          
          # æŸ¥æ‰¾ä¸»è„šæœ¬æ–‡ä»¶
          SCRIPT_FILE=$(find . -name "*.js" -type f | head -1)
          
          if [ -z "$SCRIPT_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° JavaScript è„šæœ¬æ–‡ä»¶"
            exit 1
          fi
          
          echo "æ£€æŸ¥è„šæœ¬æ–‡ä»¶: $SCRIPT_FILE"
          
          # æ£€æŸ¥å¿…éœ€çš„å…ƒæ•°æ®
          REQUIRED_HEADERS=("@name" "@version" "@description" "@author" "@match" "@grant")
          
          for header in "${REQUIRED_HEADERS[@]}"; do
            if grep -q "// $header" "$SCRIPT_FILE"; then
              echo "âœ… æ‰¾åˆ° $header"
            else
              echo "âŒ ç¼ºå°‘ $header"
              exit 1
            fi
          done
          
          # æå–ç‰ˆæœ¬å·
          VERSION=$(grep "// @version" "$SCRIPT_FILE" | head -1 | sed 's/.*@version[[:space:]]*//')
          echo "è„šæœ¬ç‰ˆæœ¬: $VERSION"
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (è¯­ä¹‰åŒ–ç‰ˆæœ¬)
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ… ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®"
          else
            echo "âš ï¸ ç‰ˆæœ¬å·æ ¼å¼å¯èƒ½ä¸ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ"
          fi

      - name: æ£€æŸ¥è„šæœ¬å¤§å°
        run: |
          for file in *.js; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              size_kb=$((size / 1024))
              echo "è„šæœ¬å¤§å°: $file = ${size_kb}KB"
              
              if [ $size_kb -gt 500 ]; then
                echo "âš ï¸ è„šæœ¬æ–‡ä»¶è¾ƒå¤§ (>${size_kb}KB)ï¼Œå»ºè®®ä¼˜åŒ–"
              else
                echo "âœ… è„šæœ¬å¤§å°åˆç†"
              fi
            fi
          done

  # æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¿…éœ€æ–‡æ¡£
        run: |
          echo "æ£€æŸ¥é¡¹ç›®æ–‡æ¡£..."
          
          REQUIRED_DOCS=("README.md" "CHANGELOG.md" "CONTRIBUTING.md" "LICENSE")
          
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… æ‰¾åˆ° $doc"
            else
              echo "âŒ ç¼ºå°‘ $doc"
              exit 1
            fi
          done

      - name: æ£€æŸ¥ README å†…å®¹
        run: |
          echo "æ£€æŸ¥ README.md å†…å®¹..."
          
          REQUIRED_SECTIONS=("å®‰è£…" "ä½¿ç”¨" "åŠŸèƒ½" "æ›´æ–°æ—¥å¿—")
          
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if grep -qi "$section" README.md; then
              echo "âœ… README åŒ…å« $section éƒ¨åˆ†"
            else
              echo "âš ï¸ README å¯èƒ½ç¼ºå°‘ $section éƒ¨åˆ†"
            fi
          done

      - name: æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§
        run: |
          echo "æ£€æŸ¥ Markdown æ–‡ä»¶ä¸­çš„é“¾æ¥..."
          
          # æå–æ‰€æœ‰ markdown é“¾æ¥
          for file in *.md; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              
              # æ£€æŸ¥ç›¸å¯¹è·¯å¾„é“¾æ¥
              grep -oP '\[.*?\]\(\./.*?\)' "$file" | while read -r link; do
                path=$(echo "$link" | sed 's/.*(\.\///' | sed 's/).*//')
                if [ -f "$path" ] || [ -d "$path" ]; then
                  echo "âœ… é“¾æ¥æœ‰æ•ˆ: $path"
                else
                  echo "âŒ é“¾æ¥æ— æ•ˆ: $path"
                fi
              done
            fi
          done

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        run: |
          echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
          
          # æ£€æŸ¥å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯
          SENSITIVE_PATTERNS=("password" "token" "secret" "key" "api_key")
          
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if grep -ri "$pattern" . --exclude-dir=.git --exclude="*.md" --exclude="*.yml"; then
              echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯: $pattern"
            else
              echo "âœ… æœªå‘ç° $pattern ç›¸å…³æ•æ„Ÿä¿¡æ¯"
            fi
          done

      - name: æ£€æŸ¥æ¶æ„ä»£ç æ¨¡å¼
        run: |
          echo "æ£€æŸ¥æ½œåœ¨æ¶æ„ä»£ç æ¨¡å¼..."
          
          # æ£€æŸ¥å¯èƒ½çš„æ¶æ„æ¨¡å¼
          MALICIOUS_PATTERNS=("eval(" "Function(" "document.write" "innerHTML.*<script")
          
          for pattern in "${MALICIOUS_PATTERNS[@]}"; do
            if grep -r "$pattern" *.js 2>/dev/null; then
              echo "âš ï¸ å‘ç°æ½œåœ¨é£é™©æ¨¡å¼: $pattern"
            else
              echo "âœ… æœªå‘ç° $pattern é£é™©æ¨¡å¼"
            fi
          done

  # å‘å¸ƒå¤„ç†
  release-assets:
    name: å‘å¸ƒèµ„æºå¤„ç†
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [code-quality, script-validation, documentation-check, security-check]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å‡†å¤‡å‘å¸ƒèµ„æº
        run: |
          echo "å‡†å¤‡å‘å¸ƒèµ„æº..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          
          # å¤åˆ¶ä¸»è¦æ–‡ä»¶
          cp *.js release/ 2>/dev/null || echo "æœªæ‰¾åˆ° JS æ–‡ä»¶"
          cp README.md release/ 2>/dev/null || echo "æœªæ‰¾åˆ° README"
          cp CHANGELOG.md release/ 2>/dev/null || echo "æœªæ‰¾åˆ° CHANGELOG"
          cp LICENSE release/ 2>/dev/null || echo "æœªæ‰¾åˆ° LICENSE"
          
          # åˆ›å»ºå®‰è£…è¯´æ˜
          cat > release/INSTALL.md << 'EOF'
          # å®‰è£…è¯´æ˜
          
          ## å¿«é€Ÿå®‰è£…
          
          1. å®‰è£…æµè§ˆå™¨æ‰©å±•ï¼š
             - [Tampermonkey (Chrome)](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
             - [Tampermonkey (Firefox)](https://addons.mozilla.org/en-US/firefox/addon/tampermonkey/)
             - [Tampermonkey (Edge)](https://microsoftedge.microsoft.com/addons/detail/tampermonkey/iikmkjmpaadaobahmlepeloendndfphd)
          
          2. ç‚¹å‡»ä¸‹è½½è„šæœ¬æ–‡ä»¶ (.js)
          
          3. åœ¨ Tampermonkey ä¸­å®‰è£…è„šæœ¬
          
          4. è®¿é—® QQ ç©ºé—´å¼€å§‹ä½¿ç”¨
          
          ## è¯¦ç»†è¯´æ˜
          
          æŸ¥çœ‹ README.md è·å–å®Œæ•´çš„å®‰è£…å’Œä½¿ç”¨è¯´æ˜ã€‚
          EOF
          
          echo "å‘å¸ƒèµ„æºå‡†å¤‡å®Œæˆ"
          ls -la release/

      - name: ä¸Šä¼ å‘å¸ƒèµ„æº
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: release/
          retention-days: 90

      - name: æ·»åŠ èµ„æºåˆ° Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            *.js
            README.md
            CHANGELOG.md
            LICENSE
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            1. å®‰è£… [Tampermonkey](https://www.tampermonkey.net/)
            2. ä¸‹è½½ä¸‹æ–¹çš„ `.js` æ–‡ä»¶
            3. åœ¨ Tampermonkey ä¸­å®‰è£…è„šæœ¬
            4. è®¿é—® QQ ç©ºé—´å³å¯ä½¿ç”¨
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            æŸ¥çœ‹ [CHANGELOG.md](./CHANGELOG.md) è·å–è¯¦ç»†æ›´æ–°ä¿¡æ¯ã€‚
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [ä½¿ç”¨æ–‡æ¡£](./README.md)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
            - [è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥
  notification:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, script-validation, documentation-check, security-check]
    steps:
      - name: æ„å»ºçŠ¶æ€é€šçŸ¥
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.script-validation.result }}" == "success" ] && \
             [ "${{ needs.documentation-check.result }}" == "success" ] && \
             [ "${{ needs.security-check.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥"
            echo "ä»£ç è´¨é‡: ${{ needs.code-quality.result }}"
            echo "è„šæœ¬éªŒè¯: ${{ needs.script-validation.result }}"
            echo "æ–‡æ¡£æ£€æŸ¥: ${{ needs.documentation-check.result }}"
            echo "å®‰å…¨æ£€æŸ¥: ${{ needs.security-check.result }}"
          fi
