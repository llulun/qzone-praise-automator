# è‡ªåŠ¨ä»£ç æ ¼å¼åŒ–å’Œä¿®å¤å·¥ä½œæµ
# è‡ªåŠ¨ä¿®å¤ä»£ç æ ¼å¼é—®é¢˜å¹¶åˆ›å»º PR

name: Auto Fix & Format

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: è‡ªåŠ¨ä¿®å¤å’Œæ ¼å¼åŒ–
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…å·¥å…·
        run: |
          npm init -y
          npm install --save-dev prettier eslint @eslint/js

      - name: åˆ›å»º Prettier é…ç½®
        run: |
          cat > .prettierrc << 'EOF'
          {
            "semi": true,
            "trailingComma": "es5",
            "singleQuote": true,
            "printWidth": 80,
            "tabWidth": 2,
            "useTabs": false,
            "endOfLine": "lf"
          }
          EOF

      - name: åˆ›å»º Prettier å¿½ç•¥æ–‡ä»¶
        run: |
          cat > .prettierignore << 'EOF'
          node_modules/
          .git/
          *.min.js
          *.bundle.js
          EOF

      - name: æ ¼å¼åŒ– JavaScript æ–‡ä»¶
        run: |
          # æ ¼å¼åŒ– JS æ–‡ä»¶
          npx prettier --write "*.js" || echo "Prettier æ ¼å¼åŒ–å®Œæˆ"

      - name: æ ¼å¼åŒ– Markdown æ–‡ä»¶
        run: |
          # æ ¼å¼åŒ– Markdown æ–‡ä»¶
          npx prettier --write "*.md" || echo "Markdown æ ¼å¼åŒ–å®Œæˆ"

      - name: ä¿®å¤è¡Œå°¾ç¬¦
        run: |
          # ç»Ÿä¸€è¡Œå°¾ç¬¦ä¸º LF
          find . -name "*.js" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" | \
          while read file; do
            if [ -f "$file" ]; then
              # è½¬æ¢ä¸º Unix è¡Œå°¾ç¬¦
              sed -i 's/\r$//' "$file"
              echo "ä¿®å¤è¡Œå°¾ç¬¦: $file"
            fi
          done

      - name: ä¿®å¤æ–‡ä»¶ç¼–ç 
        run: |
          # ç¡®ä¿æ–‡ä»¶ä¸º UTF-8 ç¼–ç 
          for file in *.js *.md; do
            if [ -f "$file" ]; then
              # æ£€æŸ¥å¹¶è½¬æ¢ç¼–ç 
              if ! file "$file" | grep -q "UTF-8"; then
                echo "è½¬æ¢ç¼–ç : $file"
                iconv -f ISO-8859-1 -t UTF-8 "$file" > "${file}.tmp" && mv "${file}.tmp" "$file" || echo "ç¼–ç è½¬æ¢å¤±è´¥: $file"
              fi
            fi
          done

      - name: æ¸…ç†ç©ºç™½å­—ç¬¦
        run: |
          # ç§»é™¤è¡Œå°¾ç©ºç™½å­—ç¬¦
          for file in *.js *.md *.yml *.yaml; do
            if [ -f "$file" ]; then
              sed -i 's/[[:space:]]*$//' "$file"
              echo "æ¸…ç†ç©ºç™½å­—ç¬¦: $file"
            fi
          done

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–‡ä»¶æ›´æ”¹"
          fi

      - name: åˆ›å»º Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ¤– è‡ªåŠ¨ä»£ç æ ¼å¼åŒ–å’Œä¿®å¤
            
            - ä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç 
            - ç»Ÿä¸€è¡Œå°¾ç¬¦ä¸º LF
            - ç¡®ä¿ UTF-8 ç¼–ç 
            - æ¸…ç†è¡Œå°¾ç©ºç™½å­—ç¬¦
          title: 'ğŸ¤– è‡ªåŠ¨ä»£ç æ ¼å¼åŒ–å’Œä¿®å¤'
          body: |
            ## ğŸ¤– è‡ªåŠ¨ä»£ç æ ¼å¼åŒ–å’Œä¿®å¤
            
            æ­¤ PR ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹ä¿®å¤ï¼š
            
            ### âœ¨ ä¿®å¤å†…å®¹
            - ğŸ“ ä½¿ç”¨ Prettier æ ¼å¼åŒ– JavaScript å’Œ Markdown æ–‡ä»¶
            - ğŸ”„ ç»Ÿä¸€è¡Œå°¾ç¬¦ä¸º LF (Unix æ ¼å¼)
            - ğŸ”¤ ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ UTF-8 ç¼–ç 
            - ğŸ§¹ æ¸…ç†è¡Œå°¾ç©ºç™½å­—ç¬¦
            
            ### ğŸ” æ£€æŸ¥æ¸…å•
            - [ ] ä»£ç æ ¼å¼åŒ–æ­£ç¡®
            - [ ] æ–‡ä»¶ç¼–ç æ­£ç¡®
            - [ ] è¡Œå°¾ç¬¦ç»Ÿä¸€
            - [ ] æ— å¤šä½™ç©ºç™½å­—ç¬¦
            
            ### ğŸ“‹ æ³¨æ„äº‹é¡¹
            - æ­¤ PR ä»…åŒ…å«æ ¼å¼åŒ–ä¿®å¤ï¼Œä¸æ¶‰åŠåŠŸèƒ½æ›´æ”¹
            - å»ºè®®åœ¨åˆå¹¶å‰è¿›è¡Œä»£ç å®¡æŸ¥
            - åˆå¹¶åå»ºè®®è¿è¡Œå®Œæ•´æµ‹è¯•
            
            ---
            
            ğŸ¤– *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          branch: auto-fix/code-formatting
          delete-branch: true
          labels: |
            ğŸ¤– automated
            ğŸ“ formatting
            ğŸ”§ maintenance

      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "âœ… åˆ›å»ºäº†è‡ªåŠ¨ä¿®å¤ PR"
          else
            echo "â„¹ï¸ ä»£ç å·²ç»æ˜¯æœ€æ–°æ ¼å¼ï¼Œæ— éœ€ä¿®å¤"
          fi