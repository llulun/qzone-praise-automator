// ==UserScript==
// @name         QZone Praise Automator
// @namespace    https://github.com/llulun/qzone-autopraise-pro
// @license      MIT
// @version      2.8.2
// @description  ç½‘é¡µç‰ˆQQç©ºé—´è‡ªåŠ¨ç‚¹èµå·¥å…·ï¼ˆå¢å¼ºç‰ˆï¼šç®€åŒ–å·¥ä½œæµï¼Œé€šè¿‡æ£€æµ‹ç‚¹èµå…ƒç´ åˆ¤æ–­æ˜¯å¦åœ¨å¥½å‹åŠ¨æ€é¡µé¢ï¼Œæœ‰åˆ™ç›´æ¥æ‰§è¡Œç‚¹èµï¼Œæ— åˆ™åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€ååˆ·æ–°é¡µé¢é‡èµ°æµç¨‹ï¼Œç§»é™¤èœå•å…ƒç´ ï¼Œæ·»åŠ å»¶è¿Ÿå¤„ç†ã€å®‰å…¨ç‚¹èµã€èœå•è°ƒæ•´ã€çŠ¶æ€æ ç¾åŒ–ã€æ»šåŠ¨æ¨¡æ‹Ÿç­‰åŠŸèƒ½ã€‚æ›´æ–°ï¼šçŠ¶æ€æ æ›´è¯¦ç»†æ˜¾ç¤ºä»»åŠ¡è¿›åº¦ã€å‰©ä½™æ—¶é—´ç­‰ï¼Œç¾åŒ–é€æ˜åº¦ä¸é˜´å½±ï¼›æ§åˆ¶é¢æ¿å¢å¤§ã€å±…ä¸­ã€é€æ˜åŒ–ï¼›ä¿®å¤çŠ¶æ€æ æ–‡å­—æ¨¡ç³Šä¸é‡å é—®é¢˜ï¼Œé€šè¿‡åˆ†è¡Œæ˜¾ç¤ºã€è°ƒæ•´å­—ä½“ä¸è¡Œé«˜ç¡®ä¿æ¸…æ™°ï¼›çŠ¶æ€æ èƒŒæ™¯æ”¹ä¸ºé»‘è‰²æ¸å˜ï¼Œæ·»åŠ é€æ˜é˜´å½±ä¸åº•éƒ¨åœ†è§’ï¼›æ‰©å±•æ§åˆ¶é¢æ¿ä¸ºå·¦ä¾§èœå•æ å¼ç»“æ„ï¼Œæ·»åŠ æ›´å¤šå‚æ•°è°ƒæ•´å¦‚çŠ¶æ€æ /æ§åˆ¶é¢æ¿é€æ˜åº¦ã€é¢œè‰²ã€å±è”½ç”¨æˆ·ã€è¿‡æ»¤é€‰é¡¹ã€é‡è¯•æ¬¡æ•°ã€æ»šåŠ¨æ­¥é•¿ã€åˆå§‹å»¶è¿Ÿç­‰ï¼Œæ‰€æœ‰å¯è°ƒå‚æ•°å‡é›†æˆåˆ°é¢æ¿ä¸­ï¼Œæ”¯æŒåŠ¨æ€åº”ç”¨å˜åŒ–ï¼›ç§»é™¤åŒå‡»é¡µé¢è°ƒç”¨setConfigäº‹ä»¶ï¼Œæ‰€æœ‰è®¾ç½®ç»Ÿä¸€é€šè¿‡æ§åˆ¶é¢æ¿ï¼›æ§åˆ¶é¢æ¿é»˜è®¤éšè—ï¼Œé€šè¿‡ç‚¹å‡»æµ®åŠ¨æŒ‰é’®æ‰“å¼€ï¼›ä¿®å¤çŠ¶æ€æ æ–‡å­—éšèƒŒæ™¯é€æ˜é—®é¢˜ï¼Œæ·»åŠ æ–‡å­—é¢œè‰²ä¸äº®åº¦è®¾ç½®ï¼›æ–°å¢ï¼šæš‚åœ/æ¢å¤åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æš‚åœæˆ–æ¢å¤è‡ªåŠ¨ç‚¹èµæµç¨‹ï¼ŒçŠ¶æ€æ æ˜¾ç¤ºæš‚åœçŠ¶æ€ï¼›ä¿®å¤ï¼šçŠ¶æ€æ ç¬¬äºŒè¡Œå‚æ•°ä¸ç­‰å¾…æ—¶é—´æ˜¾ç¤ºé”™è¯¯ï¼Œç¡®ä¿å®æ—¶åŒæ­¥æœ€æ–°å‚æ•°å’Œæ­£ç¡®æ—¶é—´ï¼›ä¼˜åŒ–ï¼šä¿®å¤çŠ¶æ€æ å¤šä½™åˆ†éš”ç¬¦é€»è¾‘ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸ï¼›å…¼å®¹ï¼šå°†æ¨¡æ¿å­—ç¬¦ä¸²æ”¹ä¸ºå­—ç¬¦ä¸²è¿æ¥ï¼Œæé«˜æ—§æµè§ˆå™¨å…¼å®¹æ€§ï¼Œé¿å…æ½œåœ¨è¯­æ³•æŠ¥é”™ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.4ï¼‰ï¼šç¾åŒ–æ§åˆ¶é¢æ¿å’ŒçŠ¶æ€æ çš„UIï¼ˆæ·»åŠ è¿‡æ¸¡åŠ¨ç”»ã€åœ†è§’æŒ‰é’®ã€å“åº”å¼å¸ƒå±€ï¼‰ï¼›ä¿®å¤æ½œåœ¨bugå¦‚æ»šåŠ¨äº‹ä»¶é‡å¤è§¦å‘ç‚¹èµã€æš‚åœæ—¶å®šæ—¶å™¨æœªå®Œå…¨æ¸…ç†ã€cookieå€¼è§£æè¾¹ç¼˜æ¡ˆä¾‹ï¼›ä¼˜åŒ–æ€§èƒ½ï¼ˆå‡å°‘ä¸å¿…è¦çš„setIntervalè°ƒç”¨ã€æ‰¹é‡DOMæ“ä½œï¼‰ï¼›æ·»åŠ æš—é»‘æ¨¡å¼è‡ªåŠ¨é€‚é…é€‰é¡¹ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.5ï¼‰ï¼šä¿®å¤bugï¼šåœ¨ç‚¹èµæˆ–æ»šåŠ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»åŠ¡æ—¶é—´è¶…è¿‡åˆ·æ–°é—´éš”ï¼Œå¯¼è‡´å€’è®¡æ—¶é‡ç½®çš„é—®é¢˜ï¼ˆé€šè¿‡åœ¨ä»»åŠ¡å¼€å§‹æ—¶æ¨è¿ŸnextTimeæ¥é¿å…ä¸­æ–­ï¼‰ï¼›ç¾åŒ–çŠ¶æ€æ ï¼šæ·»åŠ è¿›åº¦æ¡è¡¨ç¤ºå½“å‰ä»»åŠ¡è¿›åº¦ã€ä½¿ç”¨emojiå›¾æ ‡å¢å¼ºè§†è§‰åé¦ˆã€ä¼˜åŒ–å­—ä½“å’Œé—´è·ä»¥æé«˜å¯è¯»æ€§ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.6ï¼‰ï¼šä¿®å¤çŠ¶æ€æ é€»è¾‘é—®é¢˜ï¼šé˜²æ­¢safeLikeé‡å¤è°ƒç”¨å¯¼è‡´nextTimeå¤šæ¬¡æ¨è¿Ÿå’Œå€’è®¡æ—¶è·³åŠ¨ï¼›ä¼˜åŒ–ç‚¹èµé€»è¾‘ï¼Œä»…è°ƒåº¦å®é™…éœ€è¦ç‚¹èµçš„åŠ¨æ€ï¼Œé¿å…ä¸å¿…è¦å»¶è¿Ÿå’Œå¡åœ¨â€œè·³è¿‡â€æ­¥éª¤ï¼›å¦‚æœæ‰€æœ‰åŠ¨æ€è¢«è·³è¿‡ï¼Œç«‹å³å®Œæˆä»»åŠ¡å¹¶æ›´æ–°çŠ¶æ€æ ä¸ºç­‰å¾…åˆ·æ–°ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ— è°“æ—¶é—´æˆ–æ˜¾ç¤ºè·³è¿‡æ¶ˆæ¯ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.8ï¼‰ï¼šUIç¾åŒ–å‡çº§ï¼ˆä¸»é¢˜ç³»ç»Ÿã€å“åº”å¼è®¾è®¡ã€å¾®äº¤äº’ï¼‰ï¼›æ–°å¢åŠ¨æ€å…³é”®è¯è¿‡æ»¤ï¼ˆå±è”½/å…è®¸æ¨¡å¼ï¼Œæ”¯æŒæ­£åˆ™ï¼‰ï¼›é»‘åå•æ‰©å±•ï¼ˆåˆ†ç»„ã€ç™½åå•ã€å¯¼å…¥/å¯¼å‡ºï¼‰ï¼›æ¯æ—¥ç‚¹èµä¸Šé™ï¼›æµè§ˆå™¨é€šçŸ¥ï¼›æ€§èƒ½ç›‘æ§ï¼ˆç‚¹èµæˆåŠŸç‡ç»Ÿè®¡ï¼‰ï¼›å¤šè´¦å·æ”¯æŒï¼ˆé…ç½®åˆ‡æ¢ï¼‰ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.8.1ï¼‰ï¼šä¿®å¤åŠ¨æ€å…ƒç´ äº‹ä»¶ç›‘å¬å™¨æ·»åŠ é—®é¢˜ï¼Œç¡®ä¿åœ¨tabå†…å®¹åŠ è½½åç»‘å®šäº‹ä»¶ï¼Œé¿å…nullé”™è¯¯ï¼›ä¼˜åŒ–JSONè§£æé”™è¯¯å¤„ç†ï¼›ç¡®ä¿æ‰€æœ‰å­—ç¬¦ä¸²è¿æ¥æ­£ç¡®ï¼Œé¿å…è¯­æ³•é—®é¢˜ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.8.2ï¼‰ï¼šä¿®å¤å…³é”®è¯å±è”½ä¸ç”Ÿæ•ˆé—®é¢˜ï¼Œå°†å†…å®¹æå–æ”¹ä¸ºinnerTextä»¥é¿å…HTMLæ ‡ç­¾å¹²æ‰°åŒ¹é…ï¼›åŠ å¼ºå·²èµåŠ¨æ€æ£€æµ‹ï¼Œæ·»åŠ ç‚¹èµåå»¶è¿Ÿæ£€æŸ¥classæ›´æ–°ï¼Œé˜²æ­¢æ‰‹åŠ¨æ»šåŠ¨è§¦å‘é‡å¤ç‚¹èµå¯¼è‡´å–æ¶ˆï¼›ä¼˜åŒ–æ—¥å¿—è®°å½•å…³é”®è¯åŒ¹é…ç»†èŠ‚ã€‚ï¼‰
// @author       llulun (with contributions)
// @match        *://*.qzone.qq.com/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        unsafeWindow
// @grant        GM_notification
// ==/UserScript==

(function() {
    'use strict';

    // ä»cookieè·å–é…ç½®ï¼ˆæ‰©å±•ï¼šæ·»åŠ æ–°å‚æ•°ï¼Œå¦‚å…³é”®è¯ã€æ¨¡å¼ã€ç™½åå•ã€åˆ†ç»„ã€æ¯æ—¥ä¸Šé™ç­‰ï¼‰
    let duration = parseInt(getCookie('al-duration')) || 180;
    let refreshDelay = parseInt(getCookie('al-refreshDelay')) || 10;
    let likeDelay = parseInt(getCookie('al-likeDelay')) || 5;
    let scrollCount = parseInt(getCookie('al-scrollCount')) || 3;
    let blocked = getCookie('al-blocked') ? getCookie('al-blocked').split(',') : [];
    let whiteList = getCookie('al-whiteList') ? getCookie('al-whiteList').split(',') : [];
    let blockGroups = safeJsonParse(getCookie('al-blockGroups')) || {}; // ä½¿ç”¨å®‰å…¨è§£æ
    let filterKeywords = getCookie('al-filterKeywords') ? getCookie('al-filterKeywords').split(',') : [];
    let filterMode = getCookie('al-filterMode') || 'block'; // 'block' or 'allow'
    let dailyLimit = parseInt(getCookie('al-dailyLimit')) || 0; // 0 means unlimited
    let dailyCount = parseInt(getCookie('al-dailyCount')) || 0;
    let lastDailyReset = parseInt(getCookie('al-lastDailyReset')) || Date.now();
    const dict = ['ç‚¹èµ', 'è½¬å‘', 'è¯„è®º'];
    let select = Boolean(getCookie('al-select'));
    let lastRefresh = parseInt(getCookie('al-lastRefresh')) || 0;
    let nextTime = Math.max(Date.now(), lastRefresh + duration * 1000);
    let isScrolling = false;
    let timeout = null;
    let isRunning = false;
    let isPaused = false;
    let testMode = false;
    let uin = unsafeWindow.g_iUin || unsafeWindow.g_iLoginUin || '';
    let retryCount = 0;
    let maxRetries = parseInt(getCookie('al-maxRetries')) || 3;
    let currentTask = '';
    let taskStartTime = 0;
    let taskDuration = 0;
    let nextTask = '';
    let statusOpacity = parseFloat(getCookie('al-statusOpacity')) || 0.8;
    let statusBgColor = getCookie('al-statusBgColor') || 'linear-gradient(to right, #333, #222)';
    let menuOpacity = parseFloat(getCookie('al-menuOpacity')) || 0.9;
    let menuBgColor = getCookie('al-menuBgColor') || 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
    let scrollStepPercent = parseFloat(getCookie('al-scrollStepPercent')) || 0.9;
    let initialDelay = parseInt(getCookie('al-initialDelay')) || 3000;
    let statusTextColor = getCookie('al-statusTextColor') || (statusBgColor.includes('#333') || statusBgColor.includes('#222') ? '#ddd' : '#333');
    let statusTextBrightness = parseFloat(getCookie('al-statusTextBrightness')) || 1.0;
    let darkModeAuto = Boolean(getCookie('al-darkModeAuto'));
    let logLevel = getCookie('al-logLevel') || 'INFO';
    let logs = [];
    let theme = getCookie('al-theme') || 'default'; // æ–°å¢ï¼šä¸»é¢˜
    let randomDelayMin = parseInt(getCookie('al-randomDelayMin')) || 1; // æ–°å¢ï¼šéšæœºå»¶è¿Ÿ
    let randomDelayMax = parseInt(getCookie('al-randomDelayMax')) || 3;
    let enableNotifications = Boolean(getCookie('al-enableNotifications')); // æ–°å¢ï¼šé€šçŸ¥
    let stats = safeJsonParse(getCookie('al-stats')) || { likes: 0, skips: 0, errors: 0 }; // æ–°å¢ï¼šæ€§èƒ½ç›‘æ§
    let accounts = safeJsonParse(getCookie('al-accounts')) || {}; // æ–°å¢ï¼šå¤šè´¦å·
    let currentAccount = uin; // å½“å‰è´¦å·

    // æ–°å¢ï¼šå®‰å…¨JSONè§£æ
    function safeJsonParse(str) {
        try {
            return JSON.parse(str);
        } catch (e) {
            log('WARN', 'JSONè§£æå¤±è´¥: ' + e.message + ', è¿”å›é»˜è®¤å€¼');
            return null;
        }
    }

    // Cookie æ“ä½œå‡½æ•°
    function getCookie(name) {
        let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    function setCookie(name, value, maxAge) {
        let expires = "";
        if (maxAge) {
            let date = new Date();
            date.setTime(date.getTime() + maxAge * 1000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // æ—¥å¿—å‡½æ•°
    function log(level, message) {
        try {
            if (!shouldLog(level)) return;
            let now = new Date();
            let timestamp = now.getFullYear() + '-' +
                            ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                            ('0' + now.getDate()).slice(-2) + ' ' +
                            ('0' + now.getHours()).slice(-2) + ':' +
                            ('0' + now.getMinutes()).slice(-2) + ':' +
                            ('0' + now.getSeconds()).slice(-2);
            let fullMessage = '[' + timestamp + '] [' + level + '] ' + message;
            let consoleMethod = console.log;
            if (level === 'WARN') consoleMethod = console.warn;
            if (level === 'ERROR') consoleMethod = console.error;
            consoleMethod(fullMessage);

            logs.push(fullMessage);
            if (logs.length > 500) {
                logs.shift();
            }
        } catch (e) {}
    }

    function shouldLog(level) {
        const levels = { 'INFO': 0, 'WARN': 1, 'ERROR': 2 };
        return levels[logLevel] <= levels[level];
    }

    // é‡ç½®æ¯æ—¥è®¡æ•°
    function resetDailyCount() {
        let today = new Date().setHours(0,0,0,0);
        if (lastDailyReset < today) {
            dailyCount = 0;
            lastDailyReset = today;
            setCookie('al-dailyCount', dailyCount, Number.MAX_SAFE_INTEGER);
            setCookie('al-lastDailyReset', lastDailyReset, Number.MAX_SAFE_INTEGER);
        }
    }

    // å‘é€é€šçŸ¥
    function sendNotification(title, body) {
        if (enableNotifications && 'Notification' in window && Notification.permission === 'granted') {
            new Notification(title, { body: body });
        } else if (enableNotifications && 'Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission().then(function(perm) {
                if (perm === 'granted') {
                    new Notification(title, { body: body });
                }
            });
        }
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats(key) {
        stats[key] = (stats[key] || 0) + 1;
        setCookie('al-stats', JSON.stringify(stats), Number.MAX_SAFE_INTEGER);
    }

    // åˆ›å»ºèœå•æ ï¼ˆæ”¹è¿›ï¼šå“åº”å¼ã€ä¸»é¢˜ã€å›¾æ ‡ã€æ–°Tabã€è¾“å…¥å‡çº§ï¼‰
    function createMenu() {
        let menu = document.createElement('div');
        menu.id = 'al-menu';
        menu.style.position = 'fixed';
        menu.style.top = '50%';
        menu.style.left = '50%';
        menu.style.transform = 'translate(-50%, -50%)';
        menu.style.width = '80%';
        menu.style.maxWidth = '800px';
        menu.style.height = 'auto';
        menu.style.maxHeight = '80vh';
        menu.style.overflow = 'auto';
        menu.style.background = menuBgColor;
        menu.style.border = '1px solid #ccc';
        menu.style.borderRadius = '12px';
        menu.style.padding = '20px';
        menu.style.zIndex = '10002';
        menu.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
        menu.style.fontFamily = "Arial, sans-serif"; // ç§»é™¤Robotoï¼Œé¿å…å­—ä½“é—®é¢˜
        menu.style.opacity = menuOpacity;
        menu.style.display = 'none';
        menu.style.pointerEvents = 'auto';
        menu.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        // å“åº”å¼
        if (window.innerWidth < 600) {
            menu.style.width = '95%';
            menu.style.padding = '10px';
        }

        let sidebar = document.createElement('div');
        sidebar.style.width = '150px';
        sidebar.style.borderRight = '1px solid #ddd';
        sidebar.style.paddingRight = '10px';
        sidebar.innerHTML = '<h4 style="margin: 0 0 10px;">è®¾ç½®åˆ†ç±»</h4><ul style="list-style: none; padding: 0;"><li><button id="al-tab-core" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">æ ¸å¿ƒå‚æ•°</button></li><li><button id="al-tab-ui" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">ç•Œé¢è‡ªå®šä¹‰</button></li><li><button id="al-tab-filter" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">è¿‡æ»¤è§„åˆ™</button></li><li><button id="al-tab-adv" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">é«˜çº§å‚æ•°</button></li><li><button id="al-tab-logs" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">æŸ¥çœ‹æ—¥å¿—</button></li><li><button id="al-tab-stats" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">æ€§èƒ½ç»Ÿè®¡</button></li><li><button id="al-tab-accounts" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">è´¦å·ç®¡ç†</button></li></ul>';
        menu.appendChild(sidebar);

        let content = document.createElement('div');
        content.id = 'al-content';
        content.style.flex = '1';
        content.style.paddingLeft = '20px';
        content.style.transition = 'opacity 0.3s ease';
        menu.appendChild(content);

        let footer = document.createElement('div');
        footer.style.marginTop = '20px';
        footer.style.textAlign = 'center';
        footer.innerHTML = '<button id="al-save" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">ä¿å­˜å¹¶åº”ç”¨</button><button id="al-pause" style="background: #FF9800; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">' + (isPaused ? 'æ¢å¤' : 'æš‚åœ') + '</button><button id="al-test" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">æµ‹è¯•æ‰§è¡Œ</button><button id="al-reset" style="background: #9E9E9E; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">é‡ç½®é»˜è®¤</button><button id="al-export" style="background: #673AB7; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">å¯¼å‡ºé…ç½®</button><button id="al-close" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: background 0.2s;">å…³é—­</button>';
        menu.appendChild(footer);

        document.body.appendChild(menu);

        function showTab(tab) {
            content.style.opacity = '0';
            setTimeout(function() {
                content.innerHTML = '';
                if (tab === 'core') {
                    content.innerHTML = '<h3>æ ¸å¿ƒå‚æ•°</h3><div class="al-card"><label>åˆ·æ–°é¢‘ç‡ (ç§’): <input type="number" id="al-dur" value="' + duration + '" min="30" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>åˆ·æ–°å»¶è¿Ÿ (ç§’): <input type="number" id="al-rdelay" value="' + refreshDelay + '" min="5" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>ç‚¹èµå»¶è¿Ÿ (ç§’): <input type="number" id="al-ldelay" value="' + likeDelay + '" min="3" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>ä¸‹æ»‘åŠ¨æ€æ•°: <input type="number" id="al-scount" value="' + scrollCount + '" min="1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>æ¯æ—¥ç‚¹èµä¸Šé™ (0æ— é™): <input type="number" id="al-dailyLimit" value="' + dailyLimit + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label><input type="checkbox" id="al-select" ' + (select ? 'checked' : '') + '> ä¸ç‚¹èµæ¸¸æˆè½¬å‘å†…å®¹</label></div>';
                } else if (tab === 'ui') {
                    content.innerHTML = '<h3>ç•Œé¢è‡ªå®šä¹‰</h3><div class="al-card"><label>ä¸»é¢˜: <select id="al-theme"><option value="default" ' + (theme === 'default' ? 'selected' : '') + '>é»˜è®¤</option><option value="tech" ' + (theme === 'tech' ? 'selected' : '') + '>ç§‘æŠ€è“</option><option value="eco" ' + (theme === 'eco' ? 'selected' : '') + '>ç¯ä¿ç»¿</option></select></label></div><div class="al-card"><label>çŠ¶æ€æ é€æ˜åº¦ (0.1-1): <input type="number" id="al-statusOpacity" value="' + statusOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>çŠ¶æ€æ èƒŒæ™¯: <select id="al-statusBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to right, #333, #222)" ' + (statusBgColor === 'linear-gradient(to right, #333, #222)' ? 'selected' : '') + '>é»‘è‰²æ¸å˜</option><option value="linear-gradient(to right, #f0f0f0, #e0e0e0)" ' + (statusBgColor === 'linear-gradient(to right, #f0f0f0, #e0e0e0)' ? 'selected' : '') + '>ç™½è‰²æ¸å˜</option><option value="linear-gradient(to right, #2196F3, #1976D2)" ' + (statusBgColor === 'linear-gradient(to right, #2196F3, #1976D2)' ? 'selected' : '') + '>è“è‰²æ¸å˜</option><option value="linear-gradient(to right, #4CAF50, #388E3C)" ' + (statusBgColor === 'linear-gradient(to right, #4CAF50, #388E3C)' ? 'selected' : '') + '>ç»¿è‰²æ¸å˜</option></select></label></div><div class="al-card"><label>çŠ¶æ€æ æ–‡å­—é¢œè‰²: <select id="al-statusTextColor" style="width: 200px; margin-left: 10px;"><option value="auto" ' + (statusTextColor === 'auto' ? 'selected' : '') + '>è‡ªåŠ¨</option><option value="#fff" ' + (statusTextColor === '#fff' ? 'selected' : '') + '>ç™½è‰²</option><option value="#000" ' + (statusTextColor === '#000' ? 'selected' : '') + '>é»‘è‰²</option><option value="#ddd" ' + (statusTextColor === '#ddd' ? 'selected' : '') + '>æµ…ç°</option></select></label></div><div class="al-card"><label>çŠ¶æ€æ æ–‡å­—äº®åº¦ (0.5-1.5): <input type="number" id="al-statusTextBrightness" value="' + statusTextBrightness + '" min="0.5" max="1.5" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label><input type="checkbox" id="al-darkModeAuto" ' + (darkModeAuto ? 'checked' : '') + '> è‡ªåŠ¨é€‚é…æš—é»‘æ¨¡å¼</label></div><div class="al-card"><label>æ§åˆ¶é¢æ¿é€æ˜åº¦ (0.1-1): <input type="number" id="al-menuOpacity" value="' + menuOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>æ§åˆ¶é¢æ¿èƒŒæ™¯: <select id="al-menuBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to bottom, #ffffff, #f0f0f0)" ' + (menuBgColor === 'linear-gradient(to bottom, #ffffff, #f0f0f0)' ? 'selected' : '') + '>ç™½è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #333, #222)" ' + (menuBgColor === 'linear-gradient(to bottom, #333, #222)' ? 'selected' : '') + '>é»‘è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #2196F3, #1976D2)" ' + (menuBgColor === 'linear-gradient(to bottom, #2196F3, #1976D2)' ? 'selected' : '') + '>è“è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #4CAF50, #388E3C)" ' + (menuBgColor === 'linear-gradient(to bottom, #4CAF50, #388E3C)' ? 'selected' : '') + '>ç»¿è‰²æ¸å˜</option></select></label></div>';
                } else if (tab === 'filter') {
                    content.innerHTML = '<h3>è¿‡æ»¤è§„åˆ™</h3><div class="al-card"><label>å±è”½ç”¨æˆ· (QQå·,é€—å·åˆ†éš”): <textarea id="al-blocked" style="width: 200px; height: 50px; margin-left: 10px;">' + blocked.join(',') + '</textarea></label></div><div class="al-card"><label>ç™½åå•ç”¨æˆ· (QQå·,é€—å·åˆ†éš”): <textarea id="al-whiteList" style="width: 200px; height: 50px; margin-left: 10px;">' + whiteList.join(',') + '</textarea></label></div><div class="al-card"><label>é»‘åå•åˆ†ç»„ (JSON): <textarea id="al-blockGroups" style="width: 200px; height: 100px; margin-left: 10px;">' + JSON.stringify(blockGroups) + '</textarea></label></div><div class="al-card"><label>åŠ¨æ€å…³é”®è¯ (é€—å·åˆ†éš”,æ”¯æŒæ­£åˆ™): <textarea id="al-filterKeywords" style="width: 200px; height: 50px; margin-left: 10px;">' + filterKeywords.join(',') + '</textarea></label></div><div class="al-card"><label>è¿‡æ»¤æ¨¡å¼: <select id="al-filterMode"><option value="block" ' + (filterMode === 'block' ? 'selected' : '') + '>å±è”½å…³é”®è¯</option><option value="allow" ' + (filterMode === 'allow' ? 'selected' : '') + '>ä»…å…è®¸å…³é”®è¯</option></select></label></div><div class="al-card"><button id="al-import-block" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å¯¼å…¥é»‘åå•</button> <input type="file" id="al-file-input" style="display:none;"><button id="al-export-block" style="background: #673AB7; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å¯¼å‡ºé»‘åå•</button></div>';
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åœ¨è¿™é‡Œï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
                    document.getElementById('al-import-block').addEventListener('click', function() {
                        document.getElementById('al-file-input').click();
                    });
                    document.getElementById('al-file-input').addEventListener('change', function(e) {
                        let file = e.target.files[0];
                        if (file) {
                            let reader = new FileReader();
                            reader.onload = function(ev) {
                                try {
                                    let data = JSON.parse(ev.target.result);
                                    blocked = data.blocked || [];
                                    blockGroups = data.blockGroups || {};
                                    whiteList = data.whiteList || [];
                                    showTab('filter');
                                    alert('å¯¼å…¥æˆåŠŸ');
                                } catch (err) {
                                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                                }
                            };
                            reader.readAsText(file);
                        }
                    });
                    document.getElementById('al-export-block').addEventListener('click', function() {
                        let data = { blocked: blocked, blockGroups: blockGroups, whiteList: whiteList };
                        download('blocklist.json', JSON.stringify(data));
                    });
                } else if (tab === 'adv') {
                    content.innerHTML = '<h3>é«˜çº§å‚æ•°</h3><div class="al-card"><label>æœ€å¤§é‡è¯•æ¬¡æ•°: <input type="number" id="al-maxRetries" value="' + maxRetries + '" min="1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>æ»šåŠ¨æ­¥é•¿ç™¾åˆ†æ¯” (0.1-1): <input type="number" id="al-scrollStepPercent" value="' + scrollStepPercent + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>åˆå§‹å»¶è¿Ÿ (æ¯«ç§’): <input type="number" id="al-initialDelay" value="' + initialDelay + '" min="1000" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>éšæœºå»¶è¿Ÿæœ€å° (ç§’): <input type="number" id="al-randomDelayMin" value="' + randomDelayMin + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>éšæœºå»¶è¿Ÿæœ€å¤§ (ç§’): <input type="number" id="al-randomDelayMax" value="' + randomDelayMax + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>æ—¥å¿—çº§åˆ«: <select id="al-logLevel" style="width: 100px; margin-left: 10px;"><option value="INFO" ' + (logLevel === 'INFO' ? 'selected' : '') + '>INFO</option><option value="WARN" ' + (logLevel === 'WARN' ? 'selected' : '') + '>WARN</option><option value="ERROR" ' + (logLevel === 'ERROR' ? 'selected' : '') + '>ERROR</option></select></label></div><div class="al-card"><label><input type="checkbox" id="al-enableNotifications" ' + (enableNotifications ? 'checked' : '') + '> å¯ç”¨æµè§ˆå™¨é€šçŸ¥</label></div>';
                } else if (tab === 'logs') {
                    content.innerHTML = '<h3>ç³»ç»Ÿæ—¥å¿—</h3><input type="text" id="al-log-search" placeholder="æœç´¢æ—¥å¿—..." style="width: 100%; margin-bottom: 10px;"><table id="al-log-table" style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #ddd; padding: 5px;">æ—¶é—´</th><th style="border: 1px solid #ddd; padding: 5px;">çº§åˆ«</th><th style="border: 1px solid #ddd; padding: 5px;">æ¶ˆæ¯</th></tr></thead><tbody>' + logs.map(function(l) {
                        let parts = l.match(/\[([^\]]+)\] \[([^\]]+)\] (.*)/);
                        if (parts) {
                            return '<tr><td style="border: 1px solid #ddd; padding: 5px;">' + parts[1] + '</td><td style="border: 1px solid #ddd; padding: 5px; color:' + (parts[2] === 'INFO' ? 'green' : (parts[2] === 'WARN' ? 'orange' : 'red')) + ';">' + parts[2] + '</td><td style="border: 1px solid #ddd; padding: 5px;">' + parts[3] + '</td></tr>';
                        } else {
                            return '<tr><td colspan="3" style="border: 1px solid #ddd; padding: 5px;">æ— æ•ˆæ—¥å¿—: ' + l + '</td></tr>';
                        }
                    }).join('') + '</tbody></table><button id="al-clear-logs" style="margin-top: 10px; background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">æ¸…é™¤æ—¥å¿—</button><button id="al-export-logs" style="margin-top: 10px; margin-left: 10px; background: #673AB7; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å¯¼å‡ºæ—¥å¿—</button>';
                    document.getElementById('al-clear-logs').addEventListener('click', function() {
                        logs = [];
                        showTab('logs');
                    });
                    document.getElementById('al-export-logs').addEventListener('click', function() {
                        download('logs.txt', logs.join('\n'));
                    });
                    document.getElementById('al-log-search').addEventListener('input', function(e) {
                        let search = e.target.value.toLowerCase();
                        let rows = document.querySelectorAll('#al-log-table tbody tr');
                        rows.forEach(function(row) {
                            row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
                        });
                    });
                } else if (tab === 'stats') {
                    content.innerHTML = '<h3>æ€§èƒ½ç»Ÿè®¡</h3><div id="al-stats-chart" style="height: 200px; background: #f8f8f8; border: 1px solid #ddd; margin-bottom: 10px;"></div><p>ç‚¹èµ: ' + stats.likes + ' | è·³è¿‡: ' + stats.skips + ' | é”™è¯¯: ' + stats.errors + '</p><p>æˆåŠŸç‡: ' + (stats.likes / (stats.likes + stats.skips + stats.errors) * 100 || 0).toFixed(2) + '%</p><button id="al-clear-stats" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">æ¸…é™¤ç»Ÿè®¡</button>';
                    drawStatsChart();
                    document.getElementById('al-clear-stats').addEventListener('click', function() {
                        stats = { likes: 0, skips: 0, errors: 0 };
                        setCookie('al-stats', JSON.stringify(stats), Number.MAX_SAFE_INTEGER);
                        showTab('stats');
                    });
                } else if (tab === 'accounts') {
                    content.innerHTML = '<h3>è´¦å·ç®¡ç†</h3><select id="al-account-select" style="width: 200px; margin-bottom: 10px;">' + Object.keys(accounts).map(function(acc) {
                        return '<option value="' + acc + '" ' + (acc === currentAccount ? 'selected' : '') + '>' + acc + '</option>';
                    }).join('') + '</select><button id="al-switch-account" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;">åˆ‡æ¢</button><p>å½“å‰è´¦å·: ' + currentAccount + '</p>';
                    document.getElementById('al-switch-account').addEventListener('click', function() {
                        let selected = document.getElementById('al-account-select').value;
                        if (selected && accounts[selected]) {
                            loadAccountConfig(selected);
                            alert('åˆ‡æ¢åˆ°è´¦å· ' + selected);
                        }
                    });
                }
                content.style.opacity = '1';
            }, 300);
        }

        showTab('core');

        document.getElementById('al-tab-core').addEventListener('click', function() { showTab('core'); });
        document.getElementById('al-tab-ui').addEventListener('click', function() { showTab('ui'); });
        document.getElementById('al-tab-filter').addEventListener('click', function() { showTab('filter'); });
        document.getElementById('al-tab-adv').addEventListener('click', function() { showTab('adv'); });
        document.getElementById('al-tab-logs').addEventListener('click', function() { showTab('logs'); });
        document.getElementById('al-tab-stats').addEventListener('click', function() { showTab('stats'); });
        document.getElementById('al-tab-accounts').addEventListener('click', function() { showTab('accounts'); });

        document.getElementById('al-save').addEventListener('click', function() {
            saveConfig();
            sendNotification('é…ç½®æ›´æ–°', 'è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨');
        });

        document.getElementById('al-pause').addEventListener('click', function() {
            isPaused = !isPaused;
            this.innerText = isPaused ? 'æ¢å¤' : 'æš‚åœ';
            if (isPaused) {
                clearAllTimeouts();
                updateStatusBar('è„šæœ¬å·²æš‚åœ');
                log('INFO', 'è„šæœ¬æš‚åœ');
            } else {
                nextTime = Date.now() + duration * 1000;
                updateStatusBar('è„šæœ¬å·²æ¢å¤è¿è¡Œ');
                if (!isRunning) {
                    executeWorkflow();
                }
                log('INFO', 'è„šæœ¬æ¢å¤');
            }
        });

        document.getElementById('al-test').addEventListener('click', function() {
            if (isPaused) {
                alert('è„šæœ¬å½“å‰å¤„äºæš‚åœçŠ¶æ€ï¼Œè¯·å…ˆæ¢å¤è¿è¡Œï¼');
                return;
            }
            testMode = true;
            executeWorkflow();
            testMode = false;
        });

        document.getElementById('al-reset').addEventListener('click', function() {
            if (confirm('ç¡®è®¤é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Ÿ')) {
                resetConfig();
            }
        });

        document.getElementById('al-export').addEventListener('click', function() {
            exportConfig();
        });

        document.getElementById('al-close').addEventListener('click', function() {
            menu.style.display = 'none';
        });

        // å¡ç‰‡æ ·å¼
        let style = document.createElement('style');
        style.innerHTML = '.al-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }';
        document.head.appendChild(style);

        // ä¸»é¢˜åº”ç”¨
        applyTheme(theme);

        let toggleBtn = document.createElement('button');
        toggleBtn.innerText = 'AL Menu';
        toggleBtn.style.position = 'fixed';
        toggleBtn.style.top = '20px';
        toggleBtn.style.right = '10px';
        toggleBtn.style.background = '#2196F3';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
        toggleBtn.style.padding = '8px 12px';
        toggleBtn.style.borderRadius = '4px';
        toggleBtn.style.zIndex = '10003';
        toggleBtn.style.cursor = 'pointer';
        toggleBtn.style.opacity = '0.85';
        toggleBtn.style.transition = 'opacity 0.2s, transform 0.2s';
        toggleBtn.addEventListener('mouseover', function() { toggleBtn.style.opacity = '1'; toggleBtn.style.transform = 'scale(1.1)'; });
        toggleBtn.addEventListener('mouseout', function() { toggleBtn.style.opacity = '0.85'; toggleBtn.style.transform = 'scale(1)'; });
        toggleBtn.addEventListener('click', function() {
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            if (menu.style.display === 'block') {
                showTab('core');
            }
        });

        document.body.appendChild(toggleBtn);

        log('INFO', 'èœå•é¢æ¿åŠ è½½å®Œæˆ');
    }

    // åº”ç”¨ä¸»é¢˜
    function applyTheme(th) {
        let primary = '#4CAF50';
        if (th === 'tech') primary = '#2196F3';
        if (th === 'eco') primary = '#388E3C';
        document.documentElement.style.setProperty('--primary-color', primary);
        // æ›´æ–°æŒ‰é’®ç­‰
        let buttons = document.querySelectorAll('button');
        buttons.forEach(function(btn) {
            if (btn.id !== 'al-pause' && btn.id !== 'al-test' && btn.id !== 'al-close' && btn.id !== 'al-reset' && btn.id !== 'al-export') {
                btn.style.background = primary;
            }
        });
    }

    // ä¿å­˜é…ç½®
    function saveConfig() {
        duration = parseInt(document.getElementById('al-dur') ? document.getElementById('al-dur').value : duration, 10) || 180;
        refreshDelay = parseInt(document.getElementById('al-rdelay') ? document.getElementById('al-rdelay').value : refreshDelay, 10) || 10;
        likeDelay = parseInt(document.getElementById('al-ldelay') ? document.getElementById('al-ldelay').value : likeDelay, 10) || 5;
        scrollCount = parseInt(document.getElementById('al-scount') ? document.getElementById('al-scount').value : scrollCount, 10) || 3;
        dailyLimit = parseInt(document.getElementById('al-dailyLimit') ? document.getElementById('al-dailyLimit').value : dailyLimit, 10) || 0;
        let blk = document.getElementById('al-blocked') ? document.getElementById('al-blocked').value.replace(/\s/g, '') : blocked.join(',');
        blocked = blk ? blk.split(',').filter(Boolean) : [];
        let wht = document.getElementById('al-whiteList') ? document.getElementById('al-whiteList').value.replace(/\s/g, '') : whiteList.join(',');
        whiteList = wht ? wht.split(',').filter(Boolean) : [];
        let grps = document.getElementById('al-blockGroups') ? document.getElementById('al-blockGroups').value : JSON.stringify(blockGroups);
        blockGroups = safeJsonParse(grps) || blockGroups;
        let kwds = document.getElementById('al-filterKeywords') ? document.getElementById('al-filterKeywords').value.replace(/\s/g, '') : filterKeywords.join(',');
        filterKeywords = kwds ? kwds.split(',').filter(Boolean) : [];
        filterMode = document.getElementById('al-filterMode') ? document.getElementById('al-filterMode').value : filterMode;
        select = document.getElementById('al-select') ? document.getElementById('al-select').checked : select;
        theme = document.getElementById('al-theme') ? document.getElementById('al-theme').value : theme;
        darkModeAuto = document.getElementById('al-darkModeAuto') ? document.getElementById('al-darkModeAuto').checked : darkModeAuto;
        statusOpacity = parseFloat(document.getElementById('al-statusOpacity') ? document.getElementById('al-statusOpacity').value : statusOpacity) || 0.8;
        statusBgColor = document.getElementById('al-statusBgColor') ? document.getElementById('al-statusBgColor').value : statusBgColor;
        statusTextColor = document.getElementById('al-statusTextColor') ? document.getElementById('al-statusTextColor').value : statusTextColor;
        statusTextBrightness = parseFloat(document.getElementById('al-statusTextBrightness') ? document.getElementById('al-statusTextBrightness').value : statusTextBrightness) || 1.0;
        menuOpacity = parseFloat(document.getElementById('al-menuOpacity') ? document.getElementById('al-menuOpacity').value : menuOpacity) || 0.9;
        menuBgColor = document.getElementById('al-menuBgColor') ? document.getElementById('al-menuBgColor').value : menuBgColor;
        maxRetries = parseInt(document.getElementById('al-maxRetries') ? document.getElementById('al-maxRetries').value : maxRetries, 10) || 3;
        scrollStepPercent = parseFloat(document.getElementById('al-scrollStepPercent') ? document.getElementById('al-scrollStepPercent').value : scrollStepPercent) || 0.9;
        initialDelay = parseInt(document.getElementById('al-initialDelay') ? document.getElementById('al-initialDelay').value : initialDelay, 10) || 3000;
        randomDelayMin = parseInt(document.getElementById('al-randomDelayMin') ? document.getElementById('al-randomDelayMin').value : randomDelayMin, 10) || 1;
        randomDelayMax = parseInt(document.getElementById('al-randomDelayMax') ? document.getElementById('al-randomDelayMax').value : randomDelayMax, 10) || 3;
        logLevel = document.getElementById('al-logLevel') ? document.getElementById('al-logLevel').value : logLevel;
        enableNotifications = document.getElementById('al-enableNotifications') ? document.getElementById('al-enableNotifications').checked : enableNotifications;

        const max = Number.MAX_SAFE_INTEGER;
        setCookie('al-duration', duration, max);
        setCookie('al-refreshDelay', refreshDelay, max);
        setCookie('al-likeDelay', likeDelay, max);
        setCookie('al-scrollCount', scrollCount, max);
        setCookie('al-dailyLimit', dailyLimit, max);
        setCookie('al-blocked', blocked.join(','), max);
        setCookie('al-whiteList', whiteList.join(','), max);
        setCookie('al-blockGroups', JSON.stringify(blockGroups), max);
        setCookie('al-filterKeywords', filterKeywords.join(','), max);
        setCookie('al-filterMode', filterMode, max);
        setCookie('al-select', select ? 'true' : '', max);
        setCookie('al-theme', theme, max);
        setCookie('al-darkModeAuto', darkModeAuto ? 'true' : '', max);
        setCookie('al-statusOpacity', statusOpacity, max);
        setCookie('al-statusBgColor', statusBgColor, max);
        setCookie('al-statusTextColor', statusTextColor, max);
        setCookie('al-statusTextBrightness', statusTextBrightness, max);
        setCookie('al-menuOpacity', menuOpacity, max);
        setCookie('al-menuBgColor', menuBgColor, max);
        setCookie('al-maxRetries', maxRetries, max);
        setCookie('al-scrollStepPercent', scrollStepPercent, max);
        setCookie('al-initialDelay', initialDelay, max);
        setCookie('al-randomDelayMin', randomDelayMin, max);
        setCookie('al-randomDelayMax', randomDelayMax, max);
        setCookie('al-logLevel', logLevel, max);
        setCookie('al-enableNotifications', enableNotifications ? 'true' : '', max);

        // ä¿å­˜åˆ°å½“å‰è´¦å·
        saveAccountConfig();

        nextTime = Date.now() + duration * 1000;
        alert('è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼');

        let statusBar = document.getElementById('al-status-bar');
        if (statusBar) {
            statusBar.style.opacity = statusOpacity;
            statusBar.style.background = statusBgColor;
            statusBar.style.color = statusTextColor;
            statusBar.style.filter = 'brightness(' + statusTextBrightness + ')';
        }
        let menuElem = document.getElementById('al-menu');
        if (menuElem) {
            menuElem.style.opacity = menuOpacity;
            menuElem.style.background = menuBgColor;
        }

        applyDarkMode();
        applyTheme(theme);
        updateStatusBar();
    }

    // é‡ç½®é…ç½®
    function resetConfig() {
        const keys = ['al-duration', 'al-refreshDelay', 'al-likeDelay', 'al-scrollCount', 'al-dailyLimit', 'al-blocked', 'al-whiteList', 'al-blockGroups', 'al-filterKeywords', 'al-filterMode', 'al-select', 'al-theme', 'al-darkModeAuto', 'al-statusOpacity', 'al-statusBgColor', 'al-statusTextColor', 'al-statusTextBrightness', 'al-menuOpacity', 'al-menuBgColor', 'al-maxRetries', 'al-scrollStepPercent', 'al-initialDelay', 'al-randomDelayMin', 'al-randomDelayMax', 'al-logLevel', 'al-enableNotifications', 'al-stats', 'al-accounts'];
        keys.forEach(function(key) { setCookie(key, '', -1); });
        location.reload();
    }

    // å¯¼å‡ºé…ç½®
    function exportConfig() {
        let config = {
            duration: duration, refreshDelay: refreshDelay, likeDelay: likeDelay, scrollCount: scrollCount, dailyLimit: dailyLimit, blocked: blocked, whiteList: whiteList, blockGroups: blockGroups, filterKeywords: filterKeywords, filterMode: filterMode, select: select, theme: theme, darkModeAuto: darkModeAuto, statusOpacity: statusOpacity, statusBgColor: statusBgColor, statusTextColor: statusTextColor, statusTextBrightness: statusTextBrightness, menuOpacity: menuOpacity, menuBgColor: menuBgColor, maxRetries: maxRetries, scrollStepPercent: scrollStepPercent, initialDelay: initialDelay, randomDelayMin: randomDelayMin, randomDelayMax: randomDelayMax, logLevel: logLevel, enableNotifications: enableNotifications, stats: stats
        };
        download('config.json', JSON.stringify(config));
    }

    // ä¸‹è½½æ–‡ä»¶
    function download(filename, text) {
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // ç»˜åˆ¶ç»Ÿè®¡å›¾è¡¨
    function drawStatsChart() {
        let chartDiv = document.getElementById('al-stats-chart');
        if (!chartDiv) return;
        let canvas = document.createElement('canvas');
        canvas.width = 300;
        canvas.height = 200;
        chartDiv.appendChild(canvas);
        let ctx = canvas.getContext('2d');
        let data = [stats.likes, stats.skips, stats.errors];
        let labels = ['ç‚¹èµ', 'è·³è¿‡', 'é”™è¯¯'];
        let colors = ['#4CAF50', '#FF9800', '#f44336'];
        let total = data.reduce(function(a, b) { return a + b; }, 0) || 1; // é¿å…é™¤é›¶
        let startAngle = 0;
        for (let i = 0; i < data.length; i++) {
            let sliceAngle = (data[i] / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.arc(150, 100, 100, startAngle, startAngle + sliceAngle);
            ctx.lineTo(150, 100);
            ctx.fillStyle = colors[i];
            ctx.fill();
            startAngle += sliceAngle;
        }
    }

    // å¤šè´¦å·é…ç½®åŠ è½½/ä¿å­˜
    function loadAccountConfig(acc) {
        if (accounts[acc]) {
            let config = accounts[acc];
            duration = config.duration;
            refreshDelay = config.refreshDelay;
            likeDelay = config.likeDelay;
            scrollCount = config.scrollCount;
            dailyLimit = config.dailyLimit;
            blocked = config.blocked;
            whiteList = config.whiteList;
            blockGroups = config.blockGroups;
            filterKeywords = config.filterKeywords;
            filterMode = config.filterMode;
            select = config.select;
            theme = config.theme;
            darkModeAuto = config.darkModeAuto;
            statusOpacity = config.statusOpacity;
            statusBgColor = config.statusBgColor;
            statusTextColor = config.statusTextColor;
            statusTextBrightness = config.statusTextBrightness;
            menuOpacity = config.menuOpacity;
            menuBgColor = config.menuBgColor;
            maxRetries = config.maxRetries;
            scrollStepPercent = config.scrollStepPercent;
            initialDelay = config.initialDelay;
            randomDelayMin = config.randomDelayMin;
            randomDelayMax = config.randomDelayMax;
            logLevel = config.logLevel;
            enableNotifications = config.enableNotifications;
            stats = config.stats;
            currentAccount = acc;
            updateStatusBar();
        }
    }

    function saveAccountConfig() {
        accounts[currentAccount] = {
            duration: duration, refreshDelay: refreshDelay, likeDelay: likeDelay, scrollCount: scrollCount, dailyLimit: dailyLimit, blocked: blocked, whiteList: whiteList, blockGroups: blockGroups, filterKeywords: filterKeywords, filterMode: filterMode, select: select, theme: theme, darkModeAuto: darkModeAuto, statusOpacity: statusOpacity, statusBgColor: statusBgColor, statusTextColor: statusTextColor, statusTextBrightness: statusTextBrightness, menuOpacity: menuOpacity, menuBgColor: menuBgColor, maxRetries: maxRetries, scrollStepPercent: scrollStepPercent, initialDelay: initialDelay, randomDelayMin: randomDelayMin, randomDelayMax: randomDelayMax, logLevel: logLevel, enableNotifications: enableNotifications, stats: stats
        };
        setCookie('al-accounts', JSON.stringify(accounts), Number.MAX_SAFE_INTEGER);
    }

    // è‡ªåŠ¨æš—é»‘æ¨¡å¼
    function applyDarkMode() {
        if (!darkModeAuto) return;
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            statusBgColor = 'linear-gradient(to right, #333, #222)';
            statusTextColor = '#ddd';
            menuBgColor = 'linear-gradient(to bottom, #333, #222)';
        } else {
            statusBgColor = 'linear-gradient(to right, #f0f0f0, #e0e0e0)';
            statusTextColor = '#333';
            menuBgColor = 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
        }
        let statusBar = document.getElementById('al-status-bar');
        if (statusBar) {
            statusBar.style.background = statusBgColor;
            statusBar.style.color = statusTextColor;
        }
        let menuElem = document.getElementById('al-menu');
        if (menuElem) {
            menuElem.style.background = menuBgColor;
        }
    }

    // åˆ›å»ºçŠ¶æ€æ ï¼ˆæ”¹è¿›ï¼šç½‘æ ¼å¸ƒå±€ã€è¿›åº¦æ¡ã€äº¤äº’ï¼‰
    function createStatusBar() {
        let statusBar = document.createElement('div');
        statusBar.id = 'al-status-bar';
        statusBar.style.position = 'fixed';
        statusBar.style.top = '0';
        statusBar.style.left = '0';
        statusBar.style.width = '100%';
        statusBar.style.background = statusBgColor;
        statusBar.style.padding = '12px 24px';
        statusBar.style.zIndex = '10001';
        statusBar.style.fontSize = '15px';
        statusBar.style.lineHeight = '1.6';
        statusBar.style.textAlign = 'center';
        statusBar.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
        statusBar.style.borderRadius = '0 0 10px 10px';
        statusBar.style.fontFamily = 'Arial, sans-serif';
        statusBar.style.color = statusTextColor;
        statusBar.style.opacity = statusOpacity;
        statusBar.style.filter = 'brightness(' + statusTextBrightness + ')';
        statusBar.style.pointerEvents = 'auto'; // å…è®¸äº¤äº’
        statusBar.style.cursor = 'pointer';
        statusBar.style.display = 'grid';
        statusBar.style.gridTemplateColumns = '1fr 2fr 1fr';
        statusBar.style.transition = 'opacity 0.3s ease, background 0.3s ease';
        document.body.appendChild(statusBar);

        statusBar.addEventListener('click', function() {
            this.style.height = this.style.height === 'auto' ? '' : 'auto'; // å±•å¼€/æŠ˜å ï¼Œä¿®æ­£initialä¸º''
        });

        setInterval(updateStatusBar, 1000);
        updateStatusBar();

        log('INFO', 'çŠ¶æ€æ åŠ è½½å®Œæˆ');
    }

    // æ›´æ–°çŠ¶æ€æ ï¼ˆæ”¹è¿›ï¼šè¿›åº¦æ¡ã€ä»Šæ—¥ç‚¹èµï¼‰
    function updateStatusBar(message) {
        resetDailyCount();
        duration = parseInt(getCookie('al-duration')) || duration;
        refreshDelay = parseInt(getCookie('al-refreshDelay')) || refreshDelay;
        likeDelay = parseInt(getCookie('al-likeDelay')) || likeDelay;
        scrollCount = parseInt(getCookie('al-scrollCount')) || scrollCount;

        let statusBar = document.getElementById('al-status-bar');
        if (!statusBar) return;

        message = message || '';

        if (message) {
            log('INFO', 'çŠ¶æ€æ æ›´æ–°: ' + message);
        }

        let lastRefreshTime = new Date(lastRefresh).toLocaleTimeString();
        let remainingSeconds = Math.max(0, Math.ceil((nextTime - Date.now()) / 1000));
        let remainingColor = remainingSeconds < 30 ? 'red' : 'green';
        let scrollingStatus = isScrolling ? '<span style="color: lightblue; font-weight: bold;">æ»šåŠ¨ä¸­ ğŸ”„</span>' : '<span style="color: gray;">é™æ­¢ â¹ï¸</span>';
        let currentStep = message || (isPaused ? '<span style="color: yellow; font-weight: bold;">å·²æš‚åœ â¸ï¸</span>' : (isRunning ? '<span style="color: orange; font-weight: bold;">æ‰§è¡Œä¸­ï¼š' + currentTask + ' ğŸš€</span>' : '<span style="color: lightgreen; font-weight: bold;">ç­‰å¾…ä¸‹æ¬¡åˆ·æ–° â°</span>'));
        let taskRemaining = taskDuration > 0 ? Math.max(0, Math.ceil((taskStartTime + taskDuration * 1000 - Date.now()) / 1000)) : 0;
        let taskProgressPercent = taskDuration > 0 ? Math.round((1 - (taskRemaining / taskDuration)) * 100) : 0;
        let progressBar = '<div style="background: #ddd; height: 5px; width: 100%;"><div style="background: #4CAF50; height: 5px; width: ' + taskProgressPercent + '%;"></div></div>';
        let taskProgress = taskRemaining > 0 ? '<span style="color: violet;">ä»»åŠ¡è¿›åº¦: ' + taskProgressPercent + '% ğŸ“Š</span>' : '';
        let retryInfo = retryCount > 0 ? '<span style="color: brown;">é‡è¯•: ' + retryCount + '/' + maxRetries + ' âš ï¸</span>' : '';
        let dailyInfo = dailyLimit > 0 ? '<span style="color: purple;">ä»Šæ—¥ç‚¹èµ: ' + dailyCount + '/' + dailyLimit + ' â¤ï¸</span>' : '';

        let strongColor = statusTextColor === '#ddd' || statusTextColor === '#fff' ? '#ccc' : '#555';

        let infoParts = [taskProgress, retryInfo, dailyInfo].filter(Boolean);
        let infoSection = infoParts.length > 0 ? infoParts.join(' | ') + ' | ' : '';

        let html = progressBar + '<div style="grid-column: 1;">ä¸Šæ¬¡: <strong style="color: ' + strongColor + ';">' + lastRefreshTime + ' â±ï¸</strong> | å‰©ä½™: <span style="color: ' + remainingColor + ';">' + remainingSeconds + 's</span></div><div style="grid-column: 2;">' + currentStep + ' | ' + scrollingStatus + '</div><div style="grid-column: 3;">é—´éš”: <strong>' + duration + 's</strong> | å»¶è¿Ÿ: <strong>' + likeDelay + 's</strong></div><div style="grid-column: 1 / 4; font-size: 14px;">' + infoSection + 'çŠ¶æ€: <span style="color: ' + (isPaused ? 'yellow' : (isRunning ? 'orange' : 'lightgreen')) + ';">' + (isPaused ? 'æš‚åœ' : (isRunning ? 'å¿™ç¢Œ' : 'ç©ºé—²')) + '</span></div>';
        statusBar.innerHTML = html;
    }

    // ç§»é™¤èœå•å…ƒç´ 
    function removeMeRelatedMenu() {
        let meTab = document.getElementById('tab_menu_me') || document.querySelector('li[type="me"]') || document.querySelector('#feed_tab_my');
        if (meTab) {
            meTab.style.display = 'none';
        }
    }

    // æ£€æµ‹é¡µé¢
    function isInFriendFeedPage() {
        const hasLikeButtons = document.querySelectorAll('.qz_like_btn_v3').length > 0;
        return hasLikeButtons;
    }

    // è¿›å…¥å¥½å‹åŠ¨æ€
    function goToFriendFeed() {
        try {
            log('INFO', 'è¿›å…¥å¥½å‹åŠ¨æ€é¡µé¢');
            currentTask = 'åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€é¡µé¢';
            taskStartTime = Date.now();
            taskDuration = 5;
            nextTask = 'åˆ·æ–°é¡µé¢å¹¶é‡è¯•æµç¨‹';
            updateStatusBar('åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€...');
            let friendTab = document.getElementById('tab_menu_friend') || document.querySelector('li[type="friend"] a') || document.querySelector('.feed-control-tab a:not(.item-on)');
            if (friendTab) {
                friendTab.click();
            } else if (uin) {
                location.href = 'https://user.qzone.qq.com/' + uin + '/infocenter';
            } else {
                refresh();
            }
        } catch (e) {
            log('ERROR', 'è¿›å…¥å¥½å‹åŠ¨æ€å¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    }

    // å®‰å…¨ç‚¹èµï¼ˆæ‰©å±•ï¼šå…³é”®è¯è¿‡æ»¤ã€ç™½åå•ã€æ¯æ—¥ä¸Šé™ã€éšæœºå»¶è¿Ÿï¼›ä¿®å¤ï¼šä½¿ç”¨innerTextæå–å†…å®¹ï¼Œé¿å…HTMLå¹²æ‰°ï¼›ç‚¹èµåæ·»åŠ å»¶è¿Ÿæ£€æŸ¥classæ›´æ–°ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»ï¼‰
    let likeDebounce = null;
    function safeLike() {
        try {
            if (isPaused) {
                updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡ç‚¹èµ');
                return;
            }
            if (currentTask === 'æ‰§è¡Œå®‰å…¨ç‚¹èµ') return;
            if (likeDebounce) clearTimeout(likeDebounce);
            likeDebounce = setTimeout(function() {
                currentTask = 'æ‰§è¡Œå®‰å…¨ç‚¹èµ';
                taskStartTime = Date.now();
                const btns = document.querySelectorAll('.qz_like_btn_v3');
                const contents = document.querySelectorAll('.f-info');
                const users = document.querySelectorAll('.f-name');
                let toLike = [];
                let skipped = 0;

                Array.from(btns).forEach(function(btn, index) {
                    const contentElem = contents[index];
                    const content = contentElem ? contentElem.innerText : ''; // æ”¹ä¸ºinnerTextï¼Œé¿å…HTMLæ ‡ç­¾å¹²æ‰°å…³é”®è¯åŒ¹é…
                    const user = users[index] && users[index].getAttribute('link') ? users[index].getAttribute('link').replace('nameCard_', '') : '';

                    if (btn.classList.contains('item-on')) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', 'è·³è¿‡å·²èµåŠ¨æ€ ' + (index + 1));
                        return;
                    }

                    // ç™½åå•ä¼˜å…ˆ
                    if (whiteList.includes(user)) {
                        toLike.push({btn: btn, content: content, index: index});
                        return;
                    }

                    // é»‘åå•æ£€æŸ¥ï¼ˆåŒ…æ‹¬åˆ†ç»„ï¼‰
                    let isBlocked = blocked.includes(user);
                    Object.values(blockGroups).forEach(function(group) {
                        if (group.includes(user)) isBlocked = true;
                    });
                    if (isBlocked) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', 'è·³è¿‡å±è”½ç”¨æˆ·åŠ¨æ€ ' + (index + 1) + ', ç”¨æˆ·: ' + user);
                        return;
                    }

                    // æ¸¸æˆè½¬å‘
                    let isGameForward = false;
                    if (select) {
                        for (let j = 0; j < dict.length; j++) {
                            if (content.includes(dict[j])) {
                                isGameForward = true;
                                break;
                            }
                        }
                    }
                    if (isGameForward) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', 'è·³è¿‡æ¸¸æˆè½¬å‘åŠ¨æ€ ' + (index + 1));
                        return;
                    }

                    // å…³é”®è¯è¿‡æ»¤ï¼ˆåŠ å¼ºæ—¥å¿—ï¼‰
                    let matchesKeyword = false;
                    filterKeywords.forEach(function(kw) {
                        try {
                            let regex = new RegExp(kw, 'i');
                            if (regex.test(content)) {
                                matchesKeyword = true;
                                log('INFO', 'å…³é”®è¯åŒ¹é…: ' + kw + ' åœ¨åŠ¨æ€ ' + (index + 1) + ' ä¸­æ‰¾åˆ°');
                            }
                        } catch (e) {
                            if (content.includes(kw)) {
                                matchesKeyword = true;
                                log('INFO', 'å…³é”®è¯åŒ…å«: ' + kw + ' åœ¨åŠ¨æ€ ' + (index + 1) + ' ä¸­æ‰¾åˆ°');
                            }
                        }
                    });
                    if ((filterMode === 'block' && matchesKeyword) || (filterMode === 'allow' && !matchesKeyword)) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', 'è·³è¿‡å…³é”®è¯è¿‡æ»¤åŠ¨æ€ ' + (index + 1));
                        return;
                    }

                    // æ¯æ—¥ä¸Šé™
                    if (dailyLimit > 0 && dailyCount >= dailyLimit) {
                        updateStatusBar('è¾¾åˆ°æ¯æ—¥ä¸Šé™ï¼Œåœæ­¢ç‚¹èµ');
                        sendNotification('æ¯æ—¥ä¸Šé™', 'å·²è¾¾åˆ°ç‚¹èµä¸Šé™: ' + dailyLimit);
                        return;
                    }

                    toLike.push({btn: btn, content: content, index: index});
                });

                let effectiveLikes = toLike.length;
                taskDuration = effectiveLikes * (likeDelay + (randomDelayMax - randomDelayMin) / 2) + 1;
                nextTask = 'æ¨¡æ‹Ÿæ»šåŠ¨æˆ–ç­‰å¾…åˆ·æ–°';
                nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
                updateStatusBar('å¼€å§‹ç‚¹èµ (éœ€èµ: ' + effectiveLikes + ', è·³è¿‡: ' + skipped + ')');
                log('INFO', 'å¼€å§‹ç‚¹èµ (éœ€èµ: ' + effectiveLikes + ', è·³è¿‡: ' + skipped + ')');

                if (effectiveLikes === 0) {
                    currentTask = '';
                    taskDuration = 0;
                    updateStatusBar('æ‰€æœ‰åŠ¨æ€è·³è¿‡ï¼Œç­‰å¾…åˆ·æ–°');
                    return;
                }

                let cumulativeDelay = 0;
                toLike.forEach(function(item, idx) {
                    let delay = likeDelay * 1000 + Math.random() * (randomDelayMax - randomDelayMin) * 1000;
                    cumulativeDelay += delay;
                    setTimeout(function() {
                        if (isPaused || (dailyLimit > 0 && dailyCount >= dailyLimit)) return;

                        // åŒé‡æ£€æŸ¥å·²èµï¼ˆé˜²æ­¢å»¶è¿Ÿæ›´æ–°ï¼‰
                        if (item.btn.classList.contains('item-on')) {
                            log('WARN', 'åŠ¨æ€ ' + (item.index + 1) + ' å·²èµï¼Œè·³è¿‡ç‚¹å‡»');
                            return;
                        }

                        item.btn.click();
                        dailyCount++;
                        setCookie('al-dailyCount', dailyCount, Number.MAX_SAFE_INTEGER);
                        updateStats('likes');
                        console.log('Liked: ' + item.content);
                        updateStatusBar('ç‚¹èµåŠ¨æ€ ' + (item.index + 1) + ' / ' + btns.length);
                        log('INFO', 'ç‚¹èµåŠ¨æ€ ' + (item.index + 1));

                        // ç‚¹èµåç­‰å¾…classæ›´æ–°
                        setTimeout(function() {
                            if (item.btn.classList.contains('item-on')) {
                                log('INFO', 'åŠ¨æ€ ' + (item.index + 1) + ' classæ›´æ–°ä¸ºå·²èµ');
                            } else {
                                log('WARN', 'åŠ¨æ€ ' + (item.index + 1) + ' classæœªåŠæ—¶æ›´æ–°');
                            }
                        }, 500);
                    }, cumulativeDelay - delay); // ç´¯è®¡å‰é¢çš„å»¶è¿Ÿ
                });

                setTimeout(function() {
                    if (isPaused) return;
                    currentTask = '';
                    taskDuration = 0;
                    updateStatusBar('ç‚¹èµå®Œæˆï¼Œç­‰å¾…åˆ·æ–°');
                    log('INFO', 'ç‚¹èµå®Œæˆ');
                    sendNotification('ç‚¹èµå®Œæˆ', 'æœ¬æ¬¡ç‚¹èµ: ' + effectiveLikes);
                }, cumulativeDelay + 1000); // æ€»å»¶è¿ŸååŠ ç¼“å†²
            }, 500);
        } catch (e) {
            log('ERROR', 'å®‰å…¨ç‚¹èµå¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    }

    // æ¨¡æ‹Ÿæ»šåŠ¨
    function simulateScroll() {
        try {
            if (isPaused) {
                updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡æ»šåŠ¨');
                return;
            }
            currentTask = 'æ¨¡æ‹Ÿä¸‹æ»‘åŠ¨æ€';
            taskStartTime = Date.now();
            taskDuration = scrollCount * 3 + 3;
            nextTask = 'å›åˆ°é¡¶éƒ¨å¹¶ç­‰å¾…';
            nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
            updateStatusBar('æ¨¡æ‹Ÿä¸‹æ»‘...');
            log('INFO', 'æ¨¡æ‹Ÿæ»šåŠ¨å¼€å§‹');
            let scrollStep = window.innerHeight * scrollStepPercent;

            Array.from({length: scrollCount}).forEach(function(_, i) {
                setTimeout(function() {
                    if (isPaused) return;
                    smoothScrollTo((i + 1) * scrollStep, 500);
                    window.dispatchEvent(new Event('scroll'));
                    updateStatusBar('æ»šåŠ¨åˆ°ç»„ ' + (i + 1) + '/' + scrollCount);
                    log('INFO', 'æ»šåŠ¨åˆ°ç»„ ' + (i + 1));
                    let loadMoreBtn = document.querySelector('.load-more') || document.querySelector('a[title="åŠ è½½æ›´å¤š"]');
                    if (loadMoreBtn) loadMoreBtn.click();
                }, i * 3000);
            });
            setTimeout(function() {
                if (isPaused) return;
                smoothScrollTo(0, 1000);
                updateStatusBar('å›åˆ°é¡¶éƒ¨ï¼Œç­‰å¾…åˆ·æ–°');
                currentTask = '';
                taskDuration = 0;
                log('INFO', 'æ»šåŠ¨ç»“æŸ');
            }, scrollCount * 3000 + 3000);
        } catch (e) {
            log('ERROR', 'æ»šåŠ¨å¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    }

    // å¹³æ»‘æ»šåŠ¨
    function smoothScrollTo(targetY, duration) {
        let startY = window.scrollY;
        let distance = targetY - startY;
        let startTime = null;

        function animation(currentTime) {
            if (isPaused) return;
            if (!startTime) startTime = currentTime;
            let timeElapsed = currentTime - startTime;
            let progress = Math.min(timeElapsed / duration, 1);
            let ease = progress * (2 - progress);
            window.scrollTo(0, startY + distance * ease);
            if (timeElapsed < duration) {
                requestAnimationFrame(animation);
            } else {
                window.dispatchEvent(new Event('scroll'));
            }
        }

        requestAnimationFrame(animation);
    }

    // åˆ·æ–°
    function refresh() {
        try {
            if (isPaused) return;
            log('INFO', 'åˆ·æ–°è§¦å‘');
            currentTask = 'åˆ·æ–°é¡µé¢';
            taskStartTime = Date.now();
            taskDuration = refreshDelay;
            nextTask = 'æ‰§è¡Œå·¥ä½œæµ';
            lastRefresh = Date.now();
            setCookie('al-lastRefresh', lastRefresh, Number.MAX_SAFE_INTEGER);
            nextTime = Date.now() + duration * 1000;
            setCookie('al-justRefreshed', 'true', 60);
            location.reload();
        } catch (e) {
            log('ERROR', 'åˆ·æ–°å¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    }

    // æ‰§è¡Œå·¥ä½œæµ
    function executeWorkflow() {
        if (isPaused) return;
        if (isRunning && !testMode) return;
        isRunning = true;
        currentTask = 'æ‰§è¡Œå·¥ä½œæµ';
        taskStartTime = Date.now();
        taskDuration = 10;
        nextTask = 'ç‚¹èµæˆ–åˆ‡æ¢';
        updateStatusBar('å¼€å§‹å·¥ä½œæµ');
        log('INFO', 'å¼€å§‹å·¥ä½œæµ');

        setTimeout(function() {
            try {
                if (isPaused) {
                    isRunning = false;
                    return;
                }
                if (isInFriendFeedPage()) {
                    updateStatusBar('ç›´æ¥æ‰§è¡Œç‚¹èµ');
                    log('INFO', 'ç›´æ¥ç‚¹èµ');
                    safeLike();
                    simulateScroll();
                } else {
                    updateStatusBar('åˆ‡æ¢å¹¶åˆ·æ–°');
                    retryCount++;
                    log('WARN', 'é‡è¯•: ' + retryCount);
                    if (retryCount > maxRetries) {
                        updateStatusBar('é‡è¯•è¶…é™');
                        log('ERROR', 'é‡è¯•è¶…é™');
                        isRunning = false;
                        retryCount = 0;
                        updateStats('errors');
                        return;
                    }
                    goToFriendFeed();
                    refresh();
                    setTimeout(executeWorkflow, refreshDelay * 1000);
                }
                isRunning = false;
                currentTask = '';
                taskDuration = 0;
            } catch (e) {
                log('ERROR', 'å·¥ä½œæµå¼‚å¸¸: ' + e.message);
                isRunning = false;
                updateStats('errors');
            }
        }, initialDelay);
    }

    // æ»šåŠ¨äº‹ä»¶
    let scrollDebounce = null;
    window.addEventListener('scroll', function() {
        if (isPaused) return;
        if (timeout) clearTimeout(timeout);
        isScrolling = true;
        updateStatusBar();
        if (scrollDebounce) clearTimeout(scrollDebounce);
        scrollDebounce = setTimeout(safeLike, 1000);
        timeout = setTimeout(function() {
            isScrolling = false;
            updateStatusBar();
        }, 1000);
    });

    // ä¸»å¾ªç¯
    let mainInterval = setInterval(function() {
        try {
            if (isPaused) {
                updateStatusBar('æš‚åœä¸­');
                return;
            }
            let time = Date.now();
            if (time >= nextTime || testMode) {
                refresh();
            } else if (isScrolling) {
                safeLike();
            }
        } catch (e) {
            log('ERROR', 'ä¸»å¾ªç¯å¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    }, 1000);

    // æ¸…ç†å®šæ—¶å™¨
    function clearAllTimeouts() {
        clearTimeout(timeout);
        clearTimeout(likeDebounce);
        clearTimeout(scrollDebounce);
        clearInterval(mainInterval);
        mainInterval = null;
    }

    // åˆå§‹åŒ–
    window.onload = function () {
        try {
            createMenu();
            createStatusBar();
            applyDarkMode();

            removeMeRelatedMenu();

            if (getCookie('al-justRefreshed')) {
                setCookie('al-justRefreshed', '', -1);
                setTimeout(executeWorkflow, 3000);
            }

            // åŠ è½½å½“å‰è´¦å·é…ç½®
            loadAccountConfig(currentAccount);

            log('INFO', 'è„šæœ¬åˆå§‹åŒ–å®Œæˆ');
        } catch (e) {
            log('ERROR', 'åˆå§‹åŒ–å¼‚å¸¸: ' + e.message);
            updateStats('errors');
        }
    };

    console.log('Auto Like Enhanced v2.8.2 Running...');
})();
