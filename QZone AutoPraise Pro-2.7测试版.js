// ==UserScript==
// @name         QZone AutoPraise Pro
// @namespace    https://github.com/llulun/qzone-autopraise-pro
// @license      MIT
// @version      2.7
// @description  ç½‘é¡µç‰ˆQQç©ºé—´è‡ªåŠ¨ç‚¹èµå·¥å…·ï¼ˆå¢å¼ºç‰ˆï¼šç®€åŒ–å·¥ä½œæµï¼Œé€šè¿‡æ£€æµ‹ç‚¹èµå…ƒç´ åˆ¤æ–­æ˜¯å¦åœ¨å¥½å‹åŠ¨æ€é¡µé¢ï¼Œæœ‰åˆ™ç›´æ¥æ‰§è¡Œç‚¹èµï¼Œæ— åˆ™åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€ååˆ·æ–°é¡µé¢é‡èµ°æµç¨‹ï¼Œç§»é™¤èœå•å…ƒç´ ï¼Œæ·»åŠ å»¶è¿Ÿå¤„ç†ã€å®‰å…¨ç‚¹èµã€èœå•è°ƒæ•´ã€çŠ¶æ€æ ç¾åŒ–ã€æ»šåŠ¨æ¨¡æ‹Ÿç­‰åŠŸèƒ½ã€‚æ›´æ–°ï¼šçŠ¶æ€æ æ›´è¯¦ç»†æ˜¾ç¤ºä»»åŠ¡è¿›åº¦ã€å‰©ä½™æ—¶é—´ç­‰ï¼Œç¾åŒ–é€æ˜åº¦ä¸é˜´å½±ï¼›æ§åˆ¶é¢æ¿å¢å¤§ã€å±…ä¸­ã€é€æ˜åŒ–ï¼›ä¿®å¤çŠ¶æ€æ æ–‡å­—æ¨¡ç³Šä¸é‡å é—®é¢˜ï¼Œé€šè¿‡åˆ†è¡Œæ˜¾ç¤ºã€è°ƒæ•´å­—ä½“ä¸è¡Œé«˜ç¡®ä¿æ¸…æ™°ï¼›çŠ¶æ€æ èƒŒæ™¯æ”¹ä¸ºé»‘è‰²æ¸å˜ï¼Œæ·»åŠ é€æ˜é˜´å½±ä¸åº•éƒ¨åœ†è§’ï¼›æ‰©å±•æ§åˆ¶é¢æ¿ä¸ºå·¦ä¾§èœå•æ å¼ç»“æ„ï¼Œæ·»åŠ æ›´å¤šå‚æ•°è°ƒæ•´å¦‚çŠ¶æ€æ /æ§åˆ¶é¢æ¿é€æ˜åº¦ã€é¢œè‰²ã€å±è”½ç”¨æˆ·ã€è¿‡æ»¤é€‰é¡¹ã€é‡è¯•æ¬¡æ•°ã€æ»šåŠ¨æ­¥é•¿ã€åˆå§‹å»¶è¿Ÿç­‰ï¼Œæ‰€æœ‰å¯è°ƒå‚æ•°å‡é›†æˆåˆ°é¢æ¿ä¸­ï¼Œæ”¯æŒåŠ¨æ€åº”ç”¨å˜åŒ–ï¼›ç§»é™¤åŒå‡»é¡µé¢è°ƒç”¨setConfigäº‹ä»¶ï¼Œæ‰€æœ‰è®¾ç½®ç»Ÿä¸€é€šè¿‡æ§åˆ¶é¢æ¿ï¼›æ§åˆ¶é¢æ¿é»˜è®¤éšè—ï¼Œé€šè¿‡ç‚¹å‡»æµ®åŠ¨æŒ‰é’®æ‰“å¼€ï¼›ä¿®å¤çŠ¶æ€æ æ–‡å­—éšèƒŒæ™¯é€æ˜é—®é¢˜ï¼Œæ·»åŠ æ–‡å­—é¢œè‰²ä¸äº®åº¦è®¾ç½®ï¼›æ–°å¢ï¼šæš‚åœ/æ¢å¤åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æš‚åœæˆ–æ¢å¤è‡ªåŠ¨ç‚¹èµæµç¨‹ï¼ŒçŠ¶æ€æ æ˜¾ç¤ºæš‚åœçŠ¶æ€ï¼›ä¿®å¤ï¼šçŠ¶æ€æ ç¬¬äºŒè¡Œå‚æ•°ä¸ç­‰å¾…æ—¶é—´æ˜¾ç¤ºé”™è¯¯ï¼Œç¡®ä¿å®æ—¶åŒæ­¥æœ€æ–°å‚æ•°å’Œæ­£ç¡®æ—¶é—´ï¼›ä¼˜åŒ–ï¼šä¿®å¤çŠ¶æ€æ å¤šä½™åˆ†éš”ç¬¦é€»è¾‘ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸ï¼›å…¼å®¹ï¼šå°†æ¨¡æ¿å­—ç¬¦ä¸²æ”¹ä¸ºå­—ç¬¦ä¸²è¿æ¥ï¼Œæé«˜æ—§æµè§ˆå™¨å…¼å®¹æ€§ï¼Œé¿å…æ½œåœ¨è¯­æ³•æŠ¥é”™ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.4ï¼‰ï¼šç¾åŒ–æ§åˆ¶é¢æ¿å’ŒçŠ¶æ€æ çš„UIï¼ˆæ·»åŠ è¿‡æ¸¡åŠ¨ç”»ã€åœ†è§’æŒ‰é’®ã€å“åº”å¼å¸ƒå±€ï¼‰ï¼›ä¿®å¤æ½œåœ¨bugå¦‚æ»šåŠ¨äº‹ä»¶é‡å¤è§¦å‘ç‚¹èµã€æš‚åœæ—¶å®šæ—¶å™¨æœªå®Œå…¨æ¸…ç†ã€cookieå€¼è§£æè¾¹ç¼˜æ¡ˆä¾‹ï¼›ä¼˜åŒ–æ€§èƒ½ï¼ˆå‡å°‘ä¸å¿…è¦çš„setIntervalè°ƒç”¨ã€æ‰¹é‡DOMæ“ä½œï¼‰ï¼›æ·»åŠ æš—é»‘æ¨¡å¼è‡ªåŠ¨é€‚é…é€‰é¡¹ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.5ï¼‰ï¼šä¿®å¤bugï¼šåœ¨ç‚¹èµæˆ–æ»šåŠ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»åŠ¡æ—¶é—´è¶…è¿‡åˆ·æ–°é—´éš”ï¼Œå¯¼è‡´å€’è®¡æ—¶é‡ç½®çš„é—®é¢˜ï¼ˆé€šè¿‡åœ¨ä»»åŠ¡å¼€å§‹æ—¶æ¨è¿ŸnextTimeæ¥é¿å…ä¸­æ–­ï¼‰ï¼›ç¾åŒ–çŠ¶æ€æ ï¼šæ·»åŠ è¿›åº¦æ¡è¡¨ç¤ºå½“å‰ä»»åŠ¡è¿›åº¦ã€ä½¿ç”¨emojiå›¾æ ‡å¢å¼ºè§†è§‰åé¦ˆã€ä¼˜åŒ–å­—ä½“å’Œé—´è·ä»¥æé«˜å¯è¯»æ€§ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.6ï¼‰ï¼šä¿®å¤çŠ¶æ€æ é€»è¾‘é—®é¢˜ï¼šé˜²æ­¢safeLikeé‡å¤è°ƒç”¨å¯¼è‡´nextTimeå¤šæ¬¡æ¨è¿Ÿå’Œå€’è®¡æ—¶è·³åŠ¨ï¼›ä¼˜åŒ–ç‚¹èµé€»è¾‘ï¼Œä»…è°ƒåº¦å®é™…éœ€è¦ç‚¹èµçš„åŠ¨æ€ï¼Œé¿å…ä¸å¿…è¦å»¶è¿Ÿå’Œå¡åœ¨â€œè·³è¿‡â€æ­¥éª¤ï¼›å¦‚æœæ‰€æœ‰åŠ¨æ€è¢«è·³è¿‡ï¼Œç«‹å³å®Œæˆä»»åŠ¡å¹¶æ›´æ–°çŠ¶æ€æ ä¸ºç­‰å¾…åˆ·æ–°ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ— è°“æ—¶é—´æˆ–æ˜¾ç¤ºè·³è¿‡æ¶ˆæ¯ã€‚è´¡çŒ®æ›´æ–°ï¼ˆv2.7ï¼‰ï¼šæ–°å¢æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œè®°å½•ç‚¹èµå†å²å’Œé”™è¯¯åˆ°æ§åˆ¶é¢æ¿çš„æ–°â€œæ—¥å¿—â€æ ‡ç­¾ï¼Œæ”¯æŒæ¸…ç©ºæ—¥å¿—ï¼›æ·»åŠ éšæœºå»¶è¿Ÿé€‰é¡¹ï¼ˆlikeRandomDelayï¼‰ï¼Œä¸ºç‚¹èµå»¶è¿Ÿæ·»åŠ éšæœºæ€§ï¼ˆÂ±éšæœºç§’ï¼‰ä»¥æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œé¿å…è¢«æ£€æµ‹ï¼›ä¼˜åŒ–æ€§èƒ½ï¼šå‡å°‘DOMæŸ¥è¯¢é¢‘ç‡ï¼Œä½¿ç”¨MutationObserverç›‘æ§åŠ¨æ€åŠ è½½å†…å®¹ï¼Œå¹¶åœ¨å˜åŒ–æ—¶è§¦å‘safeLikeï¼›æ·»åŠ æ¯æ—¥ç‚¹èµä¸Šé™ï¼ˆdailyLikeLimitï¼‰ï¼Œé˜²æ­¢è¿‡åº¦ç‚¹èµï¼›çŠ¶æ€æ æ·»åŠ æ—¥å¿—è®¡æ•°å’Œä¸Šé™å‰©ä½™æ˜¾ç¤ºï¼›ä¿®å¤æ½œåœ¨çš„æ»šåŠ¨åŠ¨ç”»å¡é¡¿é—®é¢˜ï¼Œé€šè¿‡è°ƒæ•´smoothScrollToçš„easeå‡½æ•°ä¸ºæ›´å¹³æ»‘çš„cubic-bezierã€‚ï¼‰
// @author       llulun (with contributions)
// @match        *://*.qzone.qq.com/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        unsafeWindow
// ==/UserScript==

(function() {
    'use strict';

    // ä»cookieè·å–é…ç½®ï¼ˆæ‰©å±•ï¼šæ·»åŠ éšæœºå»¶è¿Ÿã€æ¯æ—¥ä¸Šé™ã€æ—¥å¿—å‚æ•°ï¼‰
    let duration = parseInt(getCookie('al-duration')) || 180;
    let refreshDelay = parseInt(getCookie('al-refreshDelay')) || 10;
    let likeDelay = parseInt(getCookie('al-likeDelay')) || 5;
    let likeRandomDelay = parseInt(getCookie('al-likeRandomDelay')) || 2; // æ–°å¢ï¼šéšæœºå»¶è¿ŸèŒƒå›´ï¼ˆÂ±ç§’ï¼‰
    let dailyLikeLimit = parseInt(getCookie('al-dailyLikeLimit')) || 100; // æ–°å¢ï¼šæ¯æ—¥ç‚¹èµä¸Šé™
    let scrollCount = parseInt(getCookie('al-scrollCount')) || 3;
    let blocked = getCookie('al-blocked') ? getCookie('al-blocked').split(',') : [];
    const dict = ['ç‚¹èµ', 'è½¬å‘', 'è¯„è®º'];
    let select = Boolean(getCookie('al-select'));
    let lastRefresh = parseInt(getCookie('al-lastRefresh')) || 0;
    let nextTime = Math.max(Date.now(), lastRefresh + duration * 1000);
    let isScrolling = false;
    let timeout = null;
    let isRunning = false;
    let isPaused = false;
    let testMode = false;
    let uin = unsafeWindow.g_iUin || unsafeWindow.g_iLoginUin || '';
    let retryCount = 0;
    let maxRetries = parseInt(getCookie('al-maxRetries')) || 3;
    let currentTask = '';
    let taskStartTime = 0;
    let taskDuration = 0;
    let nextTask = '';
    let statusOpacity = parseFloat(getCookie('al-statusOpacity')) || 0.8;
    let statusBgColor = getCookie('al-statusBgColor') || 'linear-gradient(to right, #333, #222)';
    let menuOpacity = parseFloat(getCookie('al-menuOpacity')) || 0.9;
    let menuBgColor = getCookie('al-menuBgColor') || 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
    let scrollStepPercent = parseFloat(getCookie('al-scrollStepPercent')) || 0.9;
    let initialDelay = parseInt(getCookie('al-initialDelay')) || 3000;
    let statusTextColor = getCookie('al-statusTextColor') || (statusBgColor.includes('#333') || statusBgColor.includes('#222') ? '#ddd' : '#333');
    let statusTextBrightness = parseFloat(getCookie('al-statusTextBrightness')) || 1.0;
    let darkModeAuto = Boolean(getCookie('al-darkModeAuto'));
    let dailyLikes = parseInt(getCookie('al-dailyLikes')) || 0; // æ–°å¢ï¼šå½“å‰æ¯æ—¥ç‚¹èµè®¡æ•°
    let lastLikeDate = getCookie('al-lastLikeDate') || new Date().toDateString(); // æ–°å¢ï¼šä¸Šæ¬¡ç‚¹èµæ—¥æœŸ
    let logs = getCookie('al-logs') ? JSON.parse(getCookie('al-logs')) : []; // æ–°å¢ï¼šæ—¥å¿—æ•°ç»„

    // Cookie æ“ä½œå‡½æ•°ï¼ˆä¼˜åŒ–ï¼šæ·»åŠ è¾¹ç¼˜æ¡ˆä¾‹å¤„ç†ï¼Œå¦‚ç©ºå€¼æˆ–æ— æ•ˆæ•°å­—ï¼‰
    function getCookie(name) {
        let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    function setCookie(name, value, maxAge) {
        let expires = "";
        if (maxAge) {
            let date = new Date();
            date.setTime(date.getTime() + maxAge * 1000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // æ–°å¢ï¼šæ—¥å¿—è®°å½•å‡½æ•°
    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleString();
        logs.push({ timestamp, type, message });
        if (logs.length > 100) logs.shift(); // é™åˆ¶æ—¥å¿—æ•°é‡
        setCookie('al-logs', JSON.stringify(logs), Number.MAX_SAFE_INTEGER);
        console.log(`[${type.toUpperCase()}] ${timestamp}: ${message}`);
    }

    // åˆ›å»ºèœå•æ ï¼ˆæ‰©å±•ï¼šæ·»åŠ â€œæ—¥å¿—â€æ ‡ç­¾å’Œç›¸å…³UIï¼‰
    function createMenu() {
        let menu = document.createElement('div');
        menu.id = 'al-menu';
        menu.style.position = 'fixed';
        menu.style.top = '50%';
        menu.style.left = '50%';
        menu.style.transform = 'translate(-50%, -50%)';
        menu.style.width = '600px';
        menu.style.height = '400px';
        menu.style.overflow = 'auto';
        menu.style.background = menuBgColor;
        menu.style.border = '1px solid #ccc';
        menu.style.borderRadius = '12px';
        menu.style.padding = '20px';
        menu.style.zIndex = '10002';
        menu.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
        menu.style.fontFamily = 'Arial, sans-serif';
        menu.style.opacity = menuOpacity;
        menu.style.display = 'none';
        menu.style.pointerEvents = 'auto';
        menu.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

        let sidebar = document.createElement('div');
        sidebar.style.width = '150px';
        sidebar.style.borderRight = '1px solid #ddd';
        sidebar.style.paddingRight = '10px';
        sidebar.innerHTML = '<h4 style="margin: 0 0 10px;">è®¾ç½®åˆ†ç±»</h4><ul style="list-style: none; padding: 0;"><li><button id="al-tab-core" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">æ ¸å¿ƒå‚æ•°</button></li><li><button id="al-tab-ui" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">ç•Œé¢è‡ªå®šä¹‰</button></li><li><button id="al-tab-adv" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">é«˜çº§å‚æ•°</button></li><li><button id="al-tab-logs" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">æ—¥å¿—è®°å½•</button></li></ul>';
        menu.appendChild(sidebar);

        let content = document.createElement('div');
        content.id = 'al-content';
        content.style.flex = '1';
        content.style.paddingLeft = '20px';
        content.style.transition = 'opacity 0.3s ease';
        menu.appendChild(content);

        let footer = document.createElement('div');
        footer.style.marginTop = '20px';
        footer.style.textAlign = 'center';
        footer.innerHTML = '<button id="al-save" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">ä¿å­˜å¹¶åº”ç”¨</button><button id="al-pause" style="background: #FF9800; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">' + (isPaused ? 'æ¢å¤' : 'æš‚åœ') + '</button><button id="al-test" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">æµ‹è¯•æ‰§è¡Œ</button><button id="al-close" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: background 0.2s;">å…³é—­</button>';
        menu.appendChild(footer);

        document.body.appendChild(menu);

        function showTab(tab) {
            content.style.opacity = '0';
            setTimeout(() => {
                content.innerHTML = '';
                if (tab === 'core') {
                    content.innerHTML = '<h3>æ ¸å¿ƒå‚æ•°</h3><label style="display: block; margin-bottom: 10px;">åˆ·æ–°é¢‘ç‡ (ç§’): <input type="number" id="al-dur" value="' + duration + '" min="30" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">åˆ·æ–°å»¶è¿Ÿ (ç§’): <input type="number" id="al-rdelay" value="' + refreshDelay + '" min="5" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">ç‚¹èµå»¶è¿Ÿ (ç§’): <input type="number" id="al-ldelay" value="' + likeDelay + '" min="3" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">éšæœºå»¶è¿ŸèŒƒå›´ (Â±ç§’): <input type="number" id="al-likeRandomDelay" value="' + likeRandomDelay + '" min="0" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">æ¯æ—¥ç‚¹èµä¸Šé™: <input type="number" id="al-dailyLikeLimit" value="' + dailyLikeLimit + '" min="50" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">ä¸‹æ»‘åŠ¨æ€æ•°: <input type="number" id="al-scount" value="' + scrollCount + '" min="1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">å±è”½ç”¨æˆ· (QQå·,é€—å·åˆ†éš”): <input type="text" id="al-blocked" value="' + blocked.join(',') + '" style="width: 200px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;"><input type="checkbox" id="al-select" ' + (select ? 'checked' : '') + '> ä¸ç‚¹èµæ¸¸æˆè½¬å‘å†…å®¹</label>';
                } else if (tab === 'ui') {
                    content.innerHTML = '<h3>ç•Œé¢è‡ªå®šä¹‰</h3><label style="display: block; margin-bottom: 10px;">çŠ¶æ€æ é€æ˜åº¦ (0.1-1): <input type="number" id="al-statusOpacity" value="' + statusOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">çŠ¶æ€æ èƒŒæ™¯: <select id="al-statusBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to right, #333, #222)" ' + (statusBgColor === 'linear-gradient(to right, #333, #222)' ? 'selected' : '') + '>é»‘è‰²æ¸å˜</option><option value="linear-gradient(to right, #f0f0f0, #e0e0e0)" ' + (statusBgColor === 'linear-gradient(to right, #f0f0f0, #e0e0e0)' ? 'selected' : '') + '>ç™½è‰²æ¸å˜</option><option value="linear-gradient(to right, #2196F3, #1976D2)" ' + (statusBgColor === 'linear-gradient(to right, #2196F3, #1976D2)' ? 'selected' : '') + '>è“è‰²æ¸å˜</option><option value="linear-gradient(to right, #4CAF50, #388E3C)" ' + (statusBgColor === 'linear-gradient(to right, #4CAF50, #388E3C)' ? 'selected' : '') + '>ç»¿è‰²æ¸å˜</option></select></label><label style="display: block; margin-bottom: 10px;">çŠ¶æ€æ æ–‡å­—é¢œè‰²: <select id="al-statusTextColor" style="width: 200px; margin-left: 10px;"><option value="auto" ' + (statusTextColor === 'auto' ? 'selected' : '') + '>è‡ªåŠ¨</option><option value="#fff" ' + (statusTextColor === '#fff' ? 'selected' : '') + '>ç™½è‰²</option><option value="#000" ' + (statusTextColor === '#000' ? 'selected' : '') + '>é»‘è‰²</option><option value="#ddd" ' + (statusTextColor === '#ddd' ? 'selected' : '') + '>æµ…ç°</option></select></label><label style="display: block; margin-bottom: 10px;">çŠ¶æ€æ æ–‡å­—äº®åº¦ (0.5-1.5): <input type="number" id="al-statusTextBrightness" value="' + statusTextBrightness + '" min="0.5" max="1.5" step="0.1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;"><input type="checkbox" id="al-darkModeAuto" ' + (darkModeAuto ? 'checked' : '') + '> è‡ªåŠ¨é€‚é…æš—é»‘æ¨¡å¼</label><label style="display: block; margin-bottom: 10px;">æ§åˆ¶é¢æ¿é€æ˜åº¦ (0.1-1): <input type="number" id="al-menuOpacity" value="' + menuOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">æ§åˆ¶é¢æ¿èƒŒæ™¯: <select id="al-menuBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to bottom, #ffffff, #f0f0f0)" ' + (menuBgColor === 'linear-gradient(to bottom, #ffffff, #f0f0f0)' ? 'selected' : '') + '>ç™½è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #333, #222)" ' + (menuBgColor === 'linear-gradient(to bottom, #333, #222)' ? 'selected' : '') + '>é»‘è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #2196F3, #1976D2)" ' + (menuBgColor === 'linear-gradient(to bottom, #2196F3, #1976D2)' ? 'selected' : '') + '>è“è‰²æ¸å˜</option><option value="linear-gradient(to bottom, #4CAF50, #388E3C)" ' + (menuBgColor === 'linear-gradient(to bottom, #4CAF50, #388E3C)' ? 'selected' : '') + '>ç»¿è‰²æ¸å˜</option></select></label>';
                } else if (tab === 'adv') {
                    content.innerHTML = '<h3>é«˜çº§å‚æ•°</h3><label style="display: block; margin-bottom: 10px;">æœ€å¤§é‡è¯•æ¬¡æ•°: <input type="number" id="al-maxRetries" value="' + maxRetries + '" min="1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">æ»šåŠ¨æ­¥é•¿ç™¾åˆ†æ¯” (0.1-1): <input type="number" id="al-scrollStepPercent" value="' + scrollStepPercent + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label><label style="display: block; margin-bottom: 10px;">åˆå§‹å»¶è¿Ÿ (æ¯«ç§’): <input type="number" id="al-initialDelay" value="' + initialDelay + '" min="1000" style="width: 80px; margin-left: 10px;"></label>';
                } else if (tab === 'logs') {
                    let logHtml = '<h3>æ—¥å¿—è®°å½• (' + logs.length + ')</h3><button id="al-clear-logs" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; transition: background 0.2s;">æ¸…ç©ºæ—¥å¿—</button><div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">';
                    logs.forEach(log => {
                        let color = log.type === 'error' ? 'red' : (log.type === 'warn' ? 'orange' : 'green');
                        logHtml += '<p style="margin: 5px 0; color: ' + color + ';">[' + log.timestamp + '] ' + log.type.toUpperCase() + ': ' + log.message + '</p>';
                    });
                    logHtml += '</div>';
                    content.innerHTML = logHtml;
                    setTimeout(() => {
                        document.getElementById('al-clear-logs').addEventListener('click', () => {
                            logs = [];
                            setCookie('al-logs', JSON.stringify(logs), Number.MAX_SAFE_INTEGER);
                            showTab('logs');
                        });
                    }, 0);
                }
                content.style.opacity = '1';
            }, 300);
        }

        showTab('core');

        document.getElementById('al-tab-core').addEventListener('click', function() { showTab('core'); });
        document.getElementById('al-tab-ui').addEventListener('click', function() { showTab('ui'); });
        document.getElementById('al-tab-adv').addEventListener('click', function() { showTab('adv'); });
        document.getElementById('al-tab-logs').addEventListener('click', function() { showTab('logs'); });

        document.getElementById('al-save').addEventListener('click', function() {
            duration = parseInt(document.getElementById('al-dur') ? document.getElementById('al-dur').value : 180, 10) || 180;
            refreshDelay = parseInt(document.getElementById('al-rdelay') ? document.getElementById('al-rdelay').value : 10, 10) || 10;
            likeDelay = parseInt(document.getElementById('al-ldelay') ? document.getElementById('al-ldelay').value : 5, 10) || 5;
            likeRandomDelay = parseInt(document.getElementById('al-likeRandomDelay') ? document.getElementById('al-likeRandomDelay').value : 2, 10) || 2;
            dailyLikeLimit = parseInt(document.getElementById('al-dailyLikeLimit') ? document.getElementById('al-dailyLikeLimit').value : 100, 10) || 100;
            scrollCount = parseInt(document.getElementById('al-scount') ? document.getElementById('al-scount').value : 3, 10) || 3;
            let blk = document.getElementById('al-blocked') ? document.getElementById('al-blocked').value.replace(/\s/g, '') : '';
            blocked = blk ? blk.split(',').filter(Boolean) : [];
            select = document.getElementById('al-select') ? document.getElementById('al-select').checked : false;
            darkModeAuto = document.getElementById('al-darkModeAuto') ? document.getElementById('al-darkModeAuto').checked : false;

            statusOpacity = parseFloat(document.getElementById('al-statusOpacity') ? document.getElementById('al-statusOpacity').value : 0.8) || 0.8;
            statusBgColor = document.getElementById('al-statusBgColor') ? document.getElementById('al-statusBgColor').value : 'linear-gradient(to right, #333, #222)';
            statusTextColor = document.getElementById('al-statusTextColor') ? document.getElementById('al-statusTextColor').value : (statusBgColor.includes('#333') || statusBgColor.includes('#222') ? '#ddd' : '#333');
            statusTextBrightness = parseFloat(document.getElementById('al-statusTextBrightness') ? document.getElementById('al-statusTextBrightness').value : 1.0) || 1.0;
            menuOpacity = parseFloat(document.getElementById('al-menuOpacity') ? document.getElementById('al-menuOpacity').value : 0.9) || 0.9;
            menuBgColor = document.getElementById('al-menuBgColor') ? document.getElementById('al-menuBgColor').value : 'linear-gradient(to bottom, #ffffff, #f0f0f0)';

            maxRetries = parseInt(document.getElementById('al-maxRetries') ? document.getElementById('al-maxRetries').value : 3, 10) || 3;
            scrollStepPercent = parseFloat(document.getElementById('al-scrollStepPercent') ? document.getElementById('al-scrollStepPercent').value : 0.9) || 0.9;
            initialDelay = parseInt(document.getElementById('al-initialDelay') ? document.getElementById('al-initialDelay').value : 3000, 10) || 3000;

            const max = Number.MAX_SAFE_INTEGER;
            setCookie('al-duration', duration, max);
            setCookie('al-refreshDelay', refreshDelay, max);
            setCookie('al-likeDelay', likeDelay, max);
            setCookie('al-likeRandomDelay', likeRandomDelay, max);
            setCookie('al-dailyLikeLimit', dailyLikeLimit, max);
            setCookie('al-scrollCount', scrollCount, max);
            setCookie('al-blocked', blocked.join(','), max);
            setCookie('al-select', select ? 'true' : '', max);
            setCookie('al-darkModeAuto', darkModeAuto ? 'true' : '', max);
            setCookie('al-statusOpacity', statusOpacity, max);
            setCookie('al-statusBgColor', statusBgColor, max);
            setCookie('al-statusTextColor', statusTextColor, max);
            setCookie('al-statusTextBrightness', statusTextBrightness, max);
            setCookie('al-menuOpacity', menuOpacity, max);
            setCookie('al-menuBgColor', menuBgColor, max);
            setCookie('al-maxRetries', maxRetries, max);
            setCookie('al-scrollStepPercent', scrollStepPercent, max);
            setCookie('al-initialDelay', initialDelay, max);

            nextTime = Date.now() + duration * 1000;
            alert('è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨ï¼éƒ¨åˆ†å˜åŒ–å¯èƒ½éœ€åˆ·æ–°é¡µé¢ç”Ÿæ•ˆã€‚');

            let statusBar = document.getElementById('al-status-bar');
            if (statusBar) {
                statusBar.style.opacity = statusOpacity;
                statusBar.style.background = statusBgColor;
                statusBar.style.color = statusTextColor;
                statusBar.style.filter = 'brightness(' + statusTextBrightness + ')';
            }
            menu.style.opacity = menuOpacity;
            menu.style.background = menuBgColor;

            applyDarkMode();
            updateStatusBar();
        });

        document.getElementById('al-pause').addEventListener('click', function() {
            isPaused = !isPaused;
            this.innerText = isPaused ? 'æ¢å¤' : 'æš‚åœ';
            if (isPaused) {
                clearAllTimeouts();
                updateStatusBar('è„šæœ¬å·²æš‚åœ');
                addLog('è„šæœ¬å·²æš‚åœ', 'warn');
            } else {
                nextTime = Date.now() + duration * 1000;
                updateStatusBar('è„šæœ¬å·²æ¢å¤è¿è¡Œ');
                addLog('è„šæœ¬å·²æ¢å¤è¿è¡Œ', 'info');
                if (!isRunning) {
                    executeWorkflow();
                }
            }
        });

        document.getElementById('al-test').addEventListener('click', function() {
            if (isPaused) {
                alert('è„šæœ¬å½“å‰å¤„äºæš‚åœçŠ¶æ€ï¼Œè¯·å…ˆæ¢å¤è¿è¡Œï¼');
                return;
            }
            testMode = true;
            executeWorkflow();
            testMode = false;
        });

        document.getElementById('al-close').addEventListener('click', function() {
            menu.style.display = 'none';
        });

        let toggleBtn = document.createElement('button');
        toggleBtn.innerText = 'AL Menu';
        toggleBtn.style.position = 'fixed';
        toggleBtn.style.top = '20px';
        toggleBtn.style.right = '10px';
        toggleBtn.style.background = '#2196F3';
        toggleBtn.style.color = 'white';
        toggleBtn.style.border = 'none';
        toggleBtn.style.padding = '8px 12px';
        toggleBtn.style.borderRadius = '4px';
        toggleBtn.style.zIndex = '10003';
        toggleBtn.style.cursor = 'pointer';
        toggleBtn.style.opacity = '0.85';
        toggleBtn.style.transition = 'opacity 0.2s, transform 0.2s';
        toggleBtn.addEventListener('mouseover', () => { toggleBtn.style.opacity = '1'; toggleBtn.style.transform = 'scale(1.05)'; });
        toggleBtn.addEventListener('mouseout', () => { toggleBtn.style.opacity = '0.85'; toggleBtn.style.transform = 'scale(1)'; });
        toggleBtn.addEventListener('click', function() {
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            if (menu.style.display === 'block') {
                showTab('core');
            }
        });

        document.body.appendChild(toggleBtn);
    }

    // è‡ªåŠ¨æš—é»‘æ¨¡å¼é€‚é…
    function applyDarkMode() {
        if (!darkModeAuto) return;
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            statusBgColor = 'linear-gradient(to right, #333, #222)';
            statusTextColor = '#ddd';
            menuBgColor = 'linear-gradient(to bottom, #333, #222)';
            document.getElementById('al-status-bar').style.background = statusBgColor;
            document.getElementById('al-status-bar').style.color = statusTextColor;
            document.getElementById('al-menu').style.background = menuBgColor;
        } else {
            statusBgColor = 'linear-gradient(to right, #f0f0f0, #e0e0e0)';
            statusTextColor = '#333';
            menuBgColor = 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
            document.getElementById('al-status-bar').style.background = statusBgColor;
            document.getElementById('al-status-bar').style.color = statusTextColor;
            document.getElementById('al-menu').style.background = menuBgColor;
        }
    }

    // åˆ›å»ºçŠ¶æ€æ ï¼ˆæ‰©å±•ï¼šæ·»åŠ æ—¥å¿—è®¡æ•°å’Œæ¯æ—¥å‰©ä½™ç‚¹èµæ˜¾ç¤ºï¼‰
    function createStatusBar() {
        let statusBar = document.createElement('div');
        statusBar.id = 'al-status-bar';
        statusBar.style.position = 'fixed';
        statusBar.style.top = '0';
        statusBar.style.left = '0';
        statusBar.style.width = '100%';
        statusBar.style.background = statusBgColor;
        statusBar.style.padding = '12px 24px';
        statusBar.style.zIndex = '10001';
        statusBar.style.fontSize = '15px';
        statusBar.style.lineHeight = '1.6';
        statusBar.style.textAlign = 'center';
        statusBar.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
        statusBar.style.borderRadius = '0 0 10px 10px';
        statusBar.style.fontFamily = 'Arial, sans-serif';
        statusBar.style.color = statusTextColor;
        statusBar.style.opacity = statusOpacity;
        statusBar.style.filter = 'brightness(' + statusTextBrightness + ')';
        statusBar.style.pointerEvents = 'none';
        statusBar.style.transition = 'opacity 0.3s ease, background 0.3s ease';
        document.body.appendChild(statusBar);

        setInterval(updateStatusBar, 1000);
        updateStatusBar();
    }

    // æ›´æ–°çŠ¶æ€æ å‡½æ•°ï¼ˆæ‰©å±•ï¼šæ·»åŠ æ—¥å¿—è®¡æ•°å’Œæ¯æ—¥å‰©ä½™ï¼‰
    function updateStatusBar(message) {
        // æ£€æŸ¥æ¯æ—¥è®¡æ•°é‡ç½®
        const currentDate = new Date().toDateString();
        if (currentDate !== lastLikeDate) {
            dailyLikes = 0;
            lastLikeDate = currentDate;
            setCookie('al-dailyLikes', dailyLikes, Number.MAX_SAFE_INTEGER);
            setCookie('al-lastLikeDate', lastLikeDate, Number.MAX_SAFE_INTEGER);
            addLog('æ¯æ—¥ç‚¹èµè®¡æ•°é‡ç½®', 'info');
        }

        // é‡æ–°ä»cookieåŒæ­¥å‚æ•°
        duration = parseInt(getCookie('al-duration')) || duration;
        refreshDelay = parseInt(getCookie('al-refreshDelay')) || refreshDelay;
        likeDelay = parseInt(getCookie('al-likeDelay')) || likeDelay;
        scrollCount = parseInt(getCookie('al-scrollCount')) || scrollCount;

        let statusBar = document.getElementById('al-status-bar');
        if (!statusBar) return;

        message = message || '';

        let lastRefreshTime = new Date(lastRefresh).toLocaleTimeString();
        let nextRefreshTime = new Date(nextTime).toLocaleTimeString();
        let remainingSeconds = Math.max(0, Math.ceil((nextTime - Date.now()) / 1000));
        let remainingColor = remainingSeconds < 30 ? 'red' : 'green';
        let scrollingStatus = isScrolling ? '<span style="color: lightblue; font-weight: bold;">æ»šåŠ¨ä¸­ï¼ˆåŠ¨æ€åŠ è½½ä¸­ï¼‰ ğŸ”„</span>' : '<span style="color: gray;">é™æ­¢ï¼ˆæ— æ»šåŠ¨ï¼‰ â¹ï¸</span>';
        let currentStep = message || (isPaused ? '<span style="color: yellow; font-weight: bold;">å·²æš‚åœ â¸ï¸</span>' : (isRunning ? '<span style="color: orange; font-weight: bold;">æ‰§è¡Œä¸­ï¼š' + currentTask + ' ğŸš€</span>' : '<span style="color: lightgreen; font-weight: bold;">ç­‰å¾…ä¸‹æ¬¡åˆ·æ–° â°</span>'));
        let taskRemaining = taskDuration > 0 ? Math.max(0, Math.ceil((taskStartTime + taskDuration * 1000 - Date.now()) / 1000)) : 0;
        let taskProgressPercent = taskDuration > 0 ? Math.round((1 - (taskRemaining / taskDuration)) * 100) : 0;
        let taskProgress = taskRemaining > 0 ? '<span style="color: violet;">å½“å‰ä»»åŠ¡å‰©ä½™ï¼š' + taskRemaining + 'ç§’ (' + taskProgressPercent + '%)ï¼Œå®Œæˆåæ‰§è¡Œï¼š' + nextTask + ' ğŸ“Š</span>' : '';
        let retryInfo = retryCount > 0 ? '<span style="color: brown;">é‡è¯•æ¬¡æ•°ï¼š' + retryCount + '/' + maxRetries + 'ï¼ˆè‹¥å¤±è´¥å°†é‡ç½®ï¼‰ âš ï¸</span>' : '';
        let logCount = '<span style="color: purple;">æ—¥å¿—æ•°é‡ï¼š' + logs.length + ' ğŸ“</span>';
        let dailyRemaining = dailyLikeLimit - dailyLikes;
        let dailyInfo = '<span style="color: ' + (dailyRemaining <= 10 ? 'red' : 'green') + ';">ä»Šæ—¥å‰©ä½™ç‚¹èµï¼š' + dailyRemaining + '/' + dailyLikeLimit + ' â¤ï¸</span>';

        let strongColor = statusTextColor === '#ddd' || statusTextColor === '#fff' ? '#ccc' : '#555';

        let infoParts = [];
        if (taskProgress) infoParts.push(taskProgress);
        if (retryInfo) infoParts.push(retryInfo);
        if (logCount) infoParts.push(logCount);
        if (dailyInfo) infoParts.push(dailyInfo);
        let infoSection = infoParts.length > 0 ? infoParts.join(' | ') + ' | ' : '';

        let html = '<div style="margin-bottom: 8px; font-weight: bold;">' +
            'ä¸Šæ¬¡åˆ·æ–°: <strong style="color: ' + strongColor + ';">' + lastRefreshTime + ' â±ï¸</strong> | ' +
            'ä¸‹æ¬¡åˆ·æ–°: <strong style="color: ' + strongColor + ';">' + nextRefreshTime + '</strong> | ' +
            'å‰©ä½™æ—¶é—´: <span style="color: ' + remainingColor + '; font-weight: bold;">' + remainingSeconds + ' ç§’</span> | ' +
            'æ»šåŠ¨çŠ¶æ€: ' + scrollingStatus + ' | ' +
            'å½“å‰æ­¥éª¤: ' + currentStep +
            '</div><div style="font-size: 14px;">' +
            infoSection +
            'åˆ·æ–°é—´éš”: <strong style="color: ' + strongColor + ';">' + duration + ' ç§’</strong> | ' +
            'å»¶è¿Ÿè®¾ç½®: åˆ·æ–°<strong style="color: ' + strongColor + ';">' + refreshDelay + 's</strong> / ç‚¹èµ<strong style="color: ' + strongColor + ';">' + likeDelay + 's</strong> | ' +
            'ä¸‹æ»‘åŠ¨æ€: <strong style="color: ' + strongColor + ';">' + scrollCount + ' ä¸ª</strong> | ' +
            'æ•´ä½“çŠ¶æ€: <span style="color: ' + (isPaused ? 'yellow' : (isRunning ? 'orange' : 'lightgreen')) + ';">' + (isPaused ? 'æš‚åœï¼ˆå¯æ“ä½œèœå•ï¼‰' : (isRunning ? 'å¿™ç¢Œï¼ˆè¯·å‹¿å¹²æ‰°ï¼‰' : 'ç©ºé—²ï¼ˆå¯æ“ä½œèœå•ï¼‰')) + '</span>' +
            '</div>';
        statusBar.innerHTML = html;
    }

    // ç§»é™¤â€œä¸æˆ‘ç›¸å…³â€èœå•å…ƒç´ 
    function removeMeRelatedMenu() {
        let meTab = document.getElementById('tab_menu_me') || document.querySelector('li[type="me"]') || document.querySelector('#feed_tab_my');
        if (meTab) {
            meTab.style.display = 'none';
            console.log('å·²ç§»é™¤â€œä¸æˆ‘ç›¸å…³â€èœå•å…ƒç´ ');
            addLog('ç§»é™¤â€œä¸æˆ‘ç›¸å…³â€èœå•å…ƒç´ ', 'info');
        } else {
            console.log('æœªæ‰¾åˆ°â€œä¸æˆ‘ç›¸å…³â€èœå•å…ƒç´ ');
            addLog('æœªæ‰¾åˆ°â€œä¸æˆ‘ç›¸å…³â€èœå•å…ƒç´ ', 'warn');
        }
    }

    // æ£€æµ‹æ˜¯å¦åœ¨å¥½å‹åŠ¨æ€é¡µé¢
    function isInFriendFeedPage() {
        const hasLikeButtons = document.querySelectorAll('.qz_like_btn_v3').length > 0;
        console.log('æ£€æµ‹ç‚¹èµå…ƒç´ :', hasLikeButtons ? 'å­˜åœ¨ï¼ˆåœ¨å¥½å‹åŠ¨æ€ï¼‰' : 'ä¸å­˜åœ¨ï¼ˆä¸åœ¨å¥½å‹åŠ¨æ€ï¼‰');
        addLog('æ£€æµ‹ç‚¹èµå…ƒç´ : ' + (hasLikeButtons ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'), 'info');
        return hasLikeButtons;
    }

    // è¿›å…¥â€œå¥½å‹åŠ¨æ€â€é¡µé¢
    function goToFriendFeed() {
        currentTask = 'åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€é¡µé¢';
        taskStartTime = Date.now();
        taskDuration = 5;
        nextTask = 'åˆ·æ–°é¡µé¢å¹¶é‡è¯•æµç¨‹';
        updateStatusBar('ç‚¹èµå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€é¡µé¢...');
        addLog('åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€é¡µé¢', 'info');
        console.log('åˆ‡æ¢åˆ°å¥½å‹åŠ¨æ€ï¼ŒUIN:', uin);

        let friendTab = document.getElementById('tab_menu_friend') || document.querySelector('li[type="friend"] a') || document.querySelector('.feed-control-tab a:not(.item-on)');
        if (friendTab) {
            friendTab.click();
            console.log('ç‚¹å‡»å·¦ä¾§èœå•æ â€œå¥½å‹åŠ¨æ€â€tab');
            addLog('ç‚¹å‡»â€œå¥½å‹åŠ¨æ€â€tab', 'info');
        } else if (uin) {
            location.href = 'https://user.qzone.qq.com/' + uin + '/infocenter';
            console.log('ç›´æ¥å¯¼èˆªåˆ°infocenter');
            addLog('å¯¼èˆªåˆ°infocenter', 'info');
        } else {
            refresh();
            console.log('æ— tabå¯ç”¨ï¼Œåˆ·æ–°é¡µé¢');
            addLog('æ— tabå¯ç”¨ï¼Œåˆ·æ–°é¡µé¢', 'warn');
        }
    }

    // å®‰å…¨ç‚¹èµå‡½æ•°ï¼ˆä¼˜åŒ–ï¼šæ·»åŠ éšæœºå»¶è¿Ÿã€æ¯æ—¥ä¸Šé™æ£€æŸ¥ã€ä½¿ç”¨MutationObserverï¼‰
    let likeDebounce = null;
    let observer = null;
    function safeLike() {
        if (isPaused) {
            updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡ç‚¹èµ');
            addLog('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡ç‚¹èµ', 'warn');
            return;
        }
        if (currentTask === 'æ‰§è¡Œå®‰å…¨ç‚¹èµ') {
            console.log('ç‚¹èµä»»åŠ¡å·²åœ¨æ‰§è¡Œï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
            addLog('ç‚¹èµä»»åŠ¡å·²åœ¨æ‰§è¡Œï¼Œè·³è¿‡é‡å¤è°ƒç”¨', 'warn');
            return;
        }
        if (likeDebounce) clearTimeout(likeDebounce);
        likeDebounce = setTimeout(() => {
            currentTask = 'æ‰§è¡Œå®‰å…¨ç‚¹èµ';
            taskStartTime = Date.now();
            const btns = document.querySelectorAll('.qz_like_btn_v3');
            const contents = document.querySelectorAll('.f-info');
            const users = document.querySelectorAll('.f-name');
            let toLike = [];
            let skipped = 0;

            if (dailyLikes >= dailyLikeLimit) {
                updateStatusBar('å·²è¾¾åˆ°æ¯æ—¥ç‚¹èµä¸Šé™ï¼Œè·³è¿‡ç‚¹èµ');
                addLog('å·²è¾¾åˆ°æ¯æ—¥ç‚¹èµä¸Šé™', 'warn');
                currentTask = '';
                return;
            }

            Array.from(btns).forEach(function(btn, index) {
                if (dailyLikes >= dailyLikeLimit) return; // ä¸­é€”æ£€æŸ¥ä¸Šé™

                const content = contents[index] ? contents[index].innerHTML : '';
                const user = users[index] && users[index].getAttribute('link') ? users[index].getAttribute('link').replace('nameCard_', '') : '';

                if (btn.classList.contains('item-on') || blocked.indexOf(user) > -1) {
                    console.log('è·³è¿‡å·²èµæˆ–å±è”½åŠ¨æ€ ' + (index + 1));
                    skipped++;
                    return;
                }

                let isGameForward = false;
                if (select) {
                    for (let j = 0; j < dict.length; j++) {
                        if (content.includes(dict[j])) {
                            isGameForward = true;
                            break;
                        }
                    }
                }

                if (isGameForward) {
                    console.log('è·³è¿‡æ¸¸æˆè½¬å‘åŠ¨æ€ ' + (index + 1));
                    skipped++;
                    return;
                }

                toLike.push({btn, content, index});
            });

            let effectiveLikes = Math.min(toLike.length, dailyLikeLimit - dailyLikes);
            taskDuration = effectiveLikes * likeDelay + 1;
            nextTask = 'æ¨¡æ‹Ÿæ»šåŠ¨æˆ–ç­‰å¾…åˆ·æ–°';
            nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
            updateStatusBar('å¼€å§‹å®‰å…¨ç‚¹èµ... (éœ€ç‚¹èµ: ' + effectiveLikes + ', è·³è¿‡: ' + skipped + ')');
            addLog('å¼€å§‹ç‚¹èµ: éœ€ç‚¹èµ ' + effectiveLikes + ', è·³è¿‡ ' + skipped, 'info');

            if (effectiveLikes === 0) {
                currentTask = '';
                taskDuration = 0;
                updateStatusBar('æ‰€æœ‰åŠ¨æ€å·²èµæˆ–è·³è¿‡ï¼Œç­‰å¾…ä¸‹æ¬¡åˆ·æ–°');
                addLog('æ‰€æœ‰åŠ¨æ€å·²èµæˆ–è·³è¿‡', 'info');
                return;
            }

            toLike.slice(0, effectiveLikes).forEach(function(item, idx) {
                let randomOffset = Math.floor(Math.random() * (likeRandomDelay * 2 + 1)) - likeRandomDelay;
                let delay = (idx * likeDelay + randomOffset) * 1000;
                setTimeout(function() {
                    if (isPaused || dailyLikes >= dailyLikeLimit) {
                        updateStatusBar('è„šæœ¬å·²æš‚åœæˆ–è¾¾åˆ°ä¸Šé™ï¼Œåœæ­¢ç‚¹èµ');
                        addLog('æš‚åœæˆ–ä¸Šé™ï¼Œåœæ­¢ç‚¹èµ', 'warn');
                        return;
                    }
                    item.btn.click();
                    console.log('Liked: ' + item.content);
                    dailyLikes++;
                    setCookie('al-dailyLikes', dailyLikes, Number.MAX_SAFE_INTEGER);
                    updateStatusBar('ç‚¹èµåŠ¨æ€ ' + (item.index + 1) + ' / ' + btns.length);
                    addLog('ç‚¹èµåŠ¨æ€ ' + (item.index + 1) + ': ' + item.content.substring(0, 50) + '...', 'info');
                }, delay);
            });

            setTimeout(function() {
                if (isPaused) return;
                currentTask = '';
                taskDuration = 0;
                updateStatusBar('ç‚¹èµå®Œæˆï¼Œç­‰å¾…ä¸‹æ¬¡åˆ·æ–°');
                addLog('ç‚¹èµå®Œæˆ', 'info');
            }, taskDuration * 1000);

            // è®¾ç½®MutationObserverç›‘æ§æ–°å†…å®¹åŠ è½½
            if (!observer) {
                observer = new MutationObserver(() => {
                    addLog('æ£€æµ‹åˆ°åŠ¨æ€å†…å®¹å˜åŒ–ï¼Œè§¦å‘ç‚¹èµæ£€æŸ¥', 'info');
                    safeLike();
                });
                observer.observe(document.body, { childList: true, subtree: true });
            }
        }, 500);
    }

    // æ¨¡æ‹Ÿä¸‹æ»‘åŠ¨æ€
    function simulateScroll() {
        if (isPaused) {
            updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡æ»šåŠ¨');
            addLog('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡æ»šåŠ¨', 'warn');
            return;
        }
        currentTask = 'æ¨¡æ‹Ÿä¸‹æ»‘åŠ¨æ€';
        taskStartTime = Date.now();
        taskDuration = scrollCount * 3 + 3;
        nextTask = 'å›åˆ°é¡¶éƒ¨å¹¶ç­‰å¾…';
        nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
        updateStatusBar('æ¨¡æ‹Ÿä¸‹æ»‘åŠ¨æ€...');
        addLog('å¼€å§‹æ¨¡æ‹Ÿæ»šåŠ¨', 'info');
        let scrollStep = window.innerHeight * scrollStepPercent;

        Array.from({length: scrollCount}).forEach(function(_, i) {
            var stepIndex = i;
            var targetScroll = (stepIndex + 1) * scrollStep;
            setTimeout(function() {
                if (isPaused) {
                    updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œåœæ­¢æ»šåŠ¨');
                    addLog('è„šæœ¬å·²æš‚åœï¼Œåœæ­¢æ»šåŠ¨', 'warn');
                    return;
                }
                smoothScrollTo(targetScroll, 500);
                window.dispatchEvent(new Event('scroll'));
                updateStatusBar('æ»šåŠ¨åˆ°åŠ¨æ€ç»„ ' + (stepIndex + 1) + '/' + scrollCount + 'ï¼ŒåŠ è½½æ›´å¤šå†…å®¹');
                addLog('æ»šåŠ¨åˆ°åŠ¨æ€ç»„ ' + (stepIndex + 1), 'info');
                let loadMoreBtn = document.querySelector('.load-more') || document.querySelector('a[title="åŠ è½½æ›´å¤š"]');
                if (loadMoreBtn) {
                    loadMoreBtn.click();
                    console.log('ç‚¹å‡»åŠ è½½æ›´å¤šæŒ‰é’®ä½œä¸ºå¤‡ç”¨');
                    addLog('ç‚¹å‡»åŠ è½½æ›´å¤šæŒ‰é’®', 'info');
                }
            }, stepIndex * 3000);
        });
        setTimeout(function() {
            if (isPaused) return;
            smoothScrollTo(0, 1000);
            updateStatusBar('å›åˆ°é¡¶éƒ¨ï¼Œç­‰å¾…ä¸‹æ¬¡åˆ·æ–°');
            addLog('æ»šåŠ¨å®Œæˆï¼Œå›åˆ°é¡¶éƒ¨', 'info');
            currentTask = '';
            taskDuration = 0;
        }, scrollCount * 3000 + 3000);
    }

    // å¹³æ»‘æ»šåŠ¨è¾…åŠ©å‡½æ•°ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨cubic-bezieræ›´å¹³æ»‘ï¼‰
    function smoothScrollTo(targetY, duration) {
        var startY = window.scrollY;
        var distance = targetY - startY;
        var startTime = null;

        function animation(currentTime) {
            if (isPaused) return;
            if (!startTime) startTime = currentTime;
            var timeElapsed = currentTime - startTime;
            var progress = Math.min(timeElapsed / duration, 1);
            // ä½¿ç”¨cubic-bezier(0.25, 0.1, 0.25, 1) for smoother ease-in-out
            var ease = progress ** 2 * (3 - 2 * progress); // Approximation of cubic-bezier
            window.scrollTo(0, startY + distance * ease);

            if (timeElapsed < duration) {
                requestAnimationFrame(animation);
            } else {
                window.dispatchEvent(new Event('scroll'));
            }
        }

        requestAnimationFrame(animation);
    }

    // åˆ·æ–°é¡µé¢
    function refresh() {
        if (isPaused) {
            updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡åˆ·æ–°');
            addLog('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡åˆ·æ–°', 'warn');
            return;
        }
        currentTask = 'åˆ·æ–°é¡µé¢';
        taskStartTime = Date.now();
        taskDuration = refreshDelay;
        nextTask = 'æ‰§è¡Œå·¥ä½œæµ';
        lastRefresh = Date.now();
        setCookie('al-lastRefresh', lastRefresh, Number.MAX_SAFE_INTEGER);
        nextTime = Date.now() + duration * 1000;
        setCookie('al-justRefreshed', 'true', 60);
        location.reload();
        updateStatusBar('é¡µé¢åˆ·æ–°å®Œæˆï¼Œä»å¤´å¼€å§‹æµç¨‹');
        addLog('é¡µé¢åˆ·æ–°å®Œæˆ', 'info');
    }

    // æ‰§è¡Œæ•´ä¸ªå·¥ä½œæµ
    function executeWorkflow() {
        if (isPaused) {
            updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡å·¥ä½œæµ');
            addLog('è„šæœ¬å·²æš‚åœï¼Œè·³è¿‡å·¥ä½œæµ', 'warn');
            return;
        }
        if (isRunning && !testMode) return;
        isRunning = true;
        currentTask = 'æ‰§è¡Œæ•´ä½“å·¥ä½œæµ';
        taskStartTime = Date.now();
        taskDuration = 10;
        nextTask = 'ç‚¹èµæˆ–åˆ‡æ¢é¡µé¢';
        updateStatusBar('å¼€å§‹æ‰§è¡Œå·¥ä½œæµ');
        addLog('å¼€å§‹æ‰§è¡Œå·¥ä½œæµ', 'info');

        setTimeout(function() {
            if (isPaused) {
                isRunning = false;
                updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œå·¥ä½œæµåœæ­¢');
                addLog('è„šæœ¬å·²æš‚åœï¼Œå·¥ä½œæµåœæ­¢', 'warn');
                return;
            }
            if (isInFriendFeedPage()) {
                updateStatusBar('æ£€æµ‹åˆ°ç‚¹èµå…ƒç´ ï¼Œç›´æ¥æ‰§è¡Œç‚¹èµ...');
                addLog('ç›´æ¥æ‰§è¡Œç‚¹èµ', 'info');
                safeLike();
                simulateScroll();
            } else {
                updateStatusBar('æœªæ£€æµ‹åˆ°ç‚¹èµå…ƒç´ ï¼Œåˆ‡æ¢å¹¶åˆ·æ–°é¡µé¢...');
                addLog('åˆ‡æ¢å¹¶åˆ·æ–°é¡µé¢', 'info');
                retryCount++;
                if (retryCount > maxRetries) {
                    updateStatusBar('é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼Œåœæ­¢æ‰§è¡Œ');
                    addLog('é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™', 'error');
                    isRunning = false;
                    retryCount = 0;
                    return;
                }
                goToFriendFeed();
                refresh();
                setTimeout(executeWorkflow, refreshDelay * 1000);
            }
            isRunning = false;
            currentTask = '';
            taskDuration = 0;
        }, initialDelay);
    }

    // æ»šåŠ¨äº‹ä»¶ï¼ˆä¼˜åŒ–ï¼šé˜²æŠ–ï¼‰
    let scrollDebounce = null;
    window.addEventListener('scroll', function() {
        if (isPaused) return;
        if (timeout) clearTimeout(timeout);
        isScrolling = true;
        updateStatusBar();
        addLog('æ»šåŠ¨äº‹ä»¶è§¦å‘', 'info');
        if (scrollDebounce) clearTimeout(scrollDebounce);
        scrollDebounce = setTimeout(safeLike, 1000);
        timeout = setTimeout(function() {
            isScrolling = false;
            updateStatusBar();
        }, 1000);
    });

    // ä¸»å¾ªç¯
    let mainInterval = setInterval(function() {
        if (isPaused) {
            updateStatusBar('è„šæœ¬å·²æš‚åœï¼Œç­‰å¾…æ¢å¤');
            return;
        }
        var time = Date.now();
        if (time >= nextTime || testMode) {
            refresh();
        } else if (isScrolling) {
            safeLike();
        }
    }, 1000);

    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨å‡½æ•°
    function clearAllTimeouts() {
        clearTimeout(timeout);
        clearTimeout(likeDebounce);
        clearTimeout(scrollDebounce);
        clearInterval(mainInterval);
        if (observer) observer.disconnect();
        mainInterval = null;
        observer = null;
    }

    // åˆå§‹åŒ–
    window.onload = function () {
        createMenu();
        createStatusBar();
        applyDarkMode();

        console.log('å½“å‰UIN:', uin);
        addLog('è„šæœ¬åˆå§‹åŒ–ï¼ŒUIN: ' + uin, 'info');

        removeMeRelatedMenu();

        if (getCookie('al-justRefreshed')) {
            setCookie('al-justRefreshed', '', -1);
            setTimeout(executeWorkflow, 3000);
        }
    };

    console.log('Auto Like Enhanced Running...');
})();
