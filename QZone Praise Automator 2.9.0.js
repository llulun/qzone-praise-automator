// ==UserScript==
// @name         QZone Praise Automator
// @namespace    https://github.com/llulun/qzone-autopraise-pro
// @license      MIT
// @version      2.9.0
// @description  缃戦〉鐗圦Q绌洪棿鑷姩鐐硅禐宸ュ叿锛堝寮虹増锛氱畝鍖栧伐浣滄祦锛岄€氳繃妫€娴嬬偣璧炲厓绱犲垽鏂槸鍚﹀湪濂藉弸鍔ㄦ€侀〉闈紝鏈夊垯鐩存帴鎵ц鐐硅禐锛屾棤鍒欏垏鎹㈠埌濂藉弸鍔ㄦ€佸悗鍒锋柊椤甸潰閲嶈蛋娴佺▼锛岀Щ闄よ彍鍗曞厓绱狅紝娣诲姞寤惰繜澶勭悊銆佸畨鍏ㄧ偣璧炪€佽彍鍗曡皟鏁淬€佺姸鎬佹爮缇庡寲銆佹粴鍔ㄦā鎷熺瓑鍔熻兘銆傛洿鏂帮細鐘舵€佹爮鏇磋缁嗘樉绀轰换鍔¤繘搴︺€佸墿浣欐椂闂寸瓑锛岀編鍖栭€忔槑搴︿笌闃村奖锛涙帶鍒堕潰鏉垮澶с€佸眳涓€侀€忔槑鍖栵紱淇鐘舵€佹爮鏂囧瓧妯＄硦涓庨噸鍙犻棶棰橈紝閫氳繃鍒嗚鏄剧ず銆佽皟鏁村瓧浣撲笌琛岄珮纭繚娓呮櫚锛涚姸鎬佹爮鑳屾櫙鏀逛负榛戣壊娓愬彉锛屾坊鍔犻€忔槑闃村奖涓庡簳閮ㄥ渾瑙掞紱鎵╁睍鎺у埗闈㈡澘涓哄乏渚ц彍鍗曟爮寮忕粨鏋勶紝娣诲姞鏇村鍙傛暟璋冩暣濡傜姸鎬佹爮/鎺у埗闈㈡澘閫忔槑搴︺€侀鑹层€佸睆钄界敤鎴枫€佽繃婊ら€夐」銆侀噸璇曟鏁般€佹粴鍔ㄦ闀裤€佸垵濮嬪欢杩熺瓑锛屾墍鏈夊彲璋冨弬鏁板潎闆嗘垚鍒伴潰鏉夸腑锛屾敮鎸佸姩鎬佸簲鐢ㄥ彉鍖栵紱绉婚櫎鍙屽嚮椤甸潰璋冪敤setConfig浜嬩欢锛屾墍鏈夎缃粺涓€閫氳繃鎺у埗闈㈡澘锛涙帶鍒堕潰鏉块粯璁ら殣钘忥紝閫氳繃鐐瑰嚮娴姩鎸夐挳鎵撳紑锛涗慨澶嶇姸鎬佹爮鏂囧瓧闅忚儗鏅€忔槑闂锛屾坊鍔犳枃瀛楅鑹蹭笌浜害璁剧疆锛涙柊澧烇細鏆傚仠/鎭㈠鍔熻兘锛屽厑璁哥敤鎴锋殏鍋滄垨鎭㈠鑷姩鐐硅禐娴佺▼锛岀姸鎬佹爮鏄剧ず鏆傚仠鐘舵€侊紱淇锛氱姸鎬佹爮绗簩琛屽弬鏁颁笌绛夊緟鏃堕棿鏄剧ず閿欒锛岀‘淇濆疄鏃跺悓姝ユ渶鏂板弬鏁板拰姝ｇ‘鏃堕棿锛涗紭鍖栵細淇鐘舵€佹爮澶氫綑鍒嗛殧绗﹂€昏緫锛岄伩鍏嶆樉绀哄紓甯革紱鍏煎锛氬皢妯℃澘瀛楃涓叉敼涓哄瓧绗︿覆杩炴帴锛屾彁楂樻棫娴忚鍣ㄥ吋瀹规€э紝閬垮厤娼滃湪璇硶鎶ラ敊銆傝础鐚洿鏂帮紙v2.4锛夛細缇庡寲鎺у埗闈㈡澘鍜岀姸鎬佹爮鐨刄I锛堟坊鍔犺繃娓″姩鐢汇€佸渾瑙掓寜閽€佸搷搴斿紡甯冨眬锛夛紱淇娼滃湪bug濡傛粴鍔ㄤ簨浠堕噸澶嶈Е鍙戠偣璧炪€佹殏鍋滄椂瀹氭椂鍣ㄦ湭瀹屽叏娓呯悊銆乧ookie鍊艰В鏋愯竟缂樻渚嬶紱浼樺寲鎬ц兘锛堝噺灏戜笉蹇呰鐨剆etInterval璋冪敤銆佹壒閲廌OM鎿嶄綔锛夛紱娣诲姞鏆楅粦妯″紡鑷姩閫傞厤閫夐」銆傝础鐚洿鏂帮紙v2.5锛夛細淇bug锛氬湪鐐硅禐鎴栨粴鍔ㄤ换鍔℃墽琛岃繃绋嬩腑锛屽鏋滀换鍔℃椂闂磋秴杩囧埛鏂伴棿闅旓紝瀵艰嚧鍊掕鏃堕噸缃殑闂锛堥€氳繃鍦ㄤ换鍔″紑濮嬫椂鎺ㄨ繜nextTime鏉ラ伩鍏嶄腑鏂級锛涚編鍖栫姸鎬佹爮锛氭坊鍔犺繘搴︽潯琛ㄧず褰撳墠浠诲姟杩涘害銆佷娇鐢╡moji鍥炬爣澧炲己瑙嗚鍙嶉銆佷紭鍖栧瓧浣撳拰闂磋窛浠ユ彁楂樺彲璇绘€с€傝础鐚洿鏂帮紙v2.6锛夛細淇鐘舵€佹爮閫昏緫闂锛氶槻姝afeLike閲嶅璋冪敤瀵艰嚧nextTime澶氭鎺ㄨ繜鍜屽€掕鏃惰烦鍔紱浼樺寲鐐硅禐閫昏緫锛屼粎璋冨害瀹為檯闇€瑕佺偣璧炵殑鍔ㄦ€侊紝閬垮厤涓嶅繀瑕佸欢杩熷拰鍗″湪鈥滆烦杩団€濇楠わ紱濡傛灉鎵€鏈夊姩鎬佽璺宠繃锛岀珛鍗冲畬鎴愪换鍔″苟鏇存柊鐘舵€佹爮涓虹瓑寰呭埛鏂帮紝鑰屼笉鏄瓑寰呮棤璋撴椂闂存垨鏄剧ず璺宠繃娑堟伅銆傝础鐚洿鏂帮紙v2.8锛夛細UI缇庡寲鍗囩骇锛堜富棰樼郴缁熴€佸搷搴斿紡璁捐銆佸井浜や簰锛夛紱鏂板鍔ㄦ€佸叧閿瘝杩囨护锛堝睆钄?鍏佽妯″紡锛屾敮鎸佹鍒欙級锛涢粦鍚嶅崟鎵╁睍锛堝垎缁勩€佺櫧鍚嶅崟銆佸鍏?瀵煎嚭锛夛紱姣忔棩鐐硅禐涓婇檺锛涙祻瑙堝櫒閫氱煡锛涙€ц兘鐩戞帶锛堢偣璧炴垚鍔熺巼缁熻锛夛紱澶氳处鍙锋敮鎸侊紙閰嶇疆鍒囨崲锛夈€傝础鐚洿鏂帮紙v2.8.1锛夛細淇鍔ㄦ€佸厓绱犱簨浠剁洃鍚櫒娣诲姞闂锛岀‘淇濆湪tab鍐呭鍔犺浇鍚庣粦瀹氫簨浠讹紝閬垮厤null閿欒锛涗紭鍖朖SON瑙ｆ瀽閿欒澶勭悊锛涚‘淇濇墍鏈夊瓧绗︿覆杩炴帴姝ｇ‘锛岄伩鍏嶈娉曢棶棰樸€傝础鐚洿鏂帮紙v2.8.2锛夛細淇鍏抽敭璇嶅睆钄戒笉鐢熸晥闂锛屽皢鍐呭鎻愬彇鏀逛负innerText浠ラ伩鍏岺TML鏍囩骞叉壈鍖归厤锛涘姞寮哄凡璧炲姩鎬佹娴嬶紝娣诲姞鐐硅禐鍚庡欢杩熸鏌lass鏇存柊锛岄槻姝㈡墜鍔ㄦ粴鍔ㄨЕ鍙戦噸澶嶇偣璧炲鑷村彇娑堬紱浼樺寲鏃ュ織璁板綍鍏抽敭璇嶅尮閰嶇粏鑺傘€傝础鐚洿鏂帮紙v2.8.3锛夛細鏂板鑷姩鐧诲綍妫€娴嬩笌鎻愰啋锛堝鏋滄娴嬪埌鐧诲綍杩囨湡锛屾殏鍋滆剼鏈苟閫氱煡鐢ㄦ埛锛夛紱浼樺寲婊氬姩妯℃嫙浠ユ敮鎸佹棤闄愭粴鍔ㄩ〉闈紙鍔ㄦ€佹娴嬪簳閮ㄥ姞杞藉厓绱狅級锛涙坊鍔犻厤缃浠?鎭㈠鍔熻兘鍒版帶鍒堕潰鏉匡紱淇澶氳处鍙峰垏鎹㈡椂鏃ュ織鍜岀粺璁′笉闅旂鐨勯棶棰橈紱澧炲己鏆楅粦妯″紡鍏煎鎬э紝鏀寔鑷畾涔変富棰樿壊璋冭皟鏁淬€傝础鐚洿鏂帮紙v2.8.4锛夛細淇鎺у埗闈㈡澘娴姩鎸夐挳琚姸鎬佹爮閬尅鐨勯棶棰橈紝鎻愰珮娴姩鎸夐挳z-index鑷?0003锛岀‘淇濆叾鏄剧ず鍦ㄧ姸鎬佹爮涓婃柟銆傝础鐚洿鏂帮紙v2.8.5锛夛細澧炲己瀛樺偍鍔熻兘锛屼娇鐢╨ocalStorage瀛樺偍鎬ц兘缁熻鏁版嵁锛岀‘淇濈綉椤靛埛鏂板悗涓嶄細娓呯┖銆傦級璐＄尞鏇存柊锛坴2.8.6锛夛細澧炲己鐧诲綍妫€娴嬶細娣诲姞鑷姩閲嶇櫥褰曢€夐」锛屽鏋滄娴嬪埌杩囨湡锛屽彲閫夐噸瀹氬悜鍒扮櫥褰曢〉锛岄伩鍏嶆墜鍔ㄥ共棰勶紱娣诲姞鍐峰嵈鏈哄埗闃插惊鐜€傝础鐚洿鏂帮紙v2.8.7锛夛細娣诲姞MutationObserver浠ョ洃鎺у姩鎬佸唴瀹瑰姞杞斤紝鎻愰珮鑴氭湰瀵筈Q绌洪棿鏃犻檺婊氬姩鐨勫搷搴旀€у拰绋冲畾鎬э紱浼樺寲safeLike浠ラ伩鍏嶉噸澶嶈Е鍙戙€傝础鐚洿鏂帮紙v2.8.8锛夛細浣挎棩蹇楀瓨鍌ㄦ寔涔呭寲锛屼娇鐢╨ocalStorage瀛樺偍鏃ュ織锛岄伩鍏嶉〉闈㈠埛鏂板悗涓㈠け銆傝础鐚洿鏂帮紙v2.8.9锛夛細鍦ㄦ帶鍒堕潰鏉跨殑鏃ュ織鏍囩娣诲姞瀵煎嚭鏃ュ織鎸夐挳锛屽厑璁哥敤鎴蜂笅杞芥棩蹇椾负JSON鏂囦欢锛屼究浜庤皟璇曞拰鍒嗕韩銆?
// @author       llulun (with contributions)
// @match        *://*.qzone.qq.com/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        unsafeWindow
// @grant        GM_notification
// ==/UserScript==

(function() {
    'use strict';

    // 浠巆ookie鑾峰彇閰嶇疆锛堟墿灞曪細娣诲姞鏂板弬鏁帮紝濡傚叧閿瘝銆佹ā寮忋€佺櫧鍚嶅崟銆佸垎缁勩€佹瘡鏃ヤ笂闄愮瓑锛?
    let duration = parseInt(getCookie('al-duration')) || 180;
    let refreshDelay = parseInt(getCookie('al-refreshDelay')) || 10;
    let likeDelay = parseInt(getCookie('al-likeDelay')) || 5;
    let scrollCount = parseInt(getCookie('al-scrollCount')) || 3;
    let blocked = getCookie('al-blocked') ? getCookie('al-blocked').split(',') : [];
    let whiteList = getCookie('al-whiteList') ? getCookie('al-whiteList').split(',') : [];
    let blockGroups = safeJsonParse(getCookie('al-blockGroups')) || {}; // 浣跨敤瀹夊叏瑙ｆ瀽
    let filterKeywords = getCookie('al-filterKeywords') ? getCookie('al-filterKeywords').split(',') : [];
    let filterMode = getCookie('al-filterMode') || 'block'; // 'block' or 'allow'
    let dailyLimit = parseInt(getCookie('al-dailyLimit')) || 0; // 0 means unlimited
    let dailyCount = parseInt(getCookie('al-dailyCount')) || 0;
    let lastDailyReset = parseInt(getCookie('al-lastDailyReset')) || Date.now();
    const dict = ['鐐硅禐', '杞彂', '璇勮'];
    let select = Boolean(getCookie('al-select'));
    let lastRefresh = parseInt(getCookie('al-lastRefresh')) || 0;
    let nextTime = Math.max(Date.now(), lastRefresh + duration * 1000);
    let isScrolling = false;
    let timeout = null;
    let isRunning = false;
    let isPaused = false;
    let testMode = false;
    let uin = unsafeWindow.g_iUin || unsafeWindow.g_iLoginUin || '';
    let retryCount = 0;
    let maxRetries = parseInt(getCookie('al-maxRetries')) || 3;
    let currentTask = '';
    let taskStartTime = 0;
    let taskDuration = 0;
    let nextTask = '';
    let statusOpacity = parseFloat(getCookie('al-statusOpacity')) || 0.8;
    let statusBgColor = getCookie('al-statusBgColor') || 'linear-gradient(to right, #333, #222)';
    let menuOpacity = parseFloat(getCookie('al-menuOpacity')) || 0.9;
    let menuBgColor = getCookie('al-menuBgColor') || 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
    let scrollStepPercent = parseFloat(getCookie('al-scrollStepPercent')) || 0.9;
    let initialDelay = parseInt(getCookie('al-initialDelay')) || 3000;
    let statusTextColor = getCookie('al-statusTextColor') || (statusBgColor.includes('#333') || statusBgColor.includes('#222') ? '#ddd' : '#333');
    let statusTextBrightness = parseFloat(getCookie('al-statusTextBrightness')) || 1.0;
    let darkModeAuto = Boolean(getCookie('al-darkModeAuto'));
    let logLevel = getCookie('al-logLevel') || 'INFO';
    let logs = safeJsonParse(localStorage.getItem('al-logs')) || {}; // 淇敼锛氫娇鐢╨ocalStorage瀛樺偍鏃ュ織
    let theme = getCookie('al-theme') || 'default'; // 鏂板锛氫富棰?
    let randomDelayMin = parseInt(getCookie('al-randomDelayMin')) || 1; // 鏂板锛氶殢鏈哄欢杩?
    let randomDelayMax = parseInt(getCookie('al-randomDelayMax')) || 3;
    let enableNotifications = Boolean(getCookie('al-enableNotifications')); // 鏂板锛氶€氱煡
    let stats = safeJsonParse(localStorage.getItem('al-stats')) || {}; // 淇敼锛氫娇鐢╨ocalStorage瀛樺偍鎬ц兘缁熻
    let accounts = safeJsonParse(getCookie('al-accounts')) || {}; // 鏂板锛氬璐﹀彿
    let currentAccount = uin; // 褰撳墠璐﹀彿
    let enableLoginCheck = Boolean(getCookie('al-enableLoginCheck')) || true; // 鏂板锛氱櫥褰曟娴?
    let themeHue = parseInt(getCookie('al-themeHue')) || 0; // 鏂板锛氫富棰樿壊璋冭皟鏁?
    let enableAutoRelogin = Boolean(getCookie('al-enableAutoRelogin')) || false; // 鏂板锛氳嚜鍔ㄩ噸鐧诲綍

    // 鏂板锛氬畨鍏↗SON瑙ｆ瀽
    function safeJsonParse(str) {
        try {
            return JSON.parse(str);
        } catch (e) {
            log('WARN', 'JSON瑙ｆ瀽澶辫触: ' + e.message + ', 杩斿洖榛樿鍊?);
            return null;
        }
    }

    // Cookie 鎿嶄綔鍑芥暟
    function getCookie(name) {
        let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    function setCookie(name, value, maxAge) {
        let expires = "";
        if (maxAge) {
            let date = new Date();
            date.setTime(date.getTime() + maxAge * 1000);
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // 鏃ュ織鍑芥暟
    function log(level, message) {
        try {
            if (!shouldLog(level)) return;
            let now = new Date();
            let timestamp = now.getFullYear() + '-' +
                            ('0' + (now.getMonth() + 1)).slice(-2) + '-' +
                            ('0' + now.getDate()).slice(-2) + ' ' +
                            ('0' + now.getHours()).slice(-2) + ':' +
                            ('0' + now.getMinutes()).slice(-2) + ':' +
                            ('0' + now.getSeconds()).slice(-2);
            let fullMessage = '[' + timestamp + '] [' + level + '] ' + message;
            let consoleMethod = console.log;
            if (level === 'WARN') consoleMethod = console.warn;
            if (level === 'ERROR') consoleMethod = console.error;
            consoleMethod(fullMessage);

            // 澶氳处鍙锋棩蹇楅殧绂?
            logs[currentAccount] = logs[currentAccount] || [];
            logs[currentAccount].push(fullMessage);
            if (logs[currentAccount].length > 500) {
                logs[currentAccount].shift();
            }

            // 鏂板锛氭寔涔呭寲鏃ュ織鍒發ocalStorage
            localStorage.setItem('al-logs', JSON.stringify(logs));
        } catch (e) {}
    }

    function shouldLog(level) {
        const levels = { 'INFO': 0, 'WARN': 1, 'ERROR': 2 };
        return levels[logLevel] <= levels[level];
    }

    // 閲嶇疆姣忔棩璁℃暟
    function resetDailyCount() {
        let today = new Date().setHours(0,0,0,0);
        if (lastDailyReset < today) {
            dailyCount = 0;
            lastDailyReset = today;
            setCookie('al-dailyCount', dailyCount, Number.MAX_SAFE_INTEGER);
            setCookie('al-lastDailyReset', lastDailyReset, Number.MAX_SAFE_INTEGER);
        }
    }

    // 鍙戦€侀€氱煡
    function sendNotification(title, body) {
        if (enableNotifications && 'Notification' in window && Notification.permission === 'granted') {
            new Notification(title, { body: body });
        } else if (enableNotifications && 'Notification' in window && Notification.permission !== 'denied') {
            Notification.requestPermission().then(function(perm) {
                if (perm === 'granted') {
                    new Notification(title, { body: body });
                }
            });
        }
    }

    // 鏇存柊缁熻锛堝璐﹀彿闅旂锛屼娇鐢╨ocalStorage鎸佷箙鍖栵級
    function updateStats(key) {
        stats[currentAccount] = stats[currentAccount] || { likes: 0, skips: 0, errors: 0 };
        stats[currentAccount][key] = (stats[currentAccount][key] || 0) + 1;
        localStorage.setItem('al-stats', JSON.stringify(stats));
    }

    // 鏂板锛氭娴嬬櫥褰曠姸鎬?
    function checkLoginStatus() {
        if (!enableLoginCheck) return true;
        const isLoggedIn = !!uin && document.querySelector('.user-info') !== null;
        if (!isLoggedIn) {
            isPaused = true;
            updateStatusBar('妫€娴嬪埌鐧诲綍杩囨湡锛岃閲嶆柊鐧诲綍');
            sendNotification('鐧诲綍杩囨湡', 'QZone Praise Automator 妫€娴嬪埌鐧诲綍鐘舵€佸け鏁堬紝璇烽噸鏂扮櫥褰曚互缁х画銆?);
            log('WARN', '鐧诲綍鐘舵€佸け鏁堬紝鑴氭湰鏆傚仠');
            
            // 鏂板锛氳嚜鍔ㄩ噸鐧诲綍閫昏緫
            if (enableAutoRelogin) {
                const lastAttempt = parseInt(getCookie('al-lastReloginAttempt')) || 0;
                const cooldown = 5 * 60 * 1000; // 5鍒嗛挓鍐峰嵈
                if (Date.now() - lastAttempt > cooldown) {
                    log('INFO', '灏濊瘯鑷姩閲嶇櫥褰曪紝閲嶅畾鍚戝埌鐧诲綍椤?);
                    sendNotification('鑷姩閲嶇櫥褰?, '妫€娴嬪埌杩囨湡锛屾鍦ㄩ噸瀹氬悜鍒癚Q绌洪棿鐧诲綍椤?..');
                    setCookie('al-lastReloginAttempt', Date.now(), Number.MAX_SAFE_INTEGER);
                    location.href = 'https://qzone.qq.com/'; // QQ绌洪棿棣栭〉锛屼細瑙﹀彂鐧诲綍濡傛灉杩囨湡
                } else {
                    log('WARN', '閲嶇櫥褰曞喎鍗翠腑锛岃烦杩囪嚜鍔ㄥ皾璇?);
                }
            }
            return false;
        }
        return true;
    }

    // 鏂板锛氳缃甅utationObserver浠ョ洃鎺у姩鎬佸唴瀹?
    let mutationObserver = null;
    function setupMutationObserver() {
        const targetNode = document.querySelector('#feed_friend_list') || document.body; // 鍋囪濂藉弸鍔ㄦ€佸鍣ㄤ负#feed_friend_list锛屽疄闄呮牴鎹甉Q绌洪棿璋冩暣
        if (!targetNode) {
            log('WARN', '鏈壘鍒板姩鎬佸鍣紝MutationObserver鏈惎鍔?);
            return;
        }

        mutationObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    let hasNewLikes = Array.from(mutation.addedNodes).some(node => node.querySelector && node.querySelector('.qz_like_btn_v3'));
                    if (hasNewLikes) {
                        log('INFO', '妫€娴嬪埌鏂板姩鎬佸姞杞斤紝瑙﹀彂safeLike');
                        safeLike();
                    }
                }
            });
        });

        const config = { childList: true, subtree: true };
        mutationObserver.observe(targetNode, config);
        log('INFO', 'MutationObserver宸插惎鍔紝鐩戞帶鍔ㄦ€佸唴瀹?);
    }

    // 鍒涘缓鑿滃崟鏍忥紙鏂板锛氶厤缃浠?鎭㈠銆佺櫥褰曟娴嬪紑鍏炽€佽壊璋冭皟鏁达級
    function createMenu() {
        let menu = document.createElement('div');
        menu.id = 'al-menu';
        menu.style.position = 'fixed';
        menu.style.top = '50%';
        menu.style.left = '50%';
        menu.style.transform = 'translate(-50%, -50%)';
        menu.style.width = '80%';
        menu.style.maxWidth = '800px';
        menu.style.height = 'auto';
        menu.style.maxHeight = '80vh';
        menu.style.overflow = 'auto';
        menu.style.background = menuBgColor;
        menu.style.border = '1px solid #ccc';
        menu.style.borderRadius = '12px';
        menu.style.padding = '20px';
        menu.style.zIndex = '10002';
        menu.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
        menu.style.fontFamily = "Arial, sans-serif";
        menu.style.opacity = menuOpacity;
        menu.style.display = 'none';
        menu.style.pointerEvents = 'auto';
        menu.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        menu.style.filter = 'hue-rotate(' + themeHue + 'deg)';
        // 鍝嶅簲寮?
        if (window.innerWidth < 600) {
            menu.style.width = '95%';
            menu.style.padding = '10px';
        }

        let sidebar = document.createElement('div');
        sidebar.style.width = '150px';
        sidebar.style.borderRight = '1px solid #ddd';
        sidebar.style.paddingRight = '10px';
        sidebar.innerHTML = '<h4 style="margin: 0 0 10px;">璁剧疆鍒嗙被</h4><ul style="list-style: none; padding: 0;"><li><button id="al-tab-core" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">鏍稿績鍙傛暟</button></li><li><button id="al-tab-ui" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">鐣岄潰鑷畾涔?/button></li><li><button id="al-tab-filter" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">杩囨护瑙勫垯</button></li><li><button id="al-tab-adv" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">楂樼骇鍙傛暟</button></li><li><button id="al-tab-logs" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">鏌ョ湅鏃ュ織</button></li><li><button id="al-tab-stats" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">鎬ц兘缁熻</button></li><li><button id="al-tab-accounts" style="width: 100%; text-align: left; padding: 5px; background: none; border: none; cursor: pointer; border-radius: 4px; transition: background 0.2s;">璐﹀彿绠＄悊</button></li></ul>';
        menu.appendChild(sidebar);

        let content = document.createElement('div');
        content.id = 'al-content';
        content.style.flex = '1';
        content.style.paddingLeft = '20px';
        content.style.transition = 'opacity 0.3s ease';
        menu.appendChild(content);

        let footer = document.createElement('div');
        footer.style.marginTop = '20px';
        footer.style.textAlign = 'center';
        footer.innerHTML = '<button id="al-save" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">淇濆瓨骞跺簲鐢?/button><button id="al-pause" style="background: #FF9800; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">' + (isPaused ? '鎭㈠' : '鏆傚仠') + '</button><button id="al-test" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">娴嬭瘯鎵ц</button><button id="al-reset" style="background: #9E9E9E; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">閲嶇疆榛樿</button><button id="al-export" style="background: #673AB7; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">瀵煎嚭閰嶇疆</button><button id="al-backup" style="background: #795548; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">澶囦唤閰嶇疆</button><button id="al-restore" style="background: #607D8B; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; transition: background 0.2s;">鎭㈠閰嶇疆</button><button id="al-close" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: background 0.2s;">鍏抽棴</button>';
        menu.appendChild(footer);

        document.body.appendChild(menu);

        function showTab(tab) {
            content.style.opacity = '0';
            setTimeout(function() {
                content.innerHTML = '';
                if (tab === 'core') {
                    content.innerHTML = '<h3>鏍稿績鍙傛暟</h3><div class="al-card"><label>鍒锋柊棰戠巼 (绉?: <input type="number" id="al-dur" value="' + duration + '" min="30" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鍒锋柊寤惰繜 (绉?: <input type="number" id="al-rdelay" value="' + refreshDelay + '" min="5" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鐐硅禐寤惰繜 (绉?: <input type="number" id="al-ldelay" value="' + likeDelay + '" min="3" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>涓嬫粦鍔ㄦ€佹暟: <input type="number" id="al-scount" value="' + scrollCount + '" min="1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>姣忔棩鐐硅禐涓婇檺 (0鏃犻檺): <input type="number" id="al-dailyLimit" value="' + dailyLimit + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label><input type="checkbox" id="al-select" ' + (select ? 'checked' : '') + '> 涓嶇偣璧炴父鎴忚浆鍙戝唴瀹?/label></div><div class="al-card"><label><input type="checkbox" id="al-enableLoginCheck" ' + (enableLoginCheck ? 'checked' : '') + '> 鍚敤鐧诲綍鐘舵€佹娴?/label></div>';
                    content.innerHTML += '<div class="al-card"><label><input type="checkbox" id="al-enableAutoRelogin" ' + (enableAutoRelogin ? 'checked' : '') + '> 鍚敤鑷姩閲嶇櫥褰曪紙杩囨湡鏃堕噸瀹氬悜锛?/label></div>'; // 鏂板澶嶉€夋
                } else if (tab === 'ui') {
                    content.innerHTML = '<h3>鐣岄潰鑷畾涔?/h3><div class="al-card"><label>涓婚: <select id="al-theme"><option value="default" ' + (theme === 'default' ? 'selected' : '') + '>榛樿</option><option value="tech" ' + (theme === 'tech' ? 'selected' : '') + '>绉戞妧钃?/option><option value="eco" ' + (theme === 'eco' ? 'selected' : '') + '>鐜繚缁?/option></select></label></div><div class="al-card"><label>涓婚鑹茶皟璋冩暣 (0-360): <input type="number" id="al-themeHue" value="' + themeHue + '" min="0" max="360" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鐘舵€佹爮閫忔槑搴?(0.1-1): <input type="number" id="al-statusOpacity" value="' + statusOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鐘舵€佹爮鑳屾櫙: <select id="al-statusBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to right, #333, #222)" ' + (statusBgColor === 'linear-gradient(to right, #333, #222)' ? 'selected' : '') + '>榛戣壊娓愬彉</option><option value="linear-gradient(to right, #f0f0f0, #e0e0e0)" ' + (statusBgColor === 'linear-gradient(to right, #f0f0f0, #e0e0e0)' ? 'selected' : '') + '>鐧借壊娓愬彉</option><option value="linear-gradient(to right, #2196F3, #1976D2)" ' + (statusBgColor === 'linear-gradient(to right, #2196F3, #1976D2)' ? 'selected' : '') + '>钃濊壊娓愬彉</option><option value="linear-gradient(to right, #4CAF50, #388E3C)" ' + (statusBgColor === 'linear-gradient(to right, #4CAF50, #388E3C)' ? 'selected' : '') + '>缁胯壊娓愬彉</option></select></label></div><div class="al-card"><label>鐘舵€佹爮鏂囧瓧棰滆壊: <select id="al-statusTextColor" style="width: 200px; margin-left: 10px;"><option value="auto" ' + (statusTextColor === 'auto' ? 'selected' : '') + '>鑷姩</option><option value="#fff" ' + (statusTextColor === '#fff' ? 'selected' : '') + '>鐧借壊</option><option value="#000" ' + (statusTextColor === '#000' ? 'selected' : '') + '>榛戣壊</option><option value="#ddd" ' + (statusTextColor === '#ddd' ? 'selected' : '') + '>娴呯伆</option></select></label></div><div class="al-card"><label>鐘舵€佹爮鏂囧瓧浜害 (0.5-1.5): <input type="number" id="al-statusTextBrightness" value="' + statusTextBrightness + '" min="0.5" max="1.5" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label><input type="checkbox" id="al-darkModeAuto" ' + (darkModeAuto ? 'checked' : '') + '> 鑷姩閫傞厤鏆楅粦妯″紡</label></div><div class="al-card"><label>鎺у埗闈㈡澘閫忔槑搴?(0.1-1): <input type="number" id="al-menuOpacity" value="' + menuOpacity + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鎺у埗闈㈡澘鑳屾櫙: <select id="al-menuBgColor" style="width: 200px; margin-left: 10px;"><option value="linear-gradient(to bottom, #ffffff, #f0f0f0)" ' + (menuBgColor === 'linear-gradient(to bottom, #ffffff, #f0f0f0)' ? 'selected' : '') + '>鐧借壊娓愬彉</option><option value="linear-gradient(to bottom, #333, #222)" ' + (menuBgColor === 'linear-gradient(to bottom, #333, #222)' ? 'selected' : '') + '>榛戣壊娓愬彉</option><option value="linear-gradient(to bottom, #2196F3, #1976D2)" ' + (menuBgColor === 'linear-gradient(to bottom, #2196F3, #1976D2)' ? 'selected' : '') + '>钃濊壊娓愬彉</option><option value="linear-gradient(to bottom, #4CAF50, #388E3C)" ' + (menuBgColor === 'linear-gradient(to bottom, #4CAF50, #388E3C)' ? 'selected' : '') + '>缁胯壊娓愬彉</option></select></label></div>';
                } else if (tab === 'filter') {
                    content.innerHTML = '<h3>杩囨护瑙勫垯</h3><div class="al-card"><label>灞忚斀鐢ㄦ埛 (QQ鍙?閫楀彿鍒嗛殧): <textarea id="al-blocked" style="width: 200px; height: 50px; margin-left: 10px;">' + blocked.join(',') + '</textarea></label></div><div class="al-card"><label>鐧藉悕鍗曠敤鎴?(QQ鍙?閫楀彿鍒嗛殧): <textarea id="al-whiteList" style="width: 200px; height: 50px; margin-left: 10px;">' + whiteList.join(',') + '</textarea></label></div><div class="al-card"><label>榛戝悕鍗曞垎缁?(JSON): <textarea id="al-blockGroups" style="width: 200px; height: 100px; margin-left: 10px;">' + JSON.stringify(blockGroups) + '</textarea></label></div><div class="al-card"><label>鍔ㄦ€佸叧閿瘝 (閫楀彿鍒嗛殧,鏀寔姝ｅ垯): <textarea id="al-filterKeywords" style="width: 200px; height: 50px; margin-left: 10px;">' + filterKeywords.join(',') + '</textarea></label></div><div class="al-card"><label>杩囨护妯″紡: <select id="al-filterMode"><option value="block" ' + (filterMode === 'block' ? 'selected' : '') + '>灞忚斀鍏抽敭璇?/option><option value="allow" ' + (filterMode === 'allow' ? 'selected' : '') + '>浠呭厑璁稿叧閿瘝</option></select></label></div><div class="al-card"><button id="al-import-block" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">瀵煎叆榛戝悕鍗?/button> <input type="file" id="al-file-input" style="display:none;"><button id="al-export-block" style="background: #673AB7; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">瀵煎嚭榛戝悕鍗?/button></div>';
                    // 娣诲姞浜嬩欢鐩戝惉鍣ㄥ湪杩欓噷锛岀‘淇濆厓绱犲瓨鍦?
                    document.getElementById('al-import-block').addEventListener('click', function() {
                        document.getElementById('al-file-input').click();
                    });
                    document.getElementById('al-file-input').addEventListener('change', function(e) {
                        let file = e.target.files[0];
                        if (file) {
                            let reader = new FileReader();
                            reader.onload = function(ev) {
                                try {
                                    let data = JSON.parse(ev.target.result);
                                    blocked = data.blocked || [];
                                    blockGroups = data.blockGroups || {};
                                    whiteList = data.whiteList || [];
                                    showTab('filter');
                                    alert('瀵煎叆鎴愬姛');
                                } catch (err) {
                                    alert('瀵煎叆澶辫触: ' + err.message);
                                }
                            };
                            reader.readAsText(file);
                        }
                    });
                    document.getElementById('al-export-block').addEventListener('click', function() {
                        let data = { blocked: blocked, blockGroups: blockGroups, whiteList: whiteList };
                        download('blocklist.json', JSON.stringify(data));
                    });
                } else if (tab === 'adv') {
                    content.innerHTML = '<h3>楂樼骇鍙傛暟</h3><div class="al-card"><label>鏈€澶ч噸璇曟鏁? <input type="number" id="al-maxRetries" value="' + maxRetries + '" min="1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>婊氬姩姝ラ暱鐧惧垎姣?(0.1-1): <input type="number" id="al-scrollStepPercent" value="' + scrollStepPercent + '" min="0.1" max="1" step="0.1" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鍒濆寤惰繜 (姣): <input type="number" id="al-initialDelay" value="' + initialDelay + '" min="1000" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>闅忔満寤惰繜鏈€灏?(绉?: <input type="number" id="al-randomDelayMin" value="' + randomDelayMin + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>闅忔満寤惰繜鏈€澶?(绉?: <input type="number" id="al-randomDelayMax" value="' + randomDelayMax + '" min="0" style="width: 80px; margin-left: 10px;"></label></div><div class="al-card"><label>鏃ュ織绾у埆: <select id="al-logLevel" style="width: 100px; margin-left: 10px;"><option value="INFO" ' + (logLevel === 'INFO' ? 'selected' : '') + '>INFO</option><option value="WARN" ' + (logLevel === 'WARN' ? 'selected' : '') + '>WARN</option><option value="ERROR" ' + (logLevel === 'ERROR' ? 'selected' : '') + '>ERROR</option></select></label></div><div class="al-card"><label><input type="checkbox" id="al-enableNotifications" ' + (enableNotifications ? 'checked' : '') + '> 鍚敤娴忚鍣ㄩ€氱煡</label></div>';
                } else if (tab === 'logs') {
                    content.innerHTML = '<h3>绯荤粺鏃ュ織</h3><div id="al-log-list" style="height: 300px; overflow: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; font-family: monospace; white-space: pre-wrap;">' + (logs[currentAccount] || []).join('\n') + '</div><button id="al-clear-logs" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-right: 10px;">娓呴櫎鏃ュ織</button><button id="al-export-logs" style="background: #673AB7; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px;">瀵煎嚭鏃ュ織</button>';
                    document.getElementById('al-clear-logs').addEventListener('click', function() {
                        logs[currentAccount] = [];
                        localStorage.setItem('al-logs', JSON.stringify(logs)); // 鏇存柊localStorage
                        showTab('logs');
                    });
                    document.getElementById('al-export-logs').addEventListener('click', function() {
                        download('al-logs-' + currentAccount + '.json', JSON.stringify(logs[currentAccount] || []));
                    });
                } else if (tab === 'stats') {
                    let accStats = stats[currentAccount] || { likes: 0, skips: 0, errors: 0 };
                    let total = accStats.likes + accStats.skips + accStats.errors;
                    let successRate = total > 0 ? Math.round((accStats.likes / total) * 100) + '%' : 'N/A';
                    content.innerHTML = '<h3>鎬ц兘缁熻</h3><div class="al-card">鐐硅禐: ' + accStats.likes + ' | 璺宠繃: ' + accStats.skips + ' | 閿欒: ' + accStats.errors + ' | 鎴愬姛鐜? ' + successRate + '</div><button id="al-clear-stats" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">娓呴櫎缁熻</button>';
                    document.getElementById('al-clear-stats').addEventListener('click', function() {
                        stats[currentAccount] = { likes: 0, skips: 0, errors: 0 };
                        localStorage.setItem('al-stats', JSON.stringify(stats));
                        showTab('stats');
                    });
                } else if (tab === 'accounts') {
                    let accountList = Object.keys(accounts).join(', ');
                    content.innerHTML = '<h3>璐﹀彿绠＄悊</h3><div class="al-card"><label>褰撳墠璐﹀彿: ' + currentAccount + '</label></div><div class="al-card"><label>鍒囨崲璐﹀彿 (杈撳叆QQ鍙?: <input type="text" id="al-switchAcc" style="width: 150px; margin-left: 10px;"></label><button id="al-switch" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;">鍒囨崲</button></div><div class="al-card">鍙敤璐﹀彿: ' + accountList + '</div>';
                    document.getElementById('al-switch').addEventListener('click', function() {
                        let newAcc = document.getElementById('al-switchAcc').value.trim();
                        if (newAcc) {
                            loadAccountConfig(newAcc);
                            updateStatusBar('鍒囨崲鍒拌处鍙? ' + newAcc);
                            showTab('accounts');
                        }
                    });
                }
                content.style.opacity = '1';
            }, 300);
        }

        // 鏍囩鍒囨崲浜嬩欢
        document.getElementById('al-tab-core').addEventListener('click', function() { showTab('core'); });
        document.getElementById('al-tab-ui').addEventListener('click', function() { showTab('ui'); });
        document.getElementById('al-tab-filter').addEventListener('click', function() { showTab('filter'); });
        document.getElementById('al-tab-adv').addEventListener('click', function() { showTab('adv'); });
        document.getElementById('al-tab-logs').addEventListener('click', function() { showTab('logs'); });
        document.getElementById('al-tab-stats').addEventListener('click', function() { showTab('stats'); });
        document.getElementById('al-tab-accounts').addEventListener('click', function() { showTab('accounts'); });

        // 淇濆瓨鎸夐挳
        document.getElementById('al-save').addEventListener('click', function() {
            try {
                // 鑾峰彇鎺у埗闈㈡澘涓殑鍊?
                if (document.getElementById('al-dur')) duration = parseInt(document.getElementById('al-dur').value) || duration;
                if (document.getElementById('al-rdelay')) refreshDelay = parseInt(document.getElementById('al-rdelay').value) || refreshDelay;
                if (document.getElementById('al-ldelay')) likeDelay = parseInt(document.getElementById('al-ldelay').value) || likeDelay;
                if (document.getElementById('al-scount')) scrollCount = parseInt(document.getElementById('al-scount').value) || scrollCount;
                if (document.getElementById('al-dailyLimit')) dailyLimit = parseInt(document.getElementById('al-dailyLimit').value) || dailyLimit;
                if (document.getElementById('al-select')) select = document.getElementById('al-select').checked;
                if (document.getElementById('al-theme')) theme = document.getElementById('al-theme').value;
                if (document.getElementById('al-themeHue')) themeHue = parseInt(document.getElementById('al-themeHue').value) || themeHue;
                if (document.getElementById('al-statusOpacity')) statusOpacity = parseFloat(document.getElementById('al-statusOpacity').value) || statusOpacity;
                if (document.getElementById('al-statusBgColor')) statusBgColor = document.getElementById('al-statusBgColor').value;
                if (document.getElementById('al-statusTextColor')) statusTextColor = document.getElementById('al-statusTextColor').value;
                if (document.getElementById('al-statusTextBrightness')) statusTextBrightness = parseFloat(document.getElementById('al-statusTextBrightness').value) || statusTextBrightness;
                if (document.getElementById('al-darkModeAuto')) darkModeAuto = document.getElementById('al-darkModeAuto').checked;
                if (document.getElementById('al-menuOpacity')) menuOpacity = parseFloat(document.getElementById('al-menuOpacity').value) || menuOpacity;
                if (document.getElementById('al-menuBgColor')) menuBgColor = document.getElementById('al-menuBgColor').value;
                if (document.getElementById('al-blocked')) blocked = document.getElementById('al-blocked').value.split(',').map(s => s.trim()).filter(s => s);
                if (document.getElementById('al-whiteList')) whiteList = document.getElementById('al-whiteList').value.split(',').map(s => s.trim()).filter(s => s);
                if (document.getElementById('al-blockGroups')) blockGroups = safeJsonParse(document.getElementById('al-blockGroups').value) || blockGroups;
                if (document.getElementById('al-filterKeywords')) filterKeywords = document.getElementById('al-filterKeywords').value.split(',').map(s => s.trim()).filter(s => s);
                if (document.getElementById('al-filterMode')) filterMode = document.getElementById('al-filterMode').value;
                if (document.getElementById('al-maxRetries')) maxRetries = parseInt(document.getElementById('al-maxRetries').value) || maxRetries;
                if (document.getElementById('al-scrollStepPercent')) scrollStepPercent = parseFloat(document.getElementById('al-scrollStepPercent').value) || scrollStepPercent;
                if (document.getElementById('al-initialDelay')) initialDelay = parseInt(document.getElementById('al-initialDelay').value) || initialDelay;
                if (document.getElementById('al-randomDelayMin')) randomDelayMin = parseInt(document.getElementById('al-randomDelayMin').value) || randomDelayMin;
                if (document.getElementById('al-randomDelayMax')) randomDelayMax = parseInt(document.getElementById('al-randomDelayMax').value) || randomDelayMax;
                if (document.getElementById('al-logLevel')) logLevel = document.getElementById('al-logLevel').value;
                if (document.getElementById('al-enableNotifications')) enableNotifications = document.getElementById('al-enableNotifications').checked;
                if (document.getElementById('al-enableLoginCheck')) enableLoginCheck = document.getElementById('al-enableLoginCheck').checked;
                if (document.getElementById('al-enableAutoRelogin')) enableAutoRelogin = document.getElementById('al-enableAutoRelogin').checked; // 鏂板

                // 淇濆瓨鍒癱ookie
                setCookie('al-duration', duration, Number.MAX_SAFE_INTEGER);
                setCookie('al-refreshDelay', refreshDelay, Number.MAX_SAFE_INTEGER);
                setCookie('al-likeDelay', likeDelay, Number.MAX_SAFE_INTEGER);
                setCookie('al-scrollCount', scrollCount, Number.MAX_SAFE_INTEGER);
                setCookie('al-blocked', blocked.join(','), Number.MAX_SAFE_INTEGER);
                setCookie('al-whiteList', whiteList.join(','), Number.MAX_SAFE_INTEGER);
                setCookie('al-blockGroups', JSON.stringify(blockGroups), Number.MAX_SAFE_INTEGER);
                setCookie('al-filterKeywords', filterKeywords.join(','), Number.MAX_SAFE_INTEGER);
                setCookie('al-filterMode', filterMode, Number.MAX_SAFE_INTEGER);
                setCookie('al-dailyLimit', dailyLimit, Number.MAX_SAFE_INTEGER);
                setCookie('al-select', select ? 'true' : '', Number.MAX_SAFE_INTEGER);
                setCookie('al-theme', theme, Number.MAX_SAFE_INTEGER);
                setCookie('al-statusOpacity', statusOpacity, Number.MAX_SAFE_INTEGER);
                setCookie('al-statusBgColor', statusBgColor, Number.MAX_SAFE_INTEGER);
                setCookie('al-statusTextColor', statusTextColor, Number.MAX_SAFE_INTEGER);
                setCookie('al-statusTextBrightness', statusTextBrightness, Number.MAX_SAFE_INTEGER);
                setCookie('al-darkModeAuto', darkModeAuto ? 'true' : '', Number.MAX_SAFE_INTEGER);
                
                // 鏇存柊UI鍏冪礌
                let menu = document.getElementById('al-menu');
                if (menu) {
                    menu.style.background = menuBgColor;
                    menu.style.opacity = menuOpacity;
                }
                
                let statusBar = document.getElementById('al-status-bar');
                if (statusBar) {
                    statusBar.style.background = statusBgColor;
                    statusBar.style.opacity = statusOpacity;
                    statusBar.style.color = statusTextColor;
                    statusBar.style.filter = 'brightness(' + statusTextBrightness + ') hue-rotate(' + themeHue + 'deg)';
                }
                
                // 搴旂敤鏆楅粦妯″紡
                if (darkModeAuto) {
                    applyDarkMode();
                }
                
                // 淇濆瓨鎴愬姛鎻愮ず
                alert('璁剧疆宸蹭繚瀛?);
                log('INFO', '璁剧疆宸蹭繚瀛?);
            } catch (e) {
                log('ERROR', '淇濆瓨璁剧疆澶辫触: ' + e.message);
                alert('淇濆瓨璁剧疆澶辫触: ' + e.message);
            }
            setCookie('al-menuOpacity', menuOpacity, Number.MAX_SAFE_INTEGER);
            setCookie('al-menuBgColor', menuBgColor, Number.MAX_SAFE_INTEGER);
            setCookie('al-maxRetries', maxRetries, Number.MAX_SAFE_INTEGER);
            setCookie('al-scrollStepPercent', scrollStepPercent, Number.MAX_SAFE_INTEGER);
            setCookie('al-initialDelay', initialDelay, Number.MAX_SAFE_INTEGER);
            setCookie('al-randomDelayMin', randomDelayMin, Number.MAX_SAFE_INTEGER);
            setCookie('al-randomDelayMax', randomDelayMax, Number.MAX_SAFE_INTEGER);
            setCookie('al-logLevel', logLevel, Number.MAX_SAFE_INTEGER);
            setCookie('al-enableNotifications', enableNotifications ? 'true' : '', Number.MAX_SAFE_INTEGER);
            setCookie('al-enableLoginCheck', enableLoginCheck ? 'true' : '', Number.MAX_SAFE_INTEGER);
            setCookie('al-themeHue', themeHue, Number.MAX_SAFE_INTEGER);
            setCookie('al-enableAutoRelogin', enableAutoRelogin ? 'true' : '', Number.MAX_SAFE_INTEGER); // 鏂板

            // 搴旂敤鍙樺寲
            let menuElem = document.getElementById('al-menu');
            if (menuElem) {
                menuElem.style.opacity = menuOpacity;
                menuElem.style.background = menuBgColor;
                menuElem.style.filter = 'hue-rotate(' + themeHue + 'deg)';
            }
            let statusBar = document.getElementById('al-status-bar');
            if (statusBar) {
                statusBar.style.opacity = statusOpacity;
                statusBar.style.background = statusBgColor;
                statusBar.style.color = statusTextColor;
                statusBar.style.filter = 'brightness(' + statusTextBrightness + ') hue-rotate(' + themeHue + 'deg)';
            }
            applyDarkMode();
            updateStatusBar('璁剧疆宸蹭繚瀛?);
            saveAccountConfig();
        });

        // 鏆傚仠/鎭㈠
        document.getElementById('al-pause').addEventListener('click', function() {
            isPaused = !isPaused;
            this.innerText = isPaused ? '鎭㈠' : '鏆傚仠';
            updateStatusBar(isPaused ? '宸叉殏鍋? : '宸叉仮澶?);
            if (!isPaused) executeWorkflow();
            clearAllTimeouts();
        });

        // 娴嬭瘯鎵ц
        document.getElementById('al-test').addEventListener('click', function() {
            testMode = true;
            executeWorkflow();
            testMode = false;
        });

        // 閲嶇疆榛樿
        document.getElementById('al-reset').addEventListener('click', function() {
            // 閲嶇疆鍙橀噺鍒伴粯璁?
            duration = 180;
            refreshDelay = 10;
            likeDelay = 5;
            scrollCount = 3;
            blocked = [];
            whiteList = [];
            blockGroups = {};
            filterKeywords = [];
            filterMode = 'block';
            dailyLimit = 0;
            select = false;
            theme = 'default';
            themeHue = 0;
            statusOpacity = 0.8;
            statusBgColor = 'linear-gradient(to right, #333, #222)';
            statusTextColor = '#ddd';
            statusTextBrightness = 1.0;
            darkModeAuto = true;
            menuOpacity = 0.9;
            menuBgColor = 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
            maxRetries = 3;
            scrollStepPercent = 0.9;
            initialDelay = 3000;
            randomDelayMin = 1;
            randomDelayMax = 3;
            logLevel = 'INFO';
            enableNotifications = false;
            enableLoginCheck = true;
            enableAutoRelogin = false;

            // 娓呯┖cookie
            ['al-duration', 'al-refreshDelay', 'al-likeDelay', 'al-scrollCount', 'al-blocked', 'al-whiteList', 'al-blockGroups', 'al-filterKeywords', 'al-filterMode', 'al-dailyLimit', 'al-select', 'al-theme', 'al-themeHue', 'al-statusOpacity', 'al-statusBgColor', 'al-statusTextColor', 'al-statusTextBrightness', 'al-darkModeAuto', 'al-menuOpacity', 'al-menuBgColor', 'al-maxRetries', 'al-scrollStepPercent', 'al-initialDelay', 'al-randomDelayMin', 'al-randomDelayMax', 'al-logLevel', 'al-enableNotifications', 'al-enableLoginCheck', 'al-enableAutoRelogin'].forEach(function(key) {
                setCookie(key, '', -1);
            });

            updateStatusBar('璁剧疆宸查噸缃?);
            showTab(document.querySelector('[id^="al-tab-"]').id.replace('al-tab-', ''));
        });

        // 瀵煎嚭閰嶇疆
        document.getElementById('al-export').addEventListener('click', function() {
            let config = {
                duration: duration, refreshDelay: refreshDelay, likeDelay: likeDelay, scrollCount: scrollCount, blocked: blocked, whiteList: whiteList, blockGroups: blockGroups, filterKeywords: filterKeywords, filterMode: filterMode, dailyLimit: dailyLimit, select: select, theme: theme, themeHue: themeHue, statusOpacity: statusOpacity, statusBgColor: statusBgColor, statusTextColor: statusTextColor, statusTextBrightness: statusTextBrightness, darkModeAuto: darkModeAuto, menuOpacity: menuOpacity, menuBgColor: menuBgColor, maxRetries: maxRetries, scrollStepPercent: scrollStepPercent, initialDelay: initialDelay, randomDelayMin: randomDelayMin, randomDelayMax: randomDelayMax, logLevel: logLevel, enableNotifications: enableNotifications, enableLoginCheck: enableLoginCheck, enableAutoRelogin: enableAutoRelogin
            };
            download('al-config.json', JSON.stringify(config));
        });

        // 澶囦唤閰嶇疆锛堝埌localStorage锛?
        document.getElementById('al-backup').addEventListener('click', function() {
            let config = {
                duration: duration, refreshDelay: refreshDelay, likeDelay: likeDelay, scrollCount: scrollCount, blocked: blocked, whiteList: whiteList, blockGroups: blockGroups, filterKeywords: filterKeywords, filterMode: filterMode, dailyLimit: dailyLimit, select: select, theme: theme, themeHue: themeHue, statusOpacity: statusOpacity, statusBgColor: statusBgColor, statusTextColor: statusTextColor, statusTextBrightness: statusTextBrightness, darkModeAuto: darkModeAuto, menuOpacity: menuOpacity, menuBgColor: menuBgColor, maxRetries: maxRetries, scrollStepPercent: scrollStepPercent, initialDelay: initialDelay, randomDelayMin: randomDelayMin, randomDelayMax: randomDelayMax, logLevel: logLevel, enableNotifications: enableNotifications, enableLoginCheck: enableLoginCheck, enableAutoRelogin: enableAutoRelogin
            };
            localStorage.setItem('al-backup', JSON.stringify(config));
            alert('閰嶇疆宸插浠?);
        });

        // 鎭㈠閰嶇疆
        document.getElementById('al-restore').addEventListener('click', function() {
            let backup = safeJsonParse(localStorage.getItem('al-backup'));
            if (backup) {
                duration = backup.duration;
                refreshDelay = backup.refreshDelay;
                likeDelay = backup.likeDelay;
                scrollCount = backup.scrollCount;
                blocked = backup.blocked;
                whiteList = backup.whiteList;
                blockGroups = backup.blockGroups;
                filterKeywords = backup.filterKeywords;
                filterMode = backup.filterMode;
                dailyLimit = backup.dailyLimit;
                select = backup.select;
                theme = backup.theme;
                themeHue = backup.themeHue;
                statusOpacity = backup.statusOpacity;
                statusBgColor = backup.statusBgColor;
                statusTextColor = backup.statusTextColor;
                statusTextBrightness = backup.statusTextBrightness;
                darkModeAuto = backup.darkModeAuto;
                menuOpacity = backup.menuOpacity;
                menuBgColor = backup.menuBgColor;
                maxRetries = backup.maxRetries;
                scrollStepPercent = backup.scrollStepPercent;
                initialDelay = backup.initialDelay;
                randomDelayMin = backup.randomDelayMin;
                randomDelayMax = backup.randomDelayMax;
                logLevel = backup.logLevel;
                enableNotifications = backup.enableNotifications;
                enableLoginCheck = backup.enableLoginCheck;
                enableAutoRelogin = backup.enableAutoRelogin;

                alert('閰嶇疆宸叉仮澶?);
                showTab(document.querySelector('[id^="al-tab-"]').id.replace('al-tab-', ''));
            } else {
                alert('鏃犲浠藉彲鐢?);
            }
        });

        // 鍏抽棴鑿滃崟
        document.getElementById('al-close').addEventListener('click', function() {
            menu.style.display = 'none';
            document.getElementById('al-float-btn').style.display = 'block';
        });

        log('INFO', '鑿滃崟鍔犺浇瀹屾垚');
    }

    // 涓嬭浇鍑芥暟
    function download(filename, text) {
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // 鍒涘缓娴姩鎸夐挳
    function createFloatButton() {
        let btn = document.createElement('div');
        btn.id = 'al-float-btn';
        btn.style.position = 'fixed';
        btn.style.top = '20px';
        btn.style.right = '20px';
        btn.style.background = '#2196F3';
        btn.style.color = 'white';
        btn.style.padding = '10px 15px';
        btn.style.borderRadius = '50px';
        btn.style.cursor = 'pointer';
        btn.style.zIndex = '10003'; // 楂樹簬鐘舵€佹爮
        btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        btn.style.transition = 'background 0.2s';
        btn.innerText = 'AL Menu';
        document.body.appendChild(btn);

        btn.addEventListener('click', function() {
            let menu = document.getElementById('al-menu');
            menu.style.display = 'block';
            this.style.display = 'none';
        });
    }

    // 鍔犺浇璐﹀彿閰嶇疆
    function loadAccountConfig(acc) {
        let config = accounts[acc];
        if (config) {
            duration = config.duration;
            refreshDelay = config.refreshDelay;
            likeDelay = config.likeDelay;
            scrollCount = config.scrollCount;
            blocked = config.blocked;
            whiteList = config.whiteList;
            blockGroups = config.blockGroups;
            filterKeywords = config.filterKeywords;
            filterMode = config.filterMode;
            dailyLimit = config.dailyLimit;
            select = config.select;
            theme = config.theme;
            themeHue = config.themeHue;
            statusOpacity = config.statusOpacity;
            statusBgColor = config.statusBgColor;
            statusTextColor = config.statusTextColor;
            statusTextBrightness = config.statusTextBrightness;
            darkModeAuto = config.darkModeAuto;
            menuOpacity = config.menuOpacity;
            menuBgColor = config.menuBgColor;
            maxRetries = config.maxRetries;
            scrollStepPercent = config.scrollStepPercent;
            initialDelay = config.initialDelay;
            randomDelayMin = config.randomDelayMin;
            randomDelayMax = config.randomDelayMax;
            logLevel = config.logLevel;
            enableNotifications = config.enableNotifications;
            enableLoginCheck = config.enableLoginCheck;
            enableAutoRelogin = config.enableAutoRelogin; // 鏂板
            stats[acc] = config.stats || { likes: 0, skips: 0, errors: 0 };
            logs[acc] = config.logs || []; // 娉ㄦ剰锛歭ogs鐜板湪浠巐ocalStorage鍔犺浇锛屼絾鍙互鍚堝苟濡傛灉config鏈?
            currentAccount = acc;
            updateStatusBar();
        } else {
            // 榛樿閰嶇疆
            accounts[acc] = { duration: 180, refreshDelay: 10, likeDelay: 5, scrollCount: 3, blocked: [], whiteList: [], blockGroups: {}, filterKeywords: [], filterMode: 'block', dailyLimit: 0, select: false, theme: 'default', themeHue: 0, darkModeAuto: true, statusOpacity: 0.8, statusBgColor: 'linear-gradient(to right, #333, #222)', statusTextColor: '#ddd', statusTextBrightness: 1.0, menuOpacity: 0.9, menuBgColor: 'linear-gradient(to bottom, #ffffff, #f0f0f0)', maxRetries: 3, scrollStepPercent: 0.9, initialDelay: 3000, randomDelayMin: 1, randomDelayMax: 3, logLevel: 'INFO', enableNotifications: false, enableLoginCheck: true, enableAutoRelogin: false, stats: { likes: 0, skips: 0, errors: 0 }, logs: [] };
            currentAccount = acc;
        }
    }

    function saveAccountConfig() {
        accounts[currentAccount] = {
            duration: duration, refreshDelay: refreshDelay, likeDelay: likeDelay, scrollCount: scrollCount, blocked: blocked, whiteList: whiteList, blockGroups: blockGroups, filterKeywords: filterKeywords, filterMode: filterMode, dailyLimit: dailyLimit, select: select, theme: theme, themeHue: themeHue, statusOpacity: statusOpacity, statusBgColor: statusBgColor, statusTextColor: statusTextColor, statusTextBrightness: statusTextBrightness, darkModeAuto: darkModeAuto, menuOpacity: menuOpacity, menuBgColor: menuBgColor, maxRetries: maxRetries, scrollStepPercent: scrollStepPercent, initialDelay: initialDelay, randomDelayMin: randomDelayMin, randomDelayMax: randomDelayMax, logLevel: logLevel, enableNotifications: enableNotifications, enableLoginCheck: enableLoginCheck, enableAutoRelogin: enableAutoRelogin, stats: stats[currentAccount], logs: logs[currentAccount]
        };
        setCookie('al-accounts', JSON.stringify(accounts), Number.MAX_SAFE_INTEGER);
    }

    // 鑷姩鏆楅粦妯″紡锛堝寮哄吋瀹规€э級
    function applyDarkMode() {
        if (!darkModeAuto) return;
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            statusBgColor = 'linear-gradient(to right, #333, #222)';
            statusTextColor = '#ddd';
            menuBgColor = 'linear-gradient(to bottom, #333, #222)';
        } else {
            statusBgColor = 'linear-gradient(to right, #f0f0f0, #e0e0e0)';
            statusTextColor = '#333';
            menuBgColor = 'linear-gradient(to bottom, #ffffff, #f0f0f0)';
        }
        let statusBar = document.getElementById('al-status-bar');
        if (statusBar) {
            statusBar.style.background = statusBgColor;
            statusBar.style.color = statusTextColor;
        }
        let menuElem = document.getElementById('al-menu');
        if (menuElem) {
            menuElem.style.background = menuBgColor;
        }
        // 搴旂敤鍒板叾浠栧厓绱犲鏋滈渶瑕?
    }

    // 鍒涘缓鐘舵€佹爮锛堟敼杩涳細缃戞牸甯冨眬銆佽繘搴︽潯銆佷氦浜掞級
    function createStatusBar() {
        let statusBar = document.createElement('div');
        statusBar.id = 'al-status-bar';
        statusBar.style.position = 'fixed';
        statusBar.style.top = '0';
        statusBar.style.left = '0';
        statusBar.style.width = '100%';
        statusBar.style.background = statusBgColor;
        statusBar.style.padding = '12px 24px';
        statusBar.style.zIndex = '10001';
        statusBar.style.fontSize = '15px';
        statusBar.style.lineHeight = '1.6';
        statusBar.style.textAlign = 'center';
        statusBar.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
        statusBar.style.borderRadius = '0 0 10px 10px';
        statusBar.style.fontFamily = 'Arial, sans-serif';
        statusBar.style.color = statusTextColor;
        statusBar.style.opacity = statusOpacity;
        statusBar.style.filter = 'brightness(' + statusTextBrightness + ') hue-rotate(' + themeHue + 'deg)';
        statusBar.style.pointerEvents = 'auto'; // 鍏佽浜や簰
        statusBar.style.cursor = 'pointer';
        statusBar.style.display = 'grid';
        statusBar.style.gridTemplateColumns = '1fr 2fr 1fr';
        statusBar.style.transition = 'opacity 0.3s ease, background 0.3s ease';
        document.body.appendChild(statusBar);

        statusBar.addEventListener('click', function() {
            this.style.height = this.style.height === 'auto' ? '' : 'auto'; // 灞曞紑/鎶樺彔
        });

        setInterval(updateStatusBar, 1000);
        updateStatusBar();

        log('INFO', '鐘舵€佹爮鍔犺浇瀹屾垚');
    }

    // 鏇存柊鐘舵€佹爮锛堟敼杩涳細杩涘害鏉°€佷粖鏃ョ偣璧烇級
    function updateStatusBar(message) {
        resetDailyCount();
        duration = parseInt(getCookie('al-duration')) || duration;
        refreshDelay = parseInt(getCookie('al-refreshDelay')) || refreshDelay;
        likeDelay = parseInt(getCookie('al-likeDelay')) || likeDelay;
        scrollCount = parseInt(getCookie('al-scrollCount')) || scrollCount;

        let statusBar = document.getElementById('al-status-bar');
        if (!statusBar) return;

        message = message || '';

        if (message) {
            log('INFO', '鐘舵€佹爮鏇存柊: ' + message);
        }

        let lastRefreshTime = new Date(lastRefresh).toLocaleTimeString();
        let remainingSeconds = Math.max(0, Math.ceil((nextTime - Date.now()) / 1000));
        let remainingColor = remainingSeconds < 30 ? 'red' : 'green';
        let scrollingStatus = isScrolling ? '<span style="color: lightblue; font-weight: bold;">婊氬姩涓?馃攧</span>' : '<span style="color: gray;">闈欐 鈴癸笍</span>';
        let currentStep = message || (isPaused ? '<span style="color: yellow; font-weight: bold;">宸叉殏鍋?鈴革笍</span>' : (isRunning ? '<span style="color: orange; font-weight: bold;">鎵ц涓細' + currentTask + ' 馃殌</span>' : '<span style="color: lightgreen; font-weight: bold;">绛夊緟涓嬫鍒锋柊 鈴?/span>'));
        let taskRemaining = taskDuration > 0 ? Math.max(0, Math.ceil((taskStartTime + taskDuration * 1000 - Date.now()) / 1000)) : 0;
        let taskProgressPercent = taskDuration > 0 ? Math.round((1 - (taskRemaining / taskDuration)) * 100) : 0;
        let progressBar = '<div style="background: #ddd; height: 5px; width: 100%;"><div style="background: #4CAF50; height: 5px; width: ' + taskProgressPercent + '%;"></div></div>';
        let taskProgress = taskRemaining > 0 ? '<span style="color: violet;">浠诲姟杩涘害: ' + taskProgressPercent + '% 馃搳</span>' : '';
        let retryInfo = retryCount > 0 ? '<span style="color: brown;">閲嶈瘯: ' + retryCount + '/' + maxRetries + ' 鈿狅笍</span>' : '';
        let dailyInfo = dailyLimit > 0 ? '<span style="color: purple;">浠婃棩鐐硅禐: ' + dailyCount + '/' + dailyLimit + ' 鉂わ笍</span>' : '';

        let strongColor = statusTextColor === '#ddd' || statusTextColor === '#fff' ? '#ccc' : '#555';

        let infoParts = [taskProgress, retryInfo, dailyInfo].filter(Boolean);
        let infoSection = infoParts.length > 0 ? infoParts.join(' | ') + ' | ' : '';

        let html = progressBar + '<div style="grid-column: 1;">涓婃: <strong style="color: ' + strongColor + ';">' + lastRefreshTime + ' 鈴憋笍</strong> | 鍓╀綑: <span style="color: ' + remainingColor + ';">' + remainingSeconds + 's</span></div><div style="grid-column: 2;">' + currentStep + ' | ' + scrollingStatus + '</div><div style="grid-column: 3;">闂撮殧: <strong>' + duration + 's</strong> | 寤惰繜: <strong>' + likeDelay + 's</strong></div><div style="grid-column: 1 / 4; font-size: 14px;">' + infoSection + '鐘舵€? <span style="color: ' + (isPaused ? 'yellow' : (isRunning ? 'orange' : 'lightgreen')) + ';">' + (isPaused ? '鏆傚仠' : (isRunning ? '蹇欑' : '绌洪棽')) + '</span></div>';
        statusBar.innerHTML = html;
    }

    // 绉婚櫎鑿滃崟鍏冪礌
    function removeMeRelatedMenu() {
        let meTab = document.getElementById('tab_menu_me') || document.querySelector('li[type="me"]') || document.querySelector('#feed_tab_my');
        if (meTab) {
            meTab.style.display = 'none';
        }
    }

    // 妫€娴嬮〉闈?
    function isInFriendFeedPage() {
        const hasLikeButtons = document.querySelectorAll('.qz_like_btn_v3').length > 0;
        return hasLikeButtons;
    }

    // 杩涘叆濂藉弸鍔ㄦ€?
    function goToFriendFeed() {
        try {
            log('INFO', '杩涘叆濂藉弸鍔ㄦ€侀〉闈?);
            currentTask = '鍒囨崲鍒板ソ鍙嬪姩鎬侀〉闈?;
            taskStartTime = Date.now();
            taskDuration = 5;
            nextTask = '鍒锋柊椤甸潰骞堕噸璇曟祦绋?;
            updateStatusBar('鍒囨崲鍒板ソ鍙嬪姩鎬?..');
            let friendTab = document.getElementById('tab_menu_friend') || document.querySelector('li[type="friend"] a') || document.querySelector('.feed-control-tab a:not(.item-on)');
            if (friendTab) {
                friendTab.click();
            } else if (uin) {
                location.href = 'https://user.qzone.qq.com/' + uin + '/infocenter';
            } else {
                refresh();
            }
        } catch (e) {
            log('ERROR', '杩涘叆濂藉弸鍔ㄦ€佸紓甯? ' + e.message);
            updateStats('errors');
        }
    }

    // 瀹夊叏鐐硅禐锛堟墿灞曪細鍏抽敭璇嶈繃婊ゃ€佺櫧鍚嶅崟銆佹瘡鏃ヤ笂闄愩€侀殢鏈哄欢杩燂紱淇锛氫娇鐢╥nnerText鎻愬彇鍐呭锛岄伩鍏岺TML骞叉壈锛涚偣璧炲悗娣诲姞寤惰繜妫€鏌lass鏇存柊锛岄槻姝㈤噸澶嶇偣鍑伙紱浼樺寲锛氭坊鍔犻槻閲嶅瑙﹀彂锛?
    let likeDebounce = null;
    let lastLikeTime = 0;
    function safeLike() {
        try {
            const now = Date.now();
            if (isPaused || (now - lastLikeTime < 1000)) { // 闃查噸澶嶈Е鍙戯紝1绉掑喎鍗?
                log('INFO', 'safeLike 鍐峰嵈涓紝璺宠繃');
                return;
            }
            lastLikeTime = now;
            if (currentTask === '鎵ц瀹夊叏鐐硅禐') return;
            if (likeDebounce) clearTimeout(likeDebounce);
            likeDebounce = setTimeout(function() {
                if (!checkLoginStatus()) return; // 鏂板锛氱櫥褰曟鏌?
                currentTask = '鎵ц瀹夊叏鐐硅禐';
                taskStartTime = Date.now();
                const btns = document.querySelectorAll('.qz_like_btn_v3');
                const contents = document.querySelectorAll('.f-info');
                const users = document.querySelectorAll('.f-name');
                let toLike = [];
                let skipped = 0;

                Array.from(btns).forEach(function(btn, index) {
                    const contentElem = contents[index];
                    const content = contentElem ? contentElem.innerText : ''; // 鏀逛负innerText锛岄伩鍏岺TML鏍囩骞叉壈鍏抽敭璇嶅尮閰?
                    const user = users[index] && users[index].getAttribute('link') ? users[index].getAttribute('link').replace('nameCard_', '') : '';

                    if (btn.classList.contains('item-on')) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', '璺宠繃宸茶禐鍔ㄦ€?' + (index + 1));
                        return;
                    }

                    // 鐧藉悕鍗曚紭鍏?
                    if (whiteList.includes(user)) {
                        toLike.push({btn: btn, content: content, index: index});
                        return;
                    }

                    // 榛戝悕鍗曟鏌ワ紙鍖呮嫭鍒嗙粍锛?
                    let isBlocked = blocked.includes(user);
                    Object.values(blockGroups).forEach(function(group) {
                        if (group.includes(user)) isBlocked = true;
                    });
                    if (isBlocked) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', '璺宠繃灞忚斀鐢ㄦ埛鍔ㄦ€?' + (index + 1) + ', 鐢ㄦ埛: ' + user);
                        return;
                    }

                    // 娓告垙杞彂
                    let isGameForward = false;
                    if (select) {
                        for (let j = 0; j < dict.length; j++) {
                            if (content.includes(dict[j])) {
                                isGameForward = true;
                                break;
                            }
                        }
                    }
                    if (isGameForward) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', '璺宠繃娓告垙杞彂鍔ㄦ€?' + (index + 1));
                        return;
                    }

                    // 鍏抽敭璇嶈繃婊わ紙鍔犲己鏃ュ織锛?
                    let matchesKeyword = false;
                    filterKeywords.forEach(function(kw) {
                        try {
                            let regex = new RegExp(kw, 'i');
                            if (regex.test(content)) {
                                matchesKeyword = true;
                                log('INFO', '鍏抽敭璇嶅尮閰? ' + kw + ' 鍦ㄥ姩鎬?' + (index + 1) + ' 涓壘鍒?);
                            }
                        } catch (e) {
                            if (content.includes(kw)) {
                                matchesKeyword = true;
                                log('INFO', '鍏抽敭璇嶅寘鍚? ' + kw + ' 鍦ㄥ姩鎬?' + (index + 1) + ' 涓壘鍒?);
                            }
                        }
                    });
                    if ((filterMode === 'block' && matchesKeyword) || (filterMode === 'allow' && !matchesKeyword)) {
                        skipped++;
                        updateStats('skips');
                        log('INFO', '璺宠繃鍏抽敭璇嶈繃婊ゅ姩鎬?' + (index + 1));
                        return;
                    }

                    // 姣忔棩涓婇檺
                    if (dailyLimit > 0 && dailyCount >= dailyLimit) {
                        updateStatusBar('杈惧埌姣忔棩涓婇檺锛屽仠姝㈢偣璧?);
                        sendNotification('姣忔棩涓婇檺', '宸茶揪鍒扮偣璧炰笂闄? ' + dailyLimit);
                        return;
                    }

                    toLike.push({btn: btn, content: content, index: index});
                });

                let effectiveLikes = toLike.length;
                taskDuration = effectiveLikes * (likeDelay + (randomDelayMax - randomDelayMin) / 2) + 1;
                nextTask = '妯℃嫙婊氬姩鎴栫瓑寰呭埛鏂?;
                nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
                updateStatusBar('寮€濮嬬偣璧?(闇€璧? ' + effectiveLikes + ', 璺宠繃: ' + skipped + ')');
                log('INFO', '寮€濮嬬偣璧?(闇€璧? ' + effectiveLikes + ', 璺宠繃: ' + skipped + ')');

                if (effectiveLikes === 0) {
                    currentTask = '';
                    taskDuration = 0;
                    updateStatusBar('鎵€鏈夊姩鎬佽烦杩囷紝绛夊緟鍒锋柊');
                    return;
                }

                let cumulativeDelay = 0;
                toLike.forEach(function(item, idx) {
                    let delay = likeDelay * 1000 + Math.random() * (randomDelayMax - randomDelayMin) * 1000;
                    cumulativeDelay += delay;
                    setTimeout(function() {
                        if (isPaused || (dailyLimit > 0 && dailyCount >= dailyLimit)) return;

                        // 鍙岄噸妫€鏌ュ凡璧烇紙闃叉寤惰繜鏇存柊锛?
                        if (item.btn.classList.contains('item-on')) {
                            log('WARN', '鍔ㄦ€?' + (item.index + 1) + ' 宸茶禐锛岃烦杩囩偣鍑?);
                            return;
                        }

                        item.btn.click();
                        dailyCount++;
                        setCookie('al-dailyCount', dailyCount, Number.MAX_SAFE_INTEGER);
                        updateStats('likes');
                        console.log('Liked: ' + item.content);
                        updateStatusBar('鐐硅禐鍔ㄦ€?' + (item.index + 1) + ' / ' + btns.length);
                        log('INFO', '鐐硅禐鍔ㄦ€?' + (item.index + 1));

                        // 鐐硅禐鍚庣瓑寰卌lass鏇存柊
                        setTimeout(function() {
                            if (item.btn.classList.contains('item-on')) {
                                log('INFO', '鍔ㄦ€?' + (item.index + 1) + ' class鏇存柊涓哄凡璧?);
                            } else {
                                log('WARN', '鍔ㄦ€?' + (item.index + 1) + ' class鏈強鏃舵洿鏂?);
                            }
                        }, 500);
                    }, cumulativeDelay - delay); // 绱鍓嶉潰鐨勫欢杩?
                });

                setTimeout(function() {
                    if (isPaused) return;
                    currentTask = '';
                    taskDuration = 0;
                    updateStatusBar('鐐硅禐瀹屾垚锛岀瓑寰呭埛鏂?);
                    log('INFO', '鐐硅禐瀹屾垚');
                    sendNotification('鐐硅禐瀹屾垚', '鏈鐐硅禐: ' + effectiveLikes);
                }, cumulativeDelay + 1000); // 鎬诲欢杩熷悗鍔犵紦鍐?
            }, 500);
        } catch (e) {
            log('ERROR', '瀹夊叏鐐硅禐寮傚父: ' + e.message);
            updateStats('errors');
        }
    }

    // 妯℃嫙婊氬姩锛堜紭鍖栵細鏀寔鏃犻檺婊氬姩锛屽姩鎬佹娴嬪簳閮級
    function simulateScroll() {
        try {
            if (isPaused) {
                updateStatusBar('鑴氭湰宸叉殏鍋滐紝璺宠繃婊氬姩');
                return;
            }
            currentTask = '妯℃嫙涓嬫粦鍔ㄦ€?;
            taskStartTime = Date.now();
            taskDuration = scrollCount * 3 + 3;
            nextTask = '鍥炲埌椤堕儴骞剁瓑寰?;
            nextTime = Math.max(nextTime, Date.now() + taskDuration * 1000 + 5000);
            updateStatusBar('妯℃嫙涓嬫粦...');
            log('INFO', '妯℃嫙婊氬姩寮€濮?);
            let scrollStep = window.innerHeight * scrollStepPercent;
            let scrolled = 0;
            let maxScrolls = scrollCount;

            function scrollLoop(i) {
                if (isPaused || i >= maxScrolls) {
                    smoothScrollTo(0, 1000);
                    updateStatusBar('鍥炲埌椤堕儴锛岀瓑寰呭埛鏂?);
                    currentTask = '';
                    taskDuration = 0;
                    log('INFO', '婊氬姩缁撴潫');
                    return;
                }
                smoothScrollTo((i + 1) * scrollStep, 500);
                window.dispatchEvent(new Event('scroll'));
                updateStatusBar('婊氬姩鍒扮粍 ' + (i + 1) + '/' + maxScrolls);
                log('INFO', '婊氬姩鍒扮粍 ' + (i + 1));
                let loadMoreBtn = document.querySelector('.load-more') || document.querySelector('a[title="鍔犺浇鏇村"]');
                if (loadMoreBtn) {
                    loadMoreBtn.click();
                    maxScrolls++; // 鍔ㄦ€佸鍔犲鏋滄湁鏇村
                }
                // 妫€鏌ユ槸鍚﹀埌杈惧簳閮?
                if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 100) {
                    maxScrolls = i + 1; // 鍋滄濡傛灉鍒拌揪搴曢儴
                }
                setTimeout(function() { scrollLoop(i + 1); }, 3000);
            }

            scrollLoop(0);
        } catch (e) {
            log('ERROR', '婊氬姩寮傚父: ' + e.message);
            updateStats('errors');
        }
    }

    // 骞虫粦婊氬姩
    function smoothScrollTo(targetY, duration) {
        let startY = window.scrollY;
        let distance = targetY - startY;
        let startTime = null;

        function animation(currentTime) {
            if (isPaused) return;
            if (!startTime) startTime = currentTime;
            let timeElapsed = currentTime - startTime;
            let progress = Math.min(timeElapsed / duration, 1);
            let ease = progress * (2 - progress);
            window.scrollTo(0, startY + distance * ease);
            if (timeElapsed < duration) {
                requestAnimationFrame(animation);
            } else {
                window.dispatchEvent(new Event('scroll'));
            }
        }

        requestAnimationFrame(animation);
    }

    // 鍒锋柊
    function refresh() {
        try {
            if (isPaused) return;
            log('INFO', '鍒锋柊瑙﹀彂');
            currentTask = '鍒锋柊椤甸潰';
            taskStartTime = Date.now();
            taskDuration = refreshDelay;
            nextTask = '鎵ц宸ヤ綔娴?;
            lastRefresh = Date.now();
            setCookie('al-lastRefresh', lastRefresh, Number.MAX_SAFE_INTEGER);
            nextTime = Date.now() + duration * 1000;
            setCookie('al-justRefreshed', 'true', 60);
            location.reload();
        } catch (e) {
            log('ERROR', '鍒锋柊寮傚父: ' + e.message);
            updateStats('errors');
        }
    }

    // 鎵ц宸ヤ綔娴?
    function executeWorkflow() {
        if (isPaused) return;
        if (isRunning && !testMode) return;
        if (!checkLoginStatus()) return; // 鏂板锛氱櫥褰曟鏌?
        isRunning = true;
        currentTask = '鎵ц宸ヤ綔娴?;
        taskStartTime = Date.now();
        taskDuration = 10;
        nextTask = '鐐硅禐鎴栧垏鎹?;
        updateStatusBar('寮€濮嬪伐浣滄祦');
        log('INFO', '寮€濮嬪伐浣滄祦');

        setTimeout(function() {
            try {
                if (isPaused) {
                    isRunning = false;
                    return;
                }
                if (isInFriendFeedPage()) {
                    updateStatusBar('鐩存帴鎵ц鐐硅禐');
                    log('INFO', '鐩存帴鐐硅禐');
                    safeLike();
                    simulateScroll();
                } else {
                    updateStatusBar('鍒囨崲骞跺埛鏂?);
                    retryCount++;
                    log('WARN', '閲嶈瘯: ' + retryCount);
                    if (retryCount > maxRetries) {
                        updateStatusBar('閲嶈瘯瓒呴檺');
                        log('ERROR', '閲嶈瘯瓒呴檺');
                        isRunning = false;
                        retryCount = 0;
                        updateStats('errors');
                        return;
                    }
                    goToFriendFeed();
                    refresh();
                    setTimeout(executeWorkflow, refreshDelay * 1000);
                }
                isRunning = false;
                currentTask = '';
                taskDuration = 0;
            } catch (e) {
                log('ERROR', '宸ヤ綔娴佸紓甯? ' + e.message);
                isRunning = false;
                updateStats('errors');
            }
        }, initialDelay);
    }

    // 婊氬姩浜嬩欢
    let scrollDebounce = null;
    window.addEventListener('scroll', function() {
        if (isPaused) return;
        if (timeout) clearTimeout(timeout);
        isScrolling = true;
        updateStatusBar();
        if (scrollDebounce) clearTimeout(scrollDebounce);
        scrollDebounce = setTimeout(safeLike, 1000);
        timeout = setTimeout(function() {
            isScrolling = false;
            updateStatusBar();
        }, 1000);
    });

    // 涓诲惊鐜紙鏂板锛氬畾鏈熺櫥褰曟鏌ワ級
    let mainInterval = setInterval(function() {
        try {
            if (isPaused) {
                updateStatusBar('鏆傚仠涓?);
                return;
            }
            let time = Date.now();
            if (time >= nextTime || testMode) {
                refresh();
            } else if (isScrolling) {
                safeLike();
            }
            // 姣忓垎閽熸鏌ヤ竴娆＄櫥褰?
            if (time % 60000 < 1000) {
                checkLoginStatus();
            }
        } catch (e) {
            log('ERROR', '涓诲惊鐜紓甯? ' + e.message);
            updateStats('errors');
        }
    }, 1000);

    // 娓呯悊瀹氭椂鍣?
    function clearAllTimeouts() {
        clearTimeout(timeout);
        clearTimeout(likeDebounce);
        clearTimeout(scrollDebounce);
        clearInterval(mainInterval);
        mainInterval = null;
    }

    // 鍒濆鍖?
    window.onload = function () {
        try {
            createMenu();
            createStatusBar();
            createFloatButton();
            applyDarkMode();

            removeMeRelatedMenu();

            if (getCookie('al-justRefreshed')) {
                setCookie('al-justRefreshed', '', -1);
                setTimeout(executeWorkflow, 3000);
            }

            // 鍔犺浇褰撳墠璐﹀彿閰嶇疆
            loadAccountConfig(currentAccount);

            // 鏂板锛氬惎鍔∕utationObserver
            setupMutationObserver();

            log('INFO', '鑴氭湰鍒濆鍖栧畬鎴?);
        } catch (e) {
            log('ERROR', '鍒濆鍖栧紓甯? ' + e.message);
            updateStats('errors');
        }
    };

    console.log('Auto Like Enhanced v2.8.9 Running...');
})();

